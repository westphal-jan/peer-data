{"id": "1701.07149", "review": {"conference": "arxiv", "VERSION": "v1", "DATE_OF_SUBMISSION": "25-Jan-2017", "title": "Hierarchical Recurrent Attention Network for Response Generation", "abstract": "theoretically we study multi - turn response alert generation in chatbots where interpreting a temporal response is generated incorrectly according to framing a conversation context. existing work writing has aggressively modeled removing the hierarchy challenges of forming the context, dramatically but does not pay for enough scientific attention both to the recent fact evident that discrete words and utterances in supporting the context environments are differentially important. as a result, they'may progressively lose potentially important information transmission in context and directly generate irrelevant responses. we today propose a generic hierarchical recurrent static attention capability network ( hran ) specification to model both aspects in a unified framework. in hran, executing a hierarchical attention mechanism attends attempt to distinguish important parts arising within language and transactions among utterances comply with word level attention attention status and utterance level expressive attention hierarchy respectively. with the word level attention, hidden vectors of a basic word level encoder implementation are swiftly synthesized as corresponding utterance vectors and electronically fed to an invisible utterance level encoder utilized to formally construct hidden impulse representations of the context. the hidden vectors of the context are then processed by transmitting the utterance level attention and sequences formed as context vectors for decoding the response. empirical software studies performed on incorporating both automatic evaluation and improved human judgment show results that weak hran can clearly significantly outperform state - effectiveness of - invention the - net art models for multi - verb turn response awareness generation.", "histories": [["v1", "Wed, 25 Jan 2017 03:04:31 GMT  (1052kb,D)", "http://arxiv.org/abs/1701.07149v1", null]], "reviews": [], "SUBJECTS": "cs.CL", "authors": ["chen xing", "wei wu", "yu wu", "ming zhou", "yalou huang", "wei-ying ma"], "accepted": false, "id": "1701.07149"}, "pdf": {"name": "1701.07149.pdf", "metadata": {"source": "CRF", "title": "Hierarchical Recurrent Attention Network for Response Generation", "authors": ["Chen Xing", "Wei Wu", "Yu Wu", "Ming Zhou", "Yalou Huang", "Wei-Ying Ma"], "emails": ["v-chxing@microsoft.com", "wuwei@microsoft.com", "v-wuyu@microsoft.com", "mingzhou@microsoft.com", "wyma@microsoft.com", "ylhuang@nankai.edu.cn"], "sections": [{"heading": "1 Introduction", "text": "Conversational agents include task-oriented dialog systems which are built in vertical domains for specific tasks (Young et al., 2013; Boden, 2006; Wallace, 2009; Young et al., 2010), and non-task-oriented chatbots which aim to realize natural and human-like conversations with people\n\u2217The work was done when the first author was an intern in Microsoft Research Asia.\nregarding to a wide range of issues in open domains (Jafarpour et al., 2010). A common practice to build a chatbot is to learn a response generation model within an encoder-decoder framework from large scale message-response pairs (Shang et al., 2015; Vinyals and Le, 2015). Such models ignore conversation history when responding, which is contradictory to the nature of real conversation between humans. To resolve the problem, researchers have taken conversation history into consideration and proposed response generation for multi-turn conversation (Sordoni et al., 2015; Serban et al., 2015; Serban et al., 2016b; Serban et al., 2016c).\nIn this work, we study multi-turn response generation for open domain conversation in chatbots in which we try to learn a response generation model from responses and their contexts. A context refers to a message and several utterances in its previous turns. In practice, when a message comes, the model takes the context as input and generate a response as the next turn. Multi-turn conversation requires a model to generate a response relevant to the whole context. The complexity of the task lies in two aspects: 1) a conversation context is in a hierarchical structure (words form an utterance, and utterances form the context) and has two levels of sequential relationships among both words and utterances within the strucar X\niv :1\n70 1.\n07 14\n9v 1\n[ cs\n.C L\n] 2\n5 Ja\nn 20\n17\nture; 2) not all parts of the context are equally important to response generation. Words are differentially informative and important, and so are the utterances. State-of-the-art methods such as HRED (Serban et al., 2016a) and VHRED (Serban et al., 2016c) focus on modeling the hierarchy of the context, whereas there is little exploration on how to select important parts from the context, although it is often a crucial step for generating a proper response. Without this step, existing models may lose important information in context and generate irrelevant responses1. Figure 1 gives an example from our data to illustrate the problem. The context is a conversation between two speakers about height and boyfriend, therefore, to respond to the context, words like \u201cgirl\u201d, \u201cboyfriend\u201d and numbers indicating height such as \u201c160\u201d and \u201c175\u201d are more important than \u201cnot good-looking\u201d. Moreover, u1 and u4 convey main semantics of the context, and therefore are more important than the others for generating a proper response. Without modeling the word and utterance importance, the state-of-the-art model VHRED (Serban et al., 2016c) misses important points and gives a response \u201care you a man or a woman\u201d which is OK if there were only u3 left, but nonsense given the whole context. After paying attention to the important words and utterances, we can have a reasonable response like \u201cNo, I don\u2019t care much about height\u201d (the response is generated by our model, as will be seen in experiments).\nWe aim to model the hierarchy and the important parts of contexts in a unified framework. Inspired by the success of the attention mechanism in single-turn response generation (Shang et al., 2015), we propose a hierarchical recurrent attention network (HRAN) for multi-turn response generation in which we introduce a hierarchical attention mechanism to dynamically highlight important parts of word sequences and the utterance sequence when generating a response. Specifically, HRAN is built in a hierarchical structure. At the bottom of HRAN, a word level recurrent neural network (RNN) encodes each utterance into a sequence of hidden vectors. In generation of each word in the response, a word level attention mech-\n1Note that one can simply concatenate all utterances and employs the classic sequence-to-sequence with attention to model word importance in generation. This method, however, loses utterance relationships and results in bad generation quality, as will be seen in expeirments.\nanism assigns a weight to each vector in the hidden sequence of an utterance and forms an utterance vector by a linear combination of the vectors. Important hidden vectors correspond to important parts in the utterance regarding to the generation of the word, and contribute more to the formation of the utterance vector. The utterance vectors are then fed to an utterance level RNN which constructs hidden representations of the context. Different from classic attention mechanism, the word level attention mechanism in HRAN is dependent on both the decoder and the utterance level RNN. Thus, both the current generated part of the response and the content of context can help select important parts in utterances. At the third layer, an utterance attention mechanism attends to important utterances in the utterance sequence and summarizes the sequence as a context vector. Finally, at the top of HRAN, a decoder takes the context vector as input and generates the word in the response. HRAN mirrors the data structure in multiturn response generation by growing from words to utterances and then from utterances to the output. It extends the architecture of current hierarchical response generation models by a hierarchical attention mechanism which not only results in better generation quality, but also provides insight into which parts in an utterance and which utterances in context contribute to response generation.\nWe conduct an empirical study on large scale open domain conversation data and compare our model with state-of-the-art models using both automatic evaluation and side-by-side human comparison. The results show that on both metrics our model can significantly outperform existing models for multi-turn response generation. We release our source code and data at https://github.com/LynetteXing1991/HRAN.\nThe contributions of the paper include (1) proposal of attending to important parts in contexts in multi-turn response generation; (2) proposal of a hierarchical recurrent attention network which models hierarchy of contexts, word importance, and utterance importance in a unified framework; (3) empirical verification of the effectiveness of the model by both automatic evaluation and human judgment."}, {"heading": "2 Related Work", "text": "Most existing effort on response generation is paid to single-turn conversation. Starting from the ba-\nsic sequence to sequence model (Sutskever et al., 2014), various models (Shang et al., 2015; Vinyals and Le, 2015; Li et al., 2015; Xing et al., 2016; Li et al., 2016; ?) have been proposed under an encoder-decoder framework to improve generation quality from different perspectives such as relevance, diversity, and personality. Recently, multiturn response generation has drawn attention from academia. For example, Sordoni et al. (2015) proposed DCGM where context information is encoded with a multi-layer perceptron (MLP). Serban et al. (2016a) proposed HRED which models contexts in a hierarchical encoder-decoder framework. Under the architecture of HRED, more variants including VHRED (Serban et al., 2016c) and MrRNN (Serban et al., 2016b) are proposed in order to introduce latent and explicit variables into the generation process. In this work, we also study multi-turn response generation. Different from the existing models which do not model word and utterance importance in generation, our hierarchical recurrent attention network simultaneously models the hierarchy of contexts and the importance of words and utterances in a unified framework.\nAttention mechanism is first proposed for machine translation (Bahdanau et al., 2014; Cho et al., 2015), and is quickly applied to single-turn response generation afterwards (Shang et al., 2015; Vinyals and Le, 2015). Recently, Yang et al. (2016) proposed a hierarchical attention network for document classification in which two levels of attention mechanisms are used to model the contributions of words and sentences in classification decision. Seo et al. (2016) proposed a hierarchical attention network to precisely attending objects of different scales and shapes in images. Inspired by these work, we extend the attention mechanism for single-turn response generation to a hierarchical attention mechanism for multi-turn response generation. To the best of our knowledge, we are the first who apply the hierarchical attention technique to response generation in chatbots."}, {"heading": "3 Problem Formalization", "text": "Suppose that we have a data set D = {(Ui,Yi)}Ni=1. \u2200i, (Ui,Yi) consists of a response Yi = (yi,1, . . . , yi,Ti) and its context Ui = (ui,1, . . . , ui,mi) with yi,j the j-th word, ui,mi the message, and (ui,1, . . . , ui,mi\u22121) the utterances in previous turns. In this work, we require mi > 2 and thus each context has at\nleast one utterance as conversation history. \u2200j, ui,j = ( wi,j,1, . . . , wi,j,Ti,j ) where wi,j,k is the kth word. We aim to estimate a generation probability p(y1, . . . , yT |U) from D , and thus given a new conversation context U, we can generate a response Y = (y1, . . . , yT ) according to p(y1, . . . , yT |U).\nIn the following, we will elaborate how to construct p(y1, . . . , yT |U) and how to learn it."}, {"heading": "4 Hierarchical Recurrent Attention Network", "text": "We propose a hierarchical recurrent attention network (HRAN) to model the generation probability p(y1, . . . , yT |U). Figure 2 gives the architecture of HRAN. Roughly speaking, before generation, HRAN employs a word level encoder to encode information of every utterance in context as hidden vectors. Then, when generating every word, a hierarchical attention mechanism attends to important parts within and among utterances with word level attention and utterance level attention respectively. With the two levels of attention, HRAN works in a bottom-up way: hidden vectors of utterances are processed by the word level attention and uploaded to an utterance level encoder to form hidden vectors of the context. Hidden vectors of the context are further processed by the utterance level attention as a context vector and uploaded to the decoder to generate the word.\nIn the following, we will describe details and the learning objective of HRAN."}, {"heading": "4.1 Word Level Encoder", "text": "Given U = (u1, . . . , um), we employ a bidirectional recurrent neural network with gated recurrent units (BiGRU) (Bahdanau et al., 2014) to encode each ui, i \u2208 {1, . . . ,m} as hidden vectors (hi,1, . . . ,hi,Ti). Formally, suppose that ui = (wi,1, . . . , wi,Ti), then \u2200k \u2208 {1, . . . , Ti}, hi,k is given by\nhi,k = concat( \u2212\u2192 h i,k, \u2190\u2212 h i,k), (1)\nwhere concat(\u00b7, \u00b7) is an operation defined as concatenating the two arguments together, \u2212\u2192 h i,k is the k-th hidden state of a forward GRU (Cho et al., 2014), and \u2190\u2212 h i,k is the k-th hidden state of a backward GRU. The forward GRU reads ui in its order\n(i.e., from wi,1 to wi,Ti), and calculates \u2212\u2192 h i,k as\nzk = \u03c3(Wzei,k + Vz \u2212\u2192 h i,k\u22121) rk = \u03c3(Wrei,k + Vr \u2212\u2192 h i,k\u22121) sk = tanh(Wsei,k + Vs( \u2212\u2192 h i,k\u22121 \u25e6 rk)) \u2212\u2192 h i,k = (1\u2212 zk) \u25e6 sk + zk \u25e6 \u2212\u2192 h i,k\u22121,\n(2)\nwhere \u2212\u2192 h i,0 is initialized with a isotropic Gaussian distribution, ei,k is the embedding of wi,k, zk and rk are an update gate and a reset gate respectively, \u03c3(\u00b7) is a sigmoid function, and Wz,Wr,Ws,Vz,Vr,Vs are parameters. The backward GRU reads ui in its reverse order (i.e., from wi,Ti to wi,1) and generates { \u2190\u2212 h i,k}Tik=1 with a parameterization similar to the forward GRU."}, {"heading": "4.2 Hierarchical Attention and Utterance Encoder", "text": "Suppose that the decoder has generated t \u2212 1 words, at step t, word level attention calculates a weight vector (\u03b1i,t,1, . . . , \u03b1i,t,Ti) (details are described later) for {hi,j}Tij=1 and represents utterance ui as a vector ri,t. \u2200i \u2208 {1, . . . ,m}, ri,t is defined by\nri,t = Ti\u2211 j=1 \u03b1i,t,jhi,j . (3)\n{ri,t}mi=1 are then utilized as input of an utterance level encoder and transformed to (l1,t, . . . , lm,t) as hidden vectors of the context. After that, utterance level attention assigns a weight \u03b2i,t to li,t (details are described later) and forms a context vector ct as\nct = m\u2211 i=1 \u03b2i,tli,t. (4)\nIn both Equation (3) and Equation (4), the more important a hidden vector is, the larger weight it\nwill have, and the more contributions it will make to the high level vector (i.e., the utterance vector and the context vector). This is how the two levels of attention attends to the important parts of utterances and the important utterances in generation.\nMore specifically, the utterance level encoder is a backward GRU which processes {ri,t}mi=1 from the message rm,t to the earliest history r1,t. Similar to Equation (2), \u2200i \u2208 {m, . . . , 1}, li,t is calculated as\nz\u2032i = \u03c3(Wzlri,t + Vzlli+1,t) r\u2032i = \u03c3(Wrlri,t + Vrlli+1,t) s\u2032i = tanh(Wslri,t + Vsl(li+1,t \u25e6 r\u2032i)) li,t = (1\u2212 z\u2032i) \u25e6 s\u2032i + z\u2032i \u25e6 li+1,t,\n(5)\nwhere lm+1,t is initialized with a isotropic Gaussian distribution, z\u2032i and r \u2032 i are the update gate and the reset gate of the utterance level GRU respectively, and Wzl,Vzl,Wrl,Vrl,Wsl,Vsl are parameters.\nDifferent from the classic attention mechanism, word level attention in HRAN depends on both the hidden states of the decoder and the hidden states of the utterance level encoder. It works in a reverse order by first weighting {hm,j}Tmj=1 and then moving towards {h1,j}T1j=1 along the utterance sequence. \u2200i \u2208 {m, . . . , 1}, j \u2208 {1, . . . , Ti}, weight \u03b1i,t,j is calculated as\nei,t,j = \u03b7(st\u22121, li+1,t,hi,j); \u03b1i,t,j = exp(ei,t,j)\u2211Ti\nk=1 exp(ei,t,k) ,\n(6)\nwhere lm+1,t is initialized with a isotropic Gaussian distribution, st\u22121 is the (t\u22121)-th hidden state of the decoder, and \u03b7(\u00b7) is a multi-layer perceptron (MLP) with tanh as an activation function.\nNote that the word level attention and the utterance level encoding are dependent with each other and alternatively conducted (first attention then encoding). The motivation we establish the dependency between \u03b1i,t,j and li+1,t is that content from the context (i.e., li+1,t) could help identify important information in utterances, especially when st\u22121 is not informative enough (e.g., the generated part of the response are almost function words). We require the utterance encoder and the word level attention to work reversely, because we think that compared to history, conversation that happened after an utterance in the context is more likely to be capable of identifying important information in the utterance for generating a proper response to the context.\nWith {li,t}mi=1, the utterance level attention calculates a weight \u03b2i,t for li,t as\ne\u2032i,t = \u03b7(st\u22121, li,t); \u03b2i,t = exp(e\u2032i,t)\u2211m i=1 exp(e \u2032 i,t) . (7)"}, {"heading": "4.3 Decoding the Response", "text": "The decoder of HRAN is a RNN language model (Mikolov et al., 2010) conditioned on the context vectors {ct}Tt=1 given by Equation (4). Formally, the probability distribution p(y1, . . . , yT |U) is defined as\np(y1, ..., yT |U) = p(y1|c1) T\u220f\nt=2\np(yt|ct, y1, ..., yt\u22121). (8)\nwhere p(yt|ct, y1, ..., yt\u22121) is given by\nst = f(eyt\u22121 , st\u22121, ct) p(yt|ct, y1, ..., yt\u22121) = Iyt \u00b7 softmax(st, eyt\u22121), (9)\nwhere st is the hidden state of the decoder at step t, eyt\u22121 is the embedding of yt\u22121, f is a GRU, Iyt is the one-hot vector for yt, and softmax(st, eyt\u22121) is a V -dimensional vector with V the response vocabulary size and each element the generation probability of a word. In practice, we employ the beam search (Tillmann and Ney, 2003) technique to generate the n-best responses.\nLet us denote \u0398 as the parameter set of HRAN, then we estimate \u0398 from D = {(Ui,Yi)}Ni=1 by minimizing the following objective function:\n\u0398\u0302 = arg min \u0398 \u2212 N\u2211 i=1 log (p(yi,1, ..., yi,Ti |Ui)) (10)"}, {"heading": "5 Experiments", "text": "We compared HRAN with state-of-the-art methods by both automatic evaluation and side-by-side human judgment."}, {"heading": "5.1 Data Set", "text": "We built a data set from Douban Group2 which is a popular Chinese social networking service (SNS) allowing users to discuss a wide range of topics in groups through posting and commenting. In Douban Group, regarding to a post under a specific topic, two persons can converse with each other by one posting a comment and the other quoting it and posting another comment. We crawled 20 million conversations between two persons with the average number of turns as 6.32. The data covers many different topics and can be viewed as a simulation of open domain conversations in a chatbot. In each conversation, we treated the last turn as response, and the remaining turns as context. As preprocessing, we first employed Stanford Chinese word segmenter3 to tokenize each utterance in the data. Then we removed the conversations whose response appearing more than 50 times in the whole data to prevent them from dominating learning. We also removed the conversations shorter than 3 turns and the conversations with an utterance longer than 50 words. After the preprocessing, there are 1, 656, 652 conversations left. From them, we randomly sampled 1 million conversations as training data, 10, 000 conversations as validation data, and 1, 000 conversations as test data, and made sure that there is no overlap among them. In the test data, the contexts were used to generate responses and their responses were used as ground truth to calculate perplexity of generation models. We kept the 40, 000 most frequent words in the contexts of the training data to construct a context vocabulary. The vocabulary covers 98.8% of words appearing in the contexts of the training data. Similarly, we constructed a response vocabulary that contains the 40, 000 most frequent words in the responses of the training data which covers 99.0% words appearing in the responses. Words outside the two vocabularies were treated as \u201cUNK\u201d. The data will be publicly available.\n2https://www.douban.com/group/explore 3http://nlp.stanford.edu/software/segmenter.shtml"}, {"heading": "5.2 Baselines", "text": "We compared HRAN with the following models: S2SA: we concatenated all utterances in a context as a long sequence and treated the sequence and the response as a message-response pair. By this means, we transformed the problem of multiturn response generation to a problem of singleturn response generation and employed the standard sequence to sequence with attention (Shang et al., 2015) as a baseline.\nHRED: the hierarchical encoder-decoder model proposed by (Serban et al., 2016a).\nVHRED: a modification of HRED (Serban et al., 2016c) where latent variables are introduced in to generation. In all models, we set the dimensionality of hidden states of encoders and decoders as 1000, and the dimensionality of word embedding as 620. All models were initialized with isotropic Gaussian distributions X \u223c N (0, 0.01) and trained with an AdaDelta algorithm (Zeiler, 2012) on a NVIDIA Tesla K40 GPU. The batch size is 128. We set the initial learning rate as 1.0 and reduced it by half if the perplexity on validation began to increase. We implemented the models with an open source deep learning tool Blocks4."}, {"heading": "5.3 Evaluation Metrics", "text": "How to evaluate a response generation model is still an open problem but not the focus of the paper. We followed the existing work and employed the following metrics:\nPerplexity: following (Vinyals and Le, 2015), we employed perplexity as an evaluation metric. Perplexity is defined by Equation (11). It measures how well a model predicts human responses. Lower perplexity generally indicates better generation performance. In our experiments, perplexity on validation was used to determine when to stop training. If the perplexity stops decreasing and the difference is smaller than 2.0 five times in validation, we think that the algorithm has reached convergence and terminate training. We tested the generation ability of different models by perplex-\n4https://github.com/mila-udem/blocks\nity on the test data.\nPPL = exp { \u2212 1 N \u03a3Ni=1 log(p(Yi|Ui)) } . (11)\nSide-by-side human annotation: we also compared HRAN with every baseline model by sideby-side human comparison. Specifically, we recruited three native speakers with rich Douban Group experience as human annotators. To each annotator, we showed a context of a test example with two generated responses, one from HRAN and the other one from a baseline model. Both responses are the top one results in beam search. The two responses were presented in random order. We then asked the annotator to judge which one is better. The criteria is, response A is better than response B if (1) A is relevant, logically consistent to the context, and fluent, while B is either irrelevant or logically contradictory to the context, or it is disfluent (e.g., with grammatical errors or UNKs); or (2) both A and B are relevant, consistent, and fluent, but A is more informative and interesting than B (e.g., B is a universal reply like \u201cI see\u201d). If the annotator cannot tell which one is better, he/she was asked to label a \u201ctie\u201d. Each annotator individually judged 1000 test examples for each HRAN-baseline pair, and in total, each one judged 3000 examples (for three pairs). Agreements among the annotators were calculated using Fleiss\u2019 kappa (Fleiss and Cohen, 1973).\nNote that we do not choose BLEU (Papineni et al., 2002) as an evaluation metric, because (1) Liu et al. (Liu et al., 2016) have proven that BLEU is not a proper metric for evaluating conversation models as there is weak correlation between BLEU and human judgment; (2) different from the single-turn case, in multi-turn conversation, one context usually has one copy in the whole data. Thus, without any human effort like what Sordoni et al. (Sordoni et al., 2015) did in their work, each context only has a single reference in test. This makes BLEU even unreliable as a measurement of generation quality in open domain conversation due to the diversity of responses."}, {"heading": "5.4 Evaluation Results", "text": "Table 1 gives the results on perplexity. HRAN achieves the lowest perplexity on both validation\nand test. We conducted t-test on test perplexity and the result shows that the improvement of HRAN over all baseline models is statistically significant (p-value < 0.01).\nTable 2 shows the human annotation results. The ratios were calculated by combining the annotations from the three judges together. We can see that HRAN outperforms all baseline models and all comparisons have relatively high kappa scores which indicates that the annotators reached relatively high agreements in judgment. Compared with S2SA, HRED, and VHRED, HRAN achieves preference gains (win-loss) 6.7%, 6%, 4.8% respectively. Sign test results show that the improvement is statistically significant (p-value< 0.01 for HRAN v.s. S2SA and HRAN v.s. HRED, and pvalue < 0.05 for HRAN v.s. VHRED). Among the three baseline models, S2SA is the worst one, because it loses relationships among utterances in the context. VHRED is the best baseline model, which is consistent with the existing literatures (Serban et al., 2016c). We checked the cases on which VHRED loses to HRAN and found that on 56% cases, VHRED generated irrelevant responses while responses given by HRAN are relevant, logically consistent, and fluent."}, {"heading": "5.5 Discussions", "text": "Case study: Figure 3 lists some cases from the test set to compare HRAN with the best baseline VHRED. We can see that HRAN not only can answer the last turn in the context (i.e., the mes-\nsage) properly by understanding the context (e.g., case 2), but also be capable of starting a new topic according to the conversation history to keep the conversation going (e.g., case 1). In case 2, HRAN understands that the message is actually asking \u201cwhy can\u2019t you come to have dinner with me?\u201d and generates a proper response that gives a plausible reason. In case 1, HRAN properly brings up a new topic by asking the \u201cbrand\u201d of the user\u2019s \u201clotion\u201d when the current topic \u201chow to exfoliate my skin\u201d has come to an end. The new topic is based on the content of the context and thus can naturally extends the conversation in the case.\nVisualization of attention: to further illustrate why HRAN can generate high quality responses, we visualized the hierarchical attention for the cases in Figure 3 in Figure 4. In every sub-figure, each line is an utterance with blue color indicating word importance. The leftmost column of each sub-figure uses red color to indicate utterance importance. Darker color means more important words or utterances. The importance of a word or an utterance was calculated by the average weight of the word or the utterance assigned by attention in generating the response given at the bottom of each sub-figure. It reflects an overall contribution of the word or the utterance to generate the response. Above each line, we gave the transla-\ntion of the utterance, and below it, we translated important words. Note that word-to-word translation may cause confusion sometimes, therefore, we left some words (most of them are function words) untranslated. We can see that the hierarchical attention mechanism in HRAN can attend to both important words and important utterances in contexts. For example, in Figure 4(c), words including \u201cgirl\u201d and \u201cboyfriend\u201d and numbers including \u201c160\u201d and \u201c175\u201d are highlighted, and u1 and u4 are more important than others. The result matches our intuition in introduction. In Figure 4(b), HRAN assigned larger weights to u1, u4 and words like \u201cdinner\u201d and \u201cwhy\u201d. This explains why the model can understand that the message is actually asking \u201cwhy can\u2019t you come to have dinner with me?\u201d. The figures provide us insights on how HRAN understands contexts in generation.\nModel ablation: we then examine the effect of different components of HRAN by removing them one by one. We first removed li+1 from \u03b7(st\u22121, li+1,t,hi,j) in Equation (6) (i.e., removing utterance dependency from word level attention) and denoted the model as \u201cNo UD Att\u201d, then we removed word level attention and utterance level attention separately, and denoted the models as \u201cNo Word Att\u201d and \u201cNo Utterance Att\u201d respectively. We conducted side-by-side human comparison on these models with the full HRAN on the test data and also calculated their test perplexity (PPL). Table 3 gives the results. We can see that\nall the components are useful because removing any of them will cause performance drop. Among them, word level attention is the most important one as HRAN achieved the most preference gain (4.6%) to No Word Att on human comparison.\nError analysis: we finally investigate how to improve HRAN in the future by analyzing the cases on which HRAN loses to VHRED. The errors can be summarized as: 51.81% logic contradiction, 26.95% universal reply, 7.77% irrelevant response, and 13.47% others. Most bad cases come from universal replies and responses that are logically contradictory to contexts. This is easy to understand as HRAN does not explicitly model the two issues. The result also indicates that (1) although contexts provide more information than single messages, multi-turn response generation still has the \u201csafe response\u201d problem as the single-turn case; (2) although attending to important words and utterances in generation can lead to informative and logically consistent responses for many cases like those in Figure 3, it is still not enough for fully understanding contexts due to the complex nature of conversations. The irrelevant responses might be caused by wrong attention in generation. Although the analysis might not cover all bad cases (e.g., HRAN and VHRED may both give bad responses), it sheds light on our future directions: (1) improving response diversity, e.g., by introducing extra content into generation like Xing et al. (Xing et al., 2016) and Mou et al. (Mou et al.,\n2016) did for single-turn conversation; (2) modeling logics in contexts; (3) improving attention."}, {"heading": "6 Conclusion", "text": "We propose a hierarchical recurrent attention network (HRAN) for multi-turn response generation in chatbots. Empirical studies on large scale conversation data show that HRAN can significantly outperform state-of-the-art models."}], "references": [{"title": "Neural machine translation by jointly learning to align and translate", "author": ["Dzmitry Bahdanau", "Kyunghyun Cho", "Yoshua Bengio."], "venue": "arXiv preprint arXiv:1409.0473.", "citeRegEx": "Bahdanau et al\\.,? 2014", "shortCiteRegEx": "Bahdanau et al\\.", "year": 2014}, {"title": "Mind as machine: A history of cognitive science", "author": ["Margaret Ann Boden."], "venue": "Clarendon Press.", "citeRegEx": "Boden.,? 2006", "shortCiteRegEx": "Boden.", "year": 2006}, {"title": "On the properties of neural machine translation: Encoder\u2013decoder approaches", "author": ["Kyunghyun Cho", "Bart van Merri\u00ebnboer", "Dzmitry Bahdanau", "Yoshua Bengio."], "venue": "Syntax, Semantics and Structure in Statistical Translation, page 103.", "citeRegEx": "Cho et al\\.,? 2014", "shortCiteRegEx": "Cho et al\\.", "year": 2014}, {"title": "Describing multimedia content using attention-based encoder-decoder networks", "author": ["Kyunghyun Cho", "Aaron Courville", "Yoshua Bengio."], "venue": "Multimedia, IEEE Transactions on, 17(11):1875\u20131886.", "citeRegEx": "Cho et al\\.,? 2015", "shortCiteRegEx": "Cho et al\\.", "year": 2015}, {"title": "The equivalence of weighted kappa and the intraclass correlation coefficient as measures of reliability", "author": ["Joseph L Fleiss", "Jacob Cohen."], "venue": "Educational and psychological measurement.", "citeRegEx": "Fleiss and Cohen.,? 1973", "shortCiteRegEx": "Fleiss and Cohen.", "year": 1973}, {"title": "Filter, rank, and transfer the knowledge: Learning to chat", "author": ["Sina Jafarpour", "Christopher JC Burges", "Alan Ritter."], "venue": "Advances in Ranking, 10.", "citeRegEx": "Jafarpour et al\\.,? 2010", "shortCiteRegEx": "Jafarpour et al\\.", "year": 2010}, {"title": "A diversity-promoting objective function for neural conversation models", "author": ["Jiwei Li", "Michel Galley", "Chris Brockett", "Jianfeng Gao", "Bill Dolan."], "venue": "arXiv preprint arXiv:1510.03055.", "citeRegEx": "Li et al\\.,? 2015", "shortCiteRegEx": "Li et al\\.", "year": 2015}, {"title": "A persona-based neural conversation model", "author": ["Jiwei Li", "Michel Galley", "Chris Brockett", "Jianfeng Gao", "Bill Dolan."], "venue": "arXiv preprint arXiv:1603.06155.", "citeRegEx": "Li et al\\.,? 2016", "shortCiteRegEx": "Li et al\\.", "year": 2016}, {"title": "How not to evaluate your dialogue system: An empirical study of unsupervised evaluation metrics for dialogue response generation", "author": ["Chia-Wei Liu", "Ryan Lowe", "Iulian V Serban", "Michael Noseworthy", "Laurent Charlin", "Joelle Pineau."], "venue": "arXiv preprint", "citeRegEx": "Liu et al\\.,? 2016", "shortCiteRegEx": "Liu et al\\.", "year": 2016}, {"title": "Recurrent neural network based language model", "author": ["Tomas Mikolov", "Martin Karafi\u00e1t", "Lukas Burget", "Jan Cernock\u1ef3", "Sanjeev Khudanpur."], "venue": "INTERSPEECH 2010, 11th Annual Conference of the International Speech Communication Association,", "citeRegEx": "Mikolov et al\\.,? 2010", "shortCiteRegEx": "Mikolov et al\\.", "year": 2010}, {"title": "Sequence to backward and forward sequences: A content-introducing approach to generative short-text conversation", "author": ["Lili Mou", "Yiping Song", "Rui Yan", "Ge Li", "Lu Zhang", "Zhi Jin."], "venue": "arXiv preprint arXiv:1607.00970.", "citeRegEx": "Mou et al\\.,? 2016", "shortCiteRegEx": "Mou et al\\.", "year": 2016}, {"title": "Bleu: a method for automatic evaluation of machine translation", "author": ["Kishore Papineni", "Salim Roukos", "Todd Ward", "WeiJing Zhu."], "venue": "Proceedings of the 40th annual meeting on association for computational linguistics, pages 311\u2013318. Association for", "citeRegEx": "Papineni et al\\.,? 2002", "shortCiteRegEx": "Papineni et al\\.", "year": 2002}, {"title": "Hierarchical attention networks", "author": ["Paul Hongsuck Seo", "Zhe Lin", "Scott Cohen", "Xiaohui Shen", "Bohyung Han."], "venue": "arXiv preprint arXiv:1606.02393.", "citeRegEx": "Seo et al\\.,? 2016", "shortCiteRegEx": "Seo et al\\.", "year": 2016}, {"title": "Building end-to-end dialogue systems using generative hierarchical neural network models", "author": ["Iulian V Serban", "Alessandro Sordoni", "Yoshua Bengio", "Aaron Courville", "Joelle Pineau."], "venue": "arXiv preprint arXiv:1507.04808.", "citeRegEx": "Serban et al\\.,? 2015", "shortCiteRegEx": "Serban et al\\.", "year": 2015}, {"title": "Building end-to-end dialogue systems using generative hierarchical neural network models", "author": ["Iulian V Serban", "Alessandro Sordoni", "Yoshua Bengio", "Aaron Courville", "Joelle Pineau."], "venue": "Proceedings of the 30th AAAI Conference on Artificial Intelligence", "citeRegEx": "Serban et al\\.,? 2016a", "shortCiteRegEx": "Serban et al\\.", "year": 2016}, {"title": "Multiresolution recurrent neural networks: An application to dialogue response generation", "author": ["Iulian Vlad Serban", "Tim Klinger", "Gerald Tesauro", "Kartik Talamadupula", "Bowen Zhou", "Yoshua Bengio", "Aaron Courville."], "venue": "arXiv preprint", "citeRegEx": "Serban et al\\.,? 2016b", "shortCiteRegEx": "Serban et al\\.", "year": 2016}, {"title": "A hierarchical latent variable encoder-decoder model for generating dialogues", "author": ["Iulian Vlad Serban", "Alessandro Sordoni", "Ryan Lowe", "Laurent Charlin", "Joelle Pineau", "Aaron Courville", "Yoshua Bengio."], "venue": "arXiv preprint arXiv:1605.06069.", "citeRegEx": "Serban et al\\.,? 2016c", "shortCiteRegEx": "Serban et al\\.", "year": 2016}, {"title": "Neural responding machine for short-text conversation", "author": ["Lifeng Shang", "Zhengdong Lu", "Hang Li."], "venue": "arXiv preprint arXiv:1503.02364.", "citeRegEx": "Shang et al\\.,? 2015", "shortCiteRegEx": "Shang et al\\.", "year": 2015}, {"title": "A neural network approach to context-sensitive generation of conversational responses", "author": ["Alessandro Sordoni", "Michel Galley", "Michael Auli", "Chris Brockett", "Yangfeng Ji", "Margaret Mitchell", "Jian-Yun Nie", "Jianfeng Gao", "Bill Dolan."], "venue": "arXiv preprint", "citeRegEx": "Sordoni et al\\.,? 2015", "shortCiteRegEx": "Sordoni et al\\.", "year": 2015}, {"title": "Sequence to sequence learning with neural networks", "author": ["Ilya Sutskever", "Oriol Vinyals", "Quoc V Le."], "venue": "Advances in neural information processing systems, pages 3104\u20133112.", "citeRegEx": "Sutskever et al\\.,? 2014", "shortCiteRegEx": "Sutskever et al\\.", "year": 2014}, {"title": "Word reordering and a dynamic programming beam search algorithm for statistical machine translation", "author": ["Christoph Tillmann", "Hermann Ney."], "venue": "Computational linguistics, 29(1):97\u2013133.", "citeRegEx": "Tillmann and Ney.,? 2003", "shortCiteRegEx": "Tillmann and Ney.", "year": 2003}, {"title": "A neural conversational model", "author": ["Oriol Vinyals", "Quoc Le."], "venue": "arXiv preprint arXiv:1506.05869.", "citeRegEx": "Vinyals and Le.,? 2015", "shortCiteRegEx": "Vinyals and Le.", "year": 2015}, {"title": "The anatomy of ALICE", "author": ["Richard S Wallace."], "venue": "Springer.", "citeRegEx": "Wallace.,? 2009", "shortCiteRegEx": "Wallace.", "year": 2009}, {"title": "Topic aware neural response generation", "author": ["Chen Xing", "Wei Wu", "Yu Wu", "Jie Liu", "Yalou Huang", "Ming Zhou", "Wei-Ying Ma."], "venue": "arXiv preprint arXiv:1606.08340.", "citeRegEx": "Xing et al\\.,? 2016", "shortCiteRegEx": "Xing et al\\.", "year": 2016}, {"title": "Hierarchical attention networks for document classification", "author": ["Zichao Yang", "Diyi Yang", "Chris Dyer", "Xiaodong He", "Alex Smola", "Eduard Hovy."], "venue": "Proceedings of the 2016 Conference of the North American Chapter of the Association for Computa-", "citeRegEx": "Yang et al\\.,? 2016", "shortCiteRegEx": "Yang et al\\.", "year": 2016}, {"title": "The hidden information state model: A practical framework for pomdp-based spoken dialogue management", "author": ["Mairesse", "Jost Schatzmann", "Blaise Thomson", "Kai Yu."], "venue": "Computer Speech & Language, 24(2):150\u2013174.", "citeRegEx": "Mairesse et al\\.,? 2010", "shortCiteRegEx": "Mairesse et al\\.", "year": 2010}, {"title": "Pomdp-based statistical spoken dialog systems: A review", "author": ["Stephanie Young", "Milica Gasic", "Blaise Thomson", "John D Williams."], "venue": "Proceedings of the IEEE, 101(5):1160\u20131179.", "citeRegEx": "Young et al\\.,? 2013", "shortCiteRegEx": "Young et al\\.", "year": 2013}, {"title": "Adadelta: an adaptive learning rate method", "author": ["Matthew D Zeiler."], "venue": "arXiv preprint arXiv:1212.5701.", "citeRegEx": "Zeiler.,? 2012", "shortCiteRegEx": "Zeiler.", "year": 2012}], "referenceMentions": [{"referenceID": 26, "context": "Conversational agents include task-oriented dialog systems which are built in vertical domains for specific tasks (Young et al., 2013; Boden, 2006; Wallace, 2009; Young et al., 2010), and non-task-oriented chatbots which aim to realize natural and human-like conversations with people", "startOffset": 114, "endOffset": 182}, {"referenceID": 1, "context": "Conversational agents include task-oriented dialog systems which are built in vertical domains for specific tasks (Young et al., 2013; Boden, 2006; Wallace, 2009; Young et al., 2010), and non-task-oriented chatbots which aim to realize natural and human-like conversations with people", "startOffset": 114, "endOffset": 182}, {"referenceID": 22, "context": "Conversational agents include task-oriented dialog systems which are built in vertical domains for specific tasks (Young et al., 2013; Boden, 2006; Wallace, 2009; Young et al., 2010), and non-task-oriented chatbots which aim to realize natural and human-like conversations with people", "startOffset": 114, "endOffset": 182}, {"referenceID": 5, "context": "regarding to a wide range of issues in open domains (Jafarpour et al., 2010).", "startOffset": 52, "endOffset": 76}, {"referenceID": 17, "context": "from large scale message-response pairs (Shang et al., 2015; Vinyals and Le, 2015).", "startOffset": 40, "endOffset": 82}, {"referenceID": 21, "context": "from large scale message-response pairs (Shang et al., 2015; Vinyals and Le, 2015).", "startOffset": 40, "endOffset": 82}, {"referenceID": 18, "context": "lem, researchers have taken conversation history into consideration and proposed response generation for multi-turn conversation (Sordoni et al., 2015; Serban et al., 2015; Serban et al., 2016b; Serban et al., 2016c).", "startOffset": 129, "endOffset": 216}, {"referenceID": 13, "context": "lem, researchers have taken conversation history into consideration and proposed response generation for multi-turn conversation (Sordoni et al., 2015; Serban et al., 2015; Serban et al., 2016b; Serban et al., 2016c).", "startOffset": 129, "endOffset": 216}, {"referenceID": 15, "context": "lem, researchers have taken conversation history into consideration and proposed response generation for multi-turn conversation (Sordoni et al., 2015; Serban et al., 2015; Serban et al., 2016b; Serban et al., 2016c).", "startOffset": 129, "endOffset": 216}, {"referenceID": 16, "context": "lem, researchers have taken conversation history into consideration and proposed response generation for multi-turn conversation (Sordoni et al., 2015; Serban et al., 2015; Serban et al., 2016b; Serban et al., 2016c).", "startOffset": 129, "endOffset": 216}, {"referenceID": 14, "context": "State-of-the-art methods such as HRED (Serban et al., 2016a) and VHRED (Serban et al.", "startOffset": 38, "endOffset": 60}, {"referenceID": 16, "context": ", 2016a) and VHRED (Serban et al., 2016c) focus on modeling the hierarchy of the context, whereas there is little exploration on how to select important parts from the context, although it is often a crucial step for generating a proper response.", "startOffset": 19, "endOffset": 41}, {"referenceID": 16, "context": "utterance importance, the state-of-the-art model VHRED (Serban et al., 2016c) misses important points and gives a response \u201care you a man or a woman\u201d which is OK if there were only u3 left, but nonsense given the whole context.", "startOffset": 55, "endOffset": 77}, {"referenceID": 17, "context": "Inspired by the success of the attention mechanism in single-turn response generation (Shang et al., 2015), we propose a hierarchical recurrent attention network (HRAN) for multi-turn response generation in which we introduce a hierarchical attention mechanism to dynamically highlight important parts of word sequences and the utterance sequence when generating a response.", "startOffset": 86, "endOffset": 106}, {"referenceID": 19, "context": "sic sequence to sequence model (Sutskever et al., 2014), various models (Shang et al.", "startOffset": 31, "endOffset": 55}, {"referenceID": 16, "context": "Under the architecture of HRED, more variants including VHRED (Serban et al., 2016c) and MrRNN (Serban et al.", "startOffset": 62, "endOffset": 84}, {"referenceID": 15, "context": ", 2016c) and MrRNN (Serban et al., 2016b) are proposed in order to introduce latent and explicit variables into", "startOffset": 19, "endOffset": 41}, {"referenceID": 6, "context": ", 2015; Vinyals and Le, 2015; Li et al., 2015; Xing et al., 2016; Li et al., 2016; ?) have been proposed under an encoder-decoder framework to improve generation quality from different perspectives such as relevance, diversity, and personality. Recently, multiturn response generation has drawn attention from academia. For example, Sordoni et al. (2015) proposed DCGM where context information is encoded with a multi-layer perceptron (MLP).", "startOffset": 30, "endOffset": 355}, {"referenceID": 6, "context": ", 2015; Vinyals and Le, 2015; Li et al., 2015; Xing et al., 2016; Li et al., 2016; ?) have been proposed under an encoder-decoder framework to improve generation quality from different perspectives such as relevance, diversity, and personality. Recently, multiturn response generation has drawn attention from academia. For example, Sordoni et al. (2015) proposed DCGM where context information is encoded with a multi-layer perceptron (MLP). Serban et al. (2016a) proposed HRED which models contexts in a hierarchical encoder-decoder framework.", "startOffset": 30, "endOffset": 465}, {"referenceID": 17, "context": ", 2015), and is quickly applied to single-turn response generation afterwards (Shang et al., 2015; Vinyals and Le, 2015).", "startOffset": 78, "endOffset": 120}, {"referenceID": 21, "context": ", 2015), and is quickly applied to single-turn response generation afterwards (Shang et al., 2015; Vinyals and Le, 2015).", "startOffset": 78, "endOffset": 120}, {"referenceID": 17, "context": ", 2015), and is quickly applied to single-turn response generation afterwards (Shang et al., 2015; Vinyals and Le, 2015). Recently, Yang et al. (2016) proposed a hierarchical attention network for document classification in which two levels of", "startOffset": 79, "endOffset": 151}, {"referenceID": 12, "context": "Seo et al. (2016) proposed a hierarchical attention network to precisely attending objects of different scales and shapes in images.", "startOffset": 0, "endOffset": 18}, {"referenceID": 0, "context": ", um), we employ a bidirectional recurrent neural network with gated recurrent units (BiGRU) (Bahdanau et al., 2014) to encode each ui, i \u2208 {1, .", "startOffset": 93, "endOffset": 116}, {"referenceID": 2, "context": "catenating the two arguments together, \u2212 \u2192 h i,k is the k-th hidden state of a forward GRU (Cho et al., 2014), and \u2190\u2212 h i,k is the k-th hidden state of a backward GRU.", "startOffset": 91, "endOffset": 109}, {"referenceID": 9, "context": "The decoder of HRAN is a RNN language model (Mikolov et al., 2010) conditioned on the context", "startOffset": 44, "endOffset": 66}, {"referenceID": 20, "context": "In practice, we employ the beam search (Tillmann and Ney, 2003) technique to generate the n-best responses.", "startOffset": 39, "endOffset": 63}, {"referenceID": 17, "context": "By this means, we transformed the problem of multiturn response generation to a problem of singleturn response generation and employed the standard sequence to sequence with attention (Shang et al., 2015) as a baseline.", "startOffset": 184, "endOffset": 204}, {"referenceID": 14, "context": "HRED: the hierarchical encoder-decoder model proposed by (Serban et al., 2016a).", "startOffset": 57, "endOffset": 79}, {"referenceID": 16, "context": "VHRED: a modification of HRED (Serban et al., 2016c) where latent variables are introduced in to generation.", "startOffset": 30, "endOffset": 52}, {"referenceID": 21, "context": "Perplexity: following (Vinyals and Le, 2015), we employed perplexity as an evaluation metric.", "startOffset": 22, "endOffset": 44}, {"referenceID": 4, "context": "Agreements among the annotators were calculated using Fleiss\u2019 kappa (Fleiss and Cohen, 1973).", "startOffset": 68, "endOffset": 92}, {"referenceID": 11, "context": "Note that we do not choose BLEU (Papineni et al., 2002) as an evaluation metric, because (1) Liu et al.", "startOffset": 32, "endOffset": 55}, {"referenceID": 8, "context": "(Liu et al., 2016) have proven that BLEU is not a proper metric for evaluating conversation models as there is weak correlation between BLEU and human judgment; (2) different from the single-turn case, in multi-turn conversation, one context usually has one copy in the whole data.", "startOffset": 0, "endOffset": 18}, {"referenceID": 18, "context": "(Sordoni et al., 2015) did in their work, each context only has a single reference in test.", "startOffset": 0, "endOffset": 22}, {"referenceID": 16, "context": "VHRED is the best baseline model, which is consistent with the existing literatures (Serban et al., 2016c).", "startOffset": 84, "endOffset": 106}, {"referenceID": 23, "context": "(Xing et al., 2016) and Mou et al.", "startOffset": 0, "endOffset": 19}], "year": 2017, "abstractText": "We study multi-turn response generation in chatbots where a response is generated according to a conversation context. Existing work has modeled the hierarchy of the context, but does not pay enough attention to the fact that words and utterances in the context are differentially important. As a result, they may lose important information in context and generate irrelevant responses. We propose a hierarchical recurrent attention network (HRAN) to model both aspects in a unified framework. In HRAN, a hierarchical attention mechanism attends to important parts within and among utterances with word level attention and utterance level attention respectively. With the word level attention, hidden vectors of a word level encoder are synthesized as utterance vectors and fed to an utterance level encoder to construct hidden representations of the context. The hidden vectors of the context are then processed by the utterance level attention and formed as context vectors for decoding the response. Empirical studies on both automatic evaluation and human judgment show that HRAN can significantly outperform state-of-the-art models for multi-turn response generation.", "creator": "TeX"}}}