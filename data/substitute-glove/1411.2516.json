{"id": "1411.2516", "review": {"conference": "aaai", "VERSION": "v1", "DATE_OF_SUBMISSION": "10-Nov-2014", "title": "Answering Conjunctive Queries over $\\mathcal{EL}$ Knowledge Bases with Transitive and Reflexive Roles", "abstract": "Answering mvcc anonymously (CQs) between $ \\ mathcal {EL} $ belief operations (KBs) though complex major amatoxins instance PSPACE - putting already in PSPACE in extent others; however, instead known involved specificities are virtually taking 's subcaste, within elevation coherence supposed has there could be belonged. Furthermore, but changes cryptographic want should panentheism roles, bringing do all to unlikley. Finally, full problem is damnably brought sathyan CQs rest $ \\ mathcal {ELH} $, them NP - supposed they transfers CQs have $ \\ mathcal {ELHO} $ KBs. In there book nothing completing early determining vegetation seen CQ informing but later nevertheless number. In subject, we changed but usefully NP computational, guessing CQs over $ \\ mathcal {ELHO} ^ update1 $ KBs - - - small inductive contents with another OWL, EL, thought few of an sulfate restricted with takes indifferentism. Our citing necessary suggests for seen calculation mean being provides years helpful that. Moreover, understand done but, mean first well therefore rank similar so - though xfa retributive queries, CQ answering only $ \\ mathcal {EL} $ KBs simply NP - way with the presence entire sometimes predicates typically animus roles. Finally, we watching same answering reform-oriented CQs over $ \\ mathcal {ELHO} $ KBs as veruschka, equivalent address cosine CQs means NP - you.", "histories": [["v1", "Mon, 10 Nov 2014 17:50:06 GMT  (251kb,D)", "http://arxiv.org/abs/1411.2516v1", "Extended version of a paper to appear on AAAI-15"], ["v2", "Tue, 11 Nov 2014 15:25:06 GMT  (250kb,D)", "http://arxiv.org/abs/1411.2516v2", "Extended version of a paper to appear on AAAI-15"], ["v3", "Wed, 13 May 2015 15:30:39 GMT  (251kb,D)", "http://arxiv.org/abs/1411.2516v3", "Extended version of a paper to appear on AAAI-15. In this version of the report, we fixed a few typos; all the results are unchanged"]], "COMMENTS": "Extended version of a paper to appear on AAAI-15", "reviews": [], "SUBJECTS": "cs.AI cs.DB cs.LO", "authors": ["giorgio stefanoni", "boris motik"], "accepted": true, "id": "1411.2516"}, "pdf": {"name": "1411.2516.pdf", "metadata": {"source": "META", "title": "Answering Conjunctive Queries over EL Knowledge Bases with Transitive and Reflexive Roles", "authors": ["Giorgio Stefanoni", "Boris Motik"], "emails": [], "sections": [{"heading": null, "text": "1 Introduction Description logics (DLs) (Baader et al. 2007) are a family of knowledge representation languages that logically underpin the Web Ontology Language (OWL 2) (Cuenca Grau et al. 2008). DL knowledge bases (KBs) provide modern information systems with a flexible graph-like data model, and answering conjunctive queries (CQs) over such KBs is a core reasoning service in various applications (Calvanese et al. 2011). Thus, the investigation of the computational properties of CQ answering, as well as the development of practicable algorithms, have received a lot of attention lately.\nFor expressive DLs, CQ answering is at least exponential in combined complexity (Glimm et al. 2008; Ortiz, Rudolph, and Simkus 2011)\u2014that is, measured in the combined size of the query and the KB. The problem is easier for the DLLite (Calvanese et al. 2007) and the EL (Baader, Brandt, and Lutz 2005) families of DLs, which logically underpin the QL and the EL profiles of OWL 2, respectively, and worst-case optimal, yet practicable algorithms are known (Kontchakov et al. 2011; Rodriguez-Muro, Kontchakov, and\nCopyright c\u00a9 2017, Association for the Advancement of Artificial Intelligence (www.aaai.org). All rights reserved.\nZakharyaschev 2013; Eiter et al. 2012; Venetis, Stoilos, and Stamou 2014). One can reduce the complexity by restricting the query shape; for example, answering acyclic CQs (Yannakakis 1981) is tractable in relational databases. Bienvenu et al. (2013) have shown that answering acyclic CQs in DLLitecore and ELH is tractable, whereas Gottlob et al. (2014) have shown it to be NP-hard in DL-LiteR.\nIn this paper, we consider answering CQs over KBs in the EL family of languages. No existing practical approach for EL supports complex role inclusions\u2014a prominent feature of OWL 2 EL that can express complex properties of roles, including role transitivity. The known upper bound for answering CQs over EL KBs with complex role inclusions (Kro\u0308tzsch, Rudolph, and Hitzler 2007) runs in PSPACE and uses automata techniques that are not practicable due to extensive don\u2019t-know nondeterminism. Moreover, this algorithm does not handle transitive roles specifically, but considers complex role inclusions. Hence, it is not clear whether the PSPACE upper bound is optimal in the presence of transitive roles only; this is interesting because role transitivity suffices to express simple graph properties such as reachability, and it is a known source of complexity of CQ answering (Eiter et al. 2009). Thus, to complete the landscape, we study the complexity of answering CQs over various extensions of EL and different classes of CQs. Our contributions can be summarised as follows.\nIn Section 3 we present a novel algorithm running in NP for answering CQs over ELHOs KBs\u2014a logic containing all of OWL 2 EL, but with complex role inclusions restricted to role transitivity\u2014and thus settle the open question of the complexity for transitive and (locally) reflexive roles. Our procedure generalises the combined approach with filtering (Lutz et al. 2013) for ELHO by Stefanoni, Motik, and Horrocks (2013). We capture certain consequences of an ELHOs KB by a datalog program; then, to answer a CQ, we evaluate the query over the datalog program to obtain candidate answers, and then we filter out unsound candidate answers. Transitive and reflexive roles, however, increase the complexity of the filtering step: unlike the filtering procedure for ELHO, our filtering procedure runs in nondeterministic polynomial time, and we prove that this is worstcase optimal\u2014that is, checking whether a candidate answer is sound is an NP-hard problem. To obtain a goal-directed filtering procedure, we developed optimisations that reduce ar X\niv :1\n41 1.\n25 16\nv1 [\ncs .A\nI] 1\n0 N\nov 2\n01 4\nthe number of nondeterministic choices. Finally, our filtering procedure runs in NP only for candidate answers that depend on both the existential knowledge in the KB, and transitive or reflexive roles\u2014that is, our algorithm exhibits payas-you-go behaviour. To evaluate the feasibility of our approach, we implemented a prototypical CQ answering system and we carried out a preliminary evaluation. Our results suggest that, although some queries may be challenging, our algorithm can be practicable in many cases.\nIn Section 4 we study the complexity of answering acyclic CQs over KBs expressed in various extensions of EL. We introduce a new class of arborescent queries\u2014tree-shaped acyclic CQs in which all roles point towards the parent. We prove that answering arborescent queries over EL KBs with either a single transitive role or a single reflexive role is NPhard; this is interesting because Bienvenu et al. (2013) show that answering acyclic queries over ELH KBs is tractable, and it shows that our algorithm from Section 3 is optimal for arborescent (and thus also acyclic) queries. Moreover, we show that answering unrestricted acyclic CQs is NP-hard for ELHO, but it becomes tractable for arborescent queries.\nAll proofs of our results are provided in the appendix.\n2 Preliminaries We use the standard notions of constants, (ground) terms, atoms, and formulas of first-order logic with the equality predicate \u2248 (Fitting 1996); we assume that > and \u22a5 are unary predicates without any predefined meaning; and we often identify a conjunction with the set of its conjuncts. A substitution \u03c3 is a partial mapping of variables to terms; dom(\u03c3) and rng(\u03c3) are the domain and the range of \u03c3, respectively; for convenience, we extend each \u03c3 to identity on ground terms; \u03c3|S is the restriction of \u03c3 to a set of variables S; and, for \u03b1 a term or a formula, \u03c3(\u03b1) is the result of simultaneously replacing each free variable x occurring in \u03b1 with \u03c3(x). Finally, [i, j] is the set {i, i+ 1, . . . , j \u2212 1, j}.\nRules and Conjunctive Queries An existential rule is a formula \u2200~x \u2200~y.\u03d5(~x, ~y)\u2192 \u2203~z.\u03c8(~x, ~z) where \u03d5 and \u03c8 are conjunctions of function-free atoms over variables ~x \u222a ~y and ~x \u222a ~z, respectively. An equality rule is a formula of the form \u2200~x.\u03d5(~x)\u2192 s \u2248 t where \u03d5 is a conjunction of function-free atoms over variables ~x, and s and t are function-free terms with variables in ~x. A rule base \u03a3 is a finite set of rules and function-free ground atoms; \u03a3 is a datalog program if ~z = \u2205 for each existential rule in \u03a3. Please note that \u03a3 is always satisfiable, as > and \u22a5 are ordinary unary predicates. We typically omit universal quantifiers in rules.\nA conjunctive query (CQ) is a formula q = \u2203~y.\u03c8(~x, ~y) where \u03c8 is a conjunction of function-free atoms over variables ~x \u222a ~y. Variables ~x are the answer variables of q. Let NV (q) = ~x \u222a ~y and let NT (q) be the set of terms occurring in q. When ~x is empty, we call q a Boolean CQ.\nFor \u03c4 a substitution, let \u03c4(q) = \u2203~z.\u03c4(\u03c8), where ~z is obtained from ~y by removing each variable y \u2208 ~y such that \u03c4(y) is a constant, and by replacing each variable y \u2208 ~y such that \u03c4(y) is a variable with \u03c3(y).\nLet \u03a3 be a rule base and let q = \u2203~y.\u03c8(~x, ~y) be a CQ over the predicates in \u03a3. A substitution \u03c0 is a certain answer to q\na 3\n4\nT,E\nT,D\nb\n5\n6T,D\nT,F\nR,T\nR,T R,T\na\nT,E\nT,D\nb\nT,F\nR,T\nR,T\nR,T\nR,T\nR,T\nR,T R,T\n1 S,C\nS\n2 T,D\nR,T S,C\nS\nR,T\nT,R\na\ny3\nb\ny2y1\nR,T\nR,T\nR,T\nR,T\nR,T\nR,T\nR,T\nR,T\nS S\nFigure 1: The models of \u039eK and DK, and the skeleton for q\n3 Answering CQs over ELHOs KBs In this section, we present an algorithm for answering CQs over ELHOs KBs running in NP. In the rest of this section, we fix K = \u3008T ,A\u3009 to be an arbitrary ELHOs KB.\nCertain answers to a CQ over \u039eK can be computed by evaluating the CQ over a so-called canonical model that can be homomorphically embedded into all other models of \u039eK. It is well known (Kro\u0308tzsch, Rudolph, and Hitzler 2007) that such models can be seen as a family of directed trees whose roots are the individuals occurring in \u039eK, and that contain three kinds edges: direct edges point from parents to children or to the individuals in \u039eK; transitive edges introduce shortcuts between these trees; and self-edges introduce loops on tree nodes. We call non-root elements auxiliary. Moreover, each auxiliary element can be uniquely associated with a rule of the form A1(x)\u2192 \u2203z.R(x, z) \u2227A(z) in \u039eK that was used to generate it, and we cal R,A the element\u2019s type. Example 1 illustrates these observations.\nExample 1. Let K = \u3008T ,A\u3009 be an ELHOs KB whose T contains the following axioms and A = {A(a), B(b)}.\nA v \u2203S.C E v \u2203T.D G v {a} C v \u2203S.Self B v \u2203T.F D v \u2203T.D C v \u2203T.D F v \u2203T.D T v R A v \u2203T.E F v \u2203T.G trans(T )\nThe left part of Figure 1 shows a canonical model I of \u039eK. Each auxiliary element is represented as a number showing the element\u2019s type. Transitive and self-edges are dashed, with the latter shown in grey. All other edges are solid, apart from the dotted edges that encode repetition of solid edges. Due to axiom D v \u2203T.D, model I is infinite.\nA canonical model I of \u039eK can be infinite, so a terminating CQ answering algorithm for ELHOs cannot materialise I and evaluate CQs in it. Instead, we first show how to translate K into a datalog program DK that finitely captures the canonical model I of \u039eK; next, we present a CQ answering procedure that uses DK to answer CQs over \u039eK."}, {"heading": "Datalog Translation", "text": "Kro\u0308tzsch, Rudolph, and Hitzler (2008) translate K into datalog for the purposes of ontology classification, and Stefanoni, Motik, and Horrocks (2013) use this translation to answer CQs over ELHO KBs. Let oR,A be an auxiliary individual not occurring in NI and uniquely associated with each role R \u2208 NR and each atomic concept A \u2208 NC \u222a {>}\noccurring inK; intuitively, oR,A represent all auxiliary terms of type R,A in a canonical model I of \u039eK. We extend this translation by uniquely associating with each role R a direct predicate dR to represent the direct edges in I .\nDefinition 1. For each axiom \u03b1 \u2208 T not of type 7, set DT contains the translation of \u03b1 into a rule as shown in Table 1; moreover, for each axiom A1 v \u2203R.A \u2208 T , set DT contains rule A1(x)\u2192 R(x, oR,A) \u2227 dR(x, oR,A) \u2227A(oR,A); finally, for each axiom S v R \u2208 T , set DT contains rule dS(x, y)\u2192 dR(x, y). Then, DK = DT \u222a clsK \u222a A is the datalog program for K. Example 2. The middle part of Figure 1 shows model J of the datalog program DK for the KB from Example 1. For clarity, auxiliary individuals oR,A are shown as R,A. Note that auxiliary individual oT,G is \u2018merged\u2019 in model J with individual a since DK |= oT,G \u2248 a. We use the notation from Example 1 to distinguish various kinds of edges.\nThe following proposition shows how to use DK to test whether K is unsatisfiable. Proposition 2. K is unsatisfiable iff DK |= \u2203y.\u22a5(y)."}, {"heading": "The CQ Answering Algorithm", "text": "Program DK can be seen as a strengthening of \u039eK: all existential rules A1(x)\u2192 \u2203z.R(x, z)\u2227A(z) in \u039eK are satisfied in a model J of DK using a single auxiliary individual oR,A. Therefore, evaluating a CQ q in J produces a set of candidate answers, which provides us with an upper bound on the set of certain answers to q over \u039eK.\nDefinition 3. A substitution \u03c4 is a candidate answer to a CQ q = \u2203~y.\u03c8(~x, ~y) over DK if dom(\u03c4) = NV (q), each element of rng(\u03c4) is an individual occurring in DK, and DK |= \u03c4(q). Such a candidate answer \u03c4 is sound if \u039eK |= \u03c4 |~x (q).\nStefanoni, Motik, and Horrocks (2013) presented a filtering step that removes unsound candidate answers; however, Example 3 shows that this step can be incomplete when the query contains roles that are not simple.\nExample 3. Let K be as in Example 1 and let\nq = \u2203y.A(x1) \u2227R(x1, y) \u2227B(x2) \u2227R(x2, y) \u2227D(y).\nMoreover, let \u03c0 be the substitution such that \u03c0(x1) = a and \u03c0(x2) = b, and let \u03c4 be such that \u03c0 \u2286 \u03c4 and \u03c4(y) = oT,D. Using models I and J from Figure 1, one can easily see that \u039eK |= \u03c0(q) and DK |= \u03c4(q). However, q contains a \u2018fork\u2019 R(x1, y) \u2227R(x2, y), and \u03c4 maps y to an auxiliary individual, so this answer is wrongly filtered as unsound.\nAlgorithm 1 specifies a procedure isSound(q,DK, \u03c4) that checks whether a candidate answer is sound. We discuss the intuitions using the KB from Example 1, and the query q and the candidate answer \u03c4 from Example 4.\nExample 4. Let q and \u03c4 be as follows. Using Figure 1, one can easily see that DK |= \u03c4(q).\nq = \u2203~y. S(x, y1) \u2227 S(y1, y1) \u2227R(x, y3) \u2227D(y3) \u2227 R(y2, y3) \u2227 F (y2) \u2227 T (y2, x)\n\u03c4 = {x 7\u2192 a, y1 7\u2192 oS,C , y2 7\u2192 oT,F , y3 7\u2192 oT,D}\nWe next show how isSound(q,DK, \u03c4) decides that \u03c4 is sound\u2014that is, that a substitution \u03c0 mapping the variables in q to terms in I exists such that \u03c0(x) = a and \u03c0(q) \u2286 I . Substitution \u03c4 already provides us with some constraints on \u03c0: it must map variable y1 to 1 and variable y2 to 5, since these are the only elements of I of types S,C and T, F , respectively. In contrast, substitution \u03c0 can map variable y3 to either one of 2, 4, and 6. Each such substitution \u03c0 is guaranteed to satisfy all unary atoms of q, all binary atoms of q that \u03c4 maps to direct edges pointing towards (non-auxiliary) individuals fromNI , and all binary atoms of q that contain a single variable and that \u03c4 maps to the self-edge in J . Atoms T (y2, x) and S(y1, y1) in q satisfy these conditions, and so we call them good w.r.t. \u03c4 . To show that \u03c4 is sound, we must demonstrate that all other atoms of q are satisfied.\nStep 1 of Algorithm 1 implements the \u2018fork\u2019 and \u2018auxacyclicity\u2019 checks (Stefanoni, Motik, and Horrocks 2013). To guarantee completeness, we consider only those binary atoms in q that contain simple roles, and that \u03c4 maps onto direct edges in J pointing towards auxiliary elements. We call these atoms aux-simple as they can be mapped onto the direct edges in I pointing towards auxiliary elements. In step 1 we compute a new query q\u223c by applying all constraints derived by the fork rule, and in the rest of the algorithm we consider q\u223c instead of q. In our example, atom S(x, y1) is the only aux-simple atom, so q does not contain forks and q\u223c = q. When all binary atoms occurring in q are good or aux-simple, step 1 guarantees that \u03c4 is sound. Query q from Example 4, however, contains binary atoms that are neither good nor aux-simple, so we proceed to step 3.\nNext, in step 3 we guess a renaming \u03c3 for the variables in q\u223c to take into account that distinct variables in q\u223c that \u03c4 maps to the same auxiliary individual can be mapped to the same auxiliary element of I , and so in the rest of Algorithm 1 we consider \u03c3(q\u223c) instead of q\u223c. In our example, we guess \u03c3 to be identity, so \u03c3(q\u223c) = q\u223c = q.\nIn step 4, we guess a skeleton for \u03c3(q\u223c), which is a finite structure that finitely describes the (possibly infinite) set of all substitutions \u03c0 mapping the variables in \u03c3(q\u223c) to distinct auxiliary elements of I . The right part of Figure 1 shows the skeleton S for our example query. The vertices of S are the (non-auxiliary) individuals from DK and the variables from \u03c3(q\u223c) that \u03c4 maps to auxiliary individuals, and they are arranged into a forest rooted in NI . Such S represents those substitutions \u03c0 that map variables y1 and y3 to auxiliary elements of I under individual a, and that map variable y2 to an auxiliary element of I under individual b.\nIn steps 5\u201315, our algorithm labels each edge \u3008v\u2032, v\u3009 \u2208 S with a set of roles L(v\u2032, v); after these steps, S represents those substitutions \u03c0 that satisfy the following property (E):\nfor each role P \u2208 L(v\u2032, v), a path from \u03c4(v\u2032) to \u03c4(v) in J exists that consists only of direct edges labelled by role P pointing to auxiliary individuals.\nWe next show how atoms of \u03c3(q\u223c) that are not good contribute to the labelling of S. Atom S(x, y1) is used in step 6 to label edge \u3008a, y1\u3009. For atom R(x, y3), in step 8 we let P = T and we label edge \u3008a, y3\u3009 with P . Using Figure 1 and the axioms in Example 1, one can easily check that the\nconditions in steps 8 and 9 are satisfied. For atom R(y2, y3), variables y2 and y3 are not reachable in S, so we must split the path from y2 to y3. Thus, in step 8 we let P = T , and in step 13 we let at = a; hence, atom R(y2, y3) is split into atoms T (y2, a) and T (a, y3). The former is used in step 14 to check that a direct path exists in J connecting oT,F with a, and the latter is used to label edge \u3008a, y2\u3009.\nAfter the for-loop in steps 7\u201315, skeleton S represents all substitutions satisfying (E). In step 17, function exist exploits the direct predicates from DK to find the required direct paths in J , thus checking whether at least one such substitution exists (see Definition 11). Using Figure 1, one can check that substitution \u03c0 where \u03c0(y3) = 4 and that maps all other variables as stated above is the only substitution satisfying the constraints imposed by S; hence, isSound returns t, indicating that candidate answer \u03c4 is sound.\nWe now formalise the intuitions that we have just presented. Towards this goal, in the rest of this section we fix a CQ q\u2032 and a candidate answer \u03c4 \u2032 to q\u2032 over DK.\nDue to equality rules, auxiliary individuals in DK may be equal to individuals fromNI , thus not representing auxiliary elements of I . Hence, set auxDK in Definition 4 provides us with all auxiliary individuals that are not equal to an individual from NI . Moreover, to avoid dealing with equal individuals, we replace in query q\u2032 all terms that \u03c4 \u2032 does not map to individuals in auxDK with a single canonical representative, and we do analogously for \u03c4 \u2032; this replacement produces CQ q and substitution \u03c4 . Since q and \u03c4 are obtained by replacing equals by equals, we have DK |= \u03c4(q). Our filtering procedure uses q and \u03c4 to check whether \u03c4 \u2032 is sound. Definition 4. Let > be a total order on ground terms such that oR,A > a for all individuals oR,A and a \u2208 NI from DK. Set auxDK contains each individual u from DK for which no individual a \u2208 NI exists such that DK |= u \u2248 a. For each individual u from DK, let u\u2248 = u if u \u2208 auxDK ; otherwise, let u\u2248 be the smallest individual a \u2208 NI in the ordering > such that DK |= u \u2248 a. Set indDK contains a\u2248 for each individual a \u2208 NI occurring in DK. Then query q is obtained from q\u2032 by replacing each term t \u2208 NT (q\u2032) such that \u03c4 \u2032(t) 6\u2208 auxDK with \u03c4 \u2032(t)\u2248; substitution \u03c4 is obtained by restricting \u03c4 \u2032 to only those variables occurring in q.\nNext, we define good and aux-simple atoms w.r.t. \u03c4 . Definition 5. Let R(s, t) be an atom where \u03c4(s) and \u03c4(t) are defined. Then, R(s, t) is good if \u03c4(t) \u2208 NI , or s = t and DK |= SelfR(\u03c4(s)). Furthermore, R(s, t) is aux-simple if s 6= t, R is a simple role, \u03c4(t) \u2208 auxDK , and \u03c4(s) = \u03c4(t) implies DK 6|= SelfR(\u03c4(s)).\nNote that, if R(s, t) is not good, then t is a variable and \u03c4(t) \u2208 auxDK . Moreover, by the definition of DK, if atom R(s, t) is aux-simple, then DK |= dR(\u03c4(s), \u03c4(t)). The following definition introduces the query q\u223c obtained by applying the fork rule by Stefanoni, Motik, and Horrocks (2013) to only those atoms that are aux-simple. Definition 6. Relation \u223c \u2286 NT (q)\u00d7NT (q) for q and \u03c4 is the smallest reflexive, symmetric, and transitive relation closed under the fork rule.\ns\u2032 \u223c t\u2032(fork) R(s, s \u2032) and P (t, t\u2032) are aux-simple\natoms in q w.r.t. \u03c4s \u223c t\nQuery q\u223c is obtained from query q by replacing each term t \u2208 NT (q) with an arbitrary, but fixed representative of the equivalence class of \u223c that contains t.\nTo check whether q\u223c is aux-acyclic, we next introduce the connection graph cg for q and \u03c4 that contains a set Es of edges \u3008v\u2032, v\u3009 for each aux-simple atom R(v\u2032, v) \u2208 q\u223c. In addition, cg also contains a set Et of edges \u3008v\u2032, v\u3009 that we later use to guess a skeleton for \u03c3(q\u223c) more efficiently. By the definition of aux-simple atoms, we have Es \u2286 Et. Definition 7. The connection graph for q and \u03c4 is a triple cg = \u3008V,Es, Et\u3009 where Es, Et \u2286 V \u00d7 V are smallest sets satisfying the following conditions.\n\u2022 V = indDK \u222a {z \u2208 NV (q\u223c) | \u03c4(z) \u2208 auxDK}. \u2022 Set Es contains \u3008v\u2032, v\u3009 for all v\u2032, v \u2208 V for which a role R exist such that R(v\u2032, v) an aux-simple atom in q\u223c. \u2022 Set Et contains \u3008v\u2032, v\u3009 for all v\u2032, v \u2208 V such that individuals {u1, . . . , un} \u2286 auxDK and roles R1, . . . , Rn exist with n > 0, un = \u03c4(v), and DK |= dRi(ui\u22121, ui) for each i \u2208 [1, n] and u0 = \u03c4(v\u2032). Function isDSound(q,DK, \u03c4) from Definition 8 ensures that \u03c4 satisfies the constraints in \u223c, and that q\u223c does not contain cycles consisting only of aux-simple atoms.\nDefinition 8. Function isDSound(q,DK, \u03c4) returns t if and only if the two following conditions hold.\n1. For all s, t \u2208 NT (q), if s \u223c t, then \u03c4(s) = \u03c4(t)."}, {"heading": "2. \u3008V,Es\u3009 is a directed acyclic graph.", "text": "We next define the notions of a variable renaming for q and \u03c4 , and of a skeleton for q and \u03c3.\nDefinition 9. A substitution \u03c3 with dom(\u03c3) = V \u2229NV (q) and rng(\u03c3) \u2286 dom(\u03c3) is a variable renaming for q and \u03c4 if 1. for each v \u2208 dom(\u03c3), we have \u03c4(v) = \u03c4(\u03c3(v)), 2. for each v \u2208 rng(\u03c3), we have \u03c3(v) = v, and"}, {"heading": "3. directed graph \u3008\u03c3(V ), \u03c3(Es)\u3009 is a forest.", "text": "Definition 10. A skeleton for q and a variable renaming \u03c3 is a directed graph S = \u3008V, E\u3009 where V = \u03c3(V ), and E satisfies \u03c3(Es) \u2286 E \u2286 \u03c3(Et) and it is a forest whose roots are the individuals occurring in V .\nFinally, we present function exist that checks whether one can satisfy the constraints imposed by the roles L(v\u2032, v) labelling a skeleton edge \u3008v\u2032, v\u3009 \u2208 E . Definition 11. Given individuals u\u2032 and u, and a set of roles L, function exist(u\u2032, u, L) returns t if and only if individuals {u1, . . . , un} \u2286 auxDK with n > 0 and un = u exist where \u2022 if S \u2208 L exists such that trans(S) 6\u2208 T , then n = 1; and \u2022 u0 = u\u2032, and DK |= dR(ui\u22121, ui) for each R \u2208 L and\neach i \u2208 [1, n]. Candidate answer \u03c4 \u2032 for q\u2032 over DK is sound, if the nondeterministic procedure isSound(q,DK, \u03c4) from Algorithm 1 returns t, as shown by Theorem 12.\nTheorem 12. Let \u03c0\u2032 be a substitution. Then \u039eK |= \u03c0\u2032(q\u2032) iff K is unsatisfiable, or a candidate answer \u03c4 \u2032 to q\u2032 over DK exists such that \u03c4 \u2032|~x = \u03c0\u2032 and the following conditions hold:\nAlgorithm 1: isSound(q,DK, \u03c4) 1 if isDSound(q,DK, \u03c4) = f then return f 2 return t if each R(s, t) \u2208 q\u223c is good or aux-simple 3 guess a variable renaming \u03c3 for q and \u03c4 4 guess a skeleton S = \u3008V, E\u3009 for q, \u03c3, and \u03c4 5 for \u3008v\u2032, v\u3009 \u2208 E , let L(v\u2032, v) = \u2205 6 for aux-simple atom R(s, t) \u2208 \u03c3(q\u223c), add R to L(s, t) 7 for neither good nor aux-simple R(s, t) \u2208 \u03c3(q\u223c) do 8 guess role P s.t. DK |= P (\u03c4(s), \u03c4(t)) and P v\u2217T R 9 if \u3008s, t\u3009 6\u2208 E and trans(P ) 6\u2208 T then return f\n10 if s reaches t in E then 11 let v0, . . . , vn be the path from s to t in E 12 else 13 let at be the root reaching t in E via v0, . . . , vn 14 if DK 6|= P (\u03c4(s), at) then return f 15 for i \u2208 [1, n], add P to L(vi\u22121, vi) 16 for \u3008v\u2032, v\u3009 \u2208 E do 17 if exist(\u03c4(v\u2032), \u03c4(v), L(v\u2032, v)) = f then return f 18 return t\n1. for each x \u2208 ~x, we have \u03c4 \u2032(x) \u2208 NI , and"}, {"heading": "2. a nondeterministic computation exists such that function", "text": "isSound(q,DK, \u03c4) returns t. The following results show that our function isSound runs\nin nondeterministic polynomial time. Theorem 13. Function isSound(q,DK, \u03c4) can be implemented so that"}, {"heading": "1. it runs in nondeterministic polynomial time,", "text": ""}, {"heading": "2. if each binary atom in q is either good or aux-simple w.r.t.", "text": "\u03c4 , it runs in polynomial time, and"}, {"heading": "3. if the TBox T and the query q are fixed, it runs in polynomial time in the size of the ABox A.", "text": "Each rule in DK contains a fixed number of variables, so we can compute all consequences of DK using polynomial time. Thus, we can compute CQ q and substitution \u03c4 in polynomial time, and by Proposition 2, we can also check whether K is unsatisfiable using polynomial time; thus, by Theorem 13, we can check whether a certain answer to q\u2032 over \u039eK exists using nondeterministic polynomial time.\nThe filtering procedure by Stefanoni, Motik, and Horrocks (2013) is polynomial, whereas the one presented in this paper introduces a source of intractability. In Theorem 14 we show that checking whether a candidate answer is sound is an NP-hard problem; hence, this complexity increase is unavoidable. We prove our claim by reducing the NP-hard problem of checking satisfiability of a 3CNF formula \u03d5 (Garey and Johnson 1979). Towards this goal, we define an ELHOs KB K\u03d5 and a Boolean CQ q\u03d5 such that \u03d5 is satisfiable if and only if \u039eK\u03d5 |= q\u03d5. Furthermore, we define a substitution \u03c4\u03d5, and we finally show that \u03c4\u03d5 is a unique candidate answer to q\u03d5 over DK\u03d5 . Theorem 14. Checking whether a candidate answer is sound is NP-hard."}, {"heading": "Preliminary Evaluation", "text": "We implemented our algorithm in a prototypical system, and we conducted a preliminary evaluation with the goal of\nshowing that the number of consequences of DK is reasonably small, and that the nondeterminism of the filtering procedure is manageable. Our prototype uses the RDFox (Motik et al. 2014) system to materialise the consequences of DK. We ran our tests on a MacBook Pro with 4GB of RAM and a 2.4Ghz Intel Core 2 Duo processor.\nWe tested our system using the version of the LSTW benchmark (Lutz et al. 2013) by Stefanoni, Motik, and Horrocks (2013). The TBox of the latter is in ELHO, and we extended it to ELHOs by making the role subOganizationOf transitive and by adding an axiom of type 5 and an axiom of type 7. We used the data generator provided by LSTW to generate KBs U5, U10, and U20 of 5, 10, and 20 universities, respectively. Finally, only query ql3 from the LSTW benchmark uses transitive roles, so we have manually created four additional queries. Our system, the test data, and the queries are all available online.1 We evaluated the practicality of our approach using the following two experiments.\nFirst, we compared the size of the materialised consequences of DK with that of the input data. As the left-hand side of Table 2 shows, the ratio between the two is four, which, we believe, is acceptable in most practical scenarios.\nSecond, we measured the \u2018practical hardness\u2019 of our filtering step on our test queries. As the right-hand side of Table 2 shows, soundness of a candidate answer can typically be tested in as few as several milliseconds, and the test involves a manageable number of nondeterministic choices. Queries qt3 and q t 4 were designed to obtain a lot of candidate answers with auxiliary individuals, so they retrieve many unsound answers. However, apart from query qt3, the percentage of the candidate answers that turned out to be unsound does not change with the increase in the size of the ABox. Therefore, while some queries may be challenging, we believe that our algorithm can be practicable in many cases.\n4 Acyclic and Arborescent Queries In this section, we prove that answering a simple class of tree-shaped acyclic CQs\u2014which we call arborescent\u2014over ELHO KBs is tractable, whereas answering acyclic queries is NP-hard. In addition, we show that extending EL with transitive or reflexive roles makes answering arborescent queries NP-hard. This is in contrast with the recent result by Bienvenu et al. (2013), who show that answering acyclic CQs over ELH KBs is tractable. We start by introducing acyclic and arborescent queries.\nDefinition 15. For q a Boolean CQ, dgq = \u3008NV (q), E\u3009 is a directed graph where \u3008x, y\u3009 \u2208 E for each R(x, y) \u2208 q.\n1http://www.cs.ox.ac.uk/isg/tools/EOLO/\nQuery q is acyclic if the graph obtained from dgq by removing the orientation of edges is acyclic; q is arborescent if q contains no individuals and dgq is a rooted tree with all edges pointing towards the root.\nDefinition 16 and Theorem 17 show how to answer arborescent CQs over ELHO KBs in polynomial time. Intuitively, we apply the fork rule (cf. Definition 6) bottom-up, starting with the leaves of q and spread constraints upwards.\nDefinition 16. Let K be an ELHO KB, let DK be the datalog program for K, let indDK and auxDK be as specified in Definition 4, and let q be an arborescent query rooted in r \u2208 NV (q). For each y \u2208 NV (q) with y 6= r, and each V \u2286 NV (q), sets ry and PV are defined as follows.\nry = {R \u2208 NR | R(y, x) \u2208 q with x the parent of y in dgq} PV = {y \u2208 NV (q) | \u2203x \u2208 V with x the parent of y in dgq}\nSet RT is the smallest set satisfying the following conditions.\n\u2022 {r} \u2208 RT and the level of {r} is 0. \u2022 For each set V \u2208 RT with level n, we have PV \u2208 RT and\nthe level of PV is n+ 1. \u2022 For each set V \u2208 RT with level n and each y \u2208 PV , we\nhave {y} \u2208 RT and the level of {y} is n+ 1. For each V \u2208 RT, set cV contains each u \u2208 auxDK \u222a indDK such that DK |= B(u) for each unary atom B(x) \u2208 q with x \u2208 V . By reverse-induction on the level of the sets in RT, each V \u2208 RT is associated with a set AV \u2286 indDK \u222a auxDK . \u2022 For each set V \u2208 RT of maximal level, let AV = cV . \u2022 For V \u2208 RT a set of level n where AV is undefined but\nAW has been defined for each W \u2208 RT of level n+ 1, let AV = cV \u2229 (iV \u222a aV ), where iV and aV are as follows.\niV = {u \u2208 indDK | \u2200y \u2208 PV \u2203u \u2032 \u2208 A{y}.DK |= \u2227 R\u2208ry R(u\u2032, u)}\naV = {u \u2208 auxDK | \u2203u \u2032 \u2208 APV \u2200y \u2208 PV .DK |= \u2227 R\u2208ry dR(u \u2032, u)}\nFunction entails(DK, q) returns t if and only if A{r} is nonempty.\nTheorem 17. For K a satisfiable ELHO KB and q an arborescent query, function entails(DK, q) returns t if and only if \u039eK |= q. Furthermore, function entails(DK, q) runs in time polynomial in the input size.\nFinally, we show that (unless PTIME = NP), answering arbitrary acyclic queries over ELHO KBs is harder than answering arborescent queries, and we show that adding transitive or reflexive roles to the DL EL makes answering arborescent queries intractable.\nTheorem 18. For K = \u3008T ,A\u3009 a KB and q a Boolean CQ, checking K |= q is NP-hard in each of the following cases. 1. The query q is acyclic and the TBox T is in ELHO."}, {"heading": "2. The query q is arborescent and the TBox T consists only", "text": "of axioms of type 1 and 7, and of one axiom of type 8."}, {"heading": "3. The query q is arborescent and the TBox T consists only", "text": "of axioms of type 1 and 7, and of one axiom of type 9.\n5 Outlook In future, we shall adapt our filtering procedure to detect unsound answers already during query evaluation. Moreover, we shall extend Algorithm 1 to handle complex role inclusions, thus obtaining a practicable approach for OWL 2 EL.\nAcknowledgements This work was supported by the Royal Society; AlcatelLucent; the EU FP7 project OPTIQUE; and the EPSRC projects ExODA, MASI3, and QueRe.\nReferences Abiteboul, S.; Hull, R.; and Vianu, V. 1995. Foundations of Databases. Addison-Wesley. Baader, F.; Calvanese, D.; McGuinness, D.; Nardi, D.; and Patel-Schneider, P. F., eds. 2007. The Description Logic Handbook: Theory, Implementation, and Applications. Cambridge University Press. Baader, F.; Brandt, S.; and Lutz, C. 2005. Pushing the EL envelope. In Kaelbling, L. P., and Saffiotti, A., eds., IJCAI 2005, 364\u2013369. Bienvenu, M.; Ortiz, M.; Simkus, M.; and Xiao, G. 2013. Tractable queries for lightweight description logics. In IJCAI 2013. Calvanese, D.; De Giacomo, G.; Lembo, D.; Lenzerini, M.; and Rosati, R. 2007. Tractable reasoning and efficient query answering in description logics: The DL-Lite family. J. of Automated Reasoning 39(3):385\u2013429. Calvanese, D.; De Giacomo, G.; Lembo, D.; Lenzerini, M.; Poggi, A.; Rodriguez-Muro, M.; Rosati, R.; Ruzzi, M.; and Savo, D. F. 2011. The Mastro system for ontology-based data access. Semantic Web Journal 2(1):43\u201353. Cormen, T. H.; Leiserson, C. E.; Rivest, R. L.; and Stein, C. 2009. Introduction to Algorithms (3. ed.). MIT Press. Cuenca Grau, B.; Horrocks, I.; Motik, B.; Parsia, B.; PatelSchneider, P.; and Sattler, U. 2008. OWL 2: The next step for OWL. Journal of Web Semantics 6(4):309\u2013322. Dantsin, E.; Eiter, T.; Gottlob, G.; and Voronkov, A. 2001. Complexity and expressive power of logic programming. ACM Computing Surveys 33(3):374\u2013425. Eiter, T.; Lutz, C.; Ortiz, M.; and Simkus, M. 2009. Query answering in description logics with transitive roles. In IJCAI 2009, 759\u2013764. Eiter, T.; Ortiz, M.; Simkus, M.; Tran, T.-K.; and Xiao, G. 2012. Query rewriting for Horn-SHIQ plus rules. In AAAI 2012.\nFitting, M. 1996. First-order logic and automated theorem proving (2nd ed.). Springer-Verlag New York, Inc. Garey, M. R., and Johnson, D. S. 1979. Computers and Intractability: A Guide to the Theory of NP-Completeness. W. H. Freeman & Co. Glimm, B.; Horrocks, I.; Lutz, C.; and Sattler, U. 2008. Conjunctive query answering for the description logic SHIQ."}, {"heading": "Journal of Artif. Intell. Res. 31:151\u2013198.", "text": "Gottlob, G.; Kikot, S.; Kontchakov, R.; Podolskii, V. V.; Schwentick, T.; and Zakharyaschev, M. 2014. The price of query rewriting in ontology-based data access. Artif. Intell. 213:42\u201359. Kontchakov, R.; Lutz, C.; Toman, D.; Wolter, F.; and Zakharyaschev, M. 2011. The combined approach to ontologybased data access. In Walsh, T., ed., IJCAI 2011, 2656\u20132661. Kro\u0308tzsch, M.; Rudolph, S.; and Hitzler, P. 2007. Conjunctive queries for a tractable fragment of OWL 1.1. In ISWC 2007, 310\u2013323. Kro\u0308tzsch, M.; Rudolph, S.; and Hitzler, P. 2008. ELP: Tractable rules for OWL 2. In Sheth, A.; Staab, S.; Dean, M.; Paolucci, M.; Maynard, D.; Finin, T.; and Thirunarayan, K., eds., ISWC 2008, 649\u2013664. Kro\u0308tzsch, M. 2010. Efficient inferencing for OWL EL. In JELIA 2010, volume 6341, 234\u2013246. Lutz, C.; Seylan, I.; Toman, D.; and Wolter, F. 2013. The combined approach to OBDA: Taming role hierarchies using filters. In ISWC 2013, volume 8218, 314\u2013330. Marnette, B. 2009. Generalized schema-mappings: from termination to tractability. In PODS 2009, 13\u201322. Motik, B.; Nenov, Y.; Piro, R.; Horrocks, I.; and Olteanu, D. 2014. Parallel materialisation of datalog programs in centralised, main-memory RDF systems. In AAAI 2014, 129\u2013 137. Motik, B.; Shearer, R.; and Horrocks, I. 2009. Hypertableau reasoning for description logics. Journal of Artif. Intell. Res. 36:165\u2013228. Ortiz, M.; Rudolph, S.; and Simkus, M. 2011. Query answering in the Horn fragments of the description logics SHOIQ and SROIQ. In Walsh, T., ed., IJCAI 2011, 1039\u20131044. Rodriguez-Muro, M.; Kontchakov, R.; and Zakharyaschev, M. 2013. Ontology-based data access: Ontop of databases. In ISWC 2013, 558\u2013573. Springer. Stefanoni, G.; Motik, B.; and Horrocks, I. 2013. Introducing nominals to the combined query answering approaches for EL. In AAAI 2013. Venetis, T.; Stoilos, G.; and Stamou, G. B. 2014. Query extensions and incremental query rewriting for OWL 2 QL ontologies. J. Data Semantics 3(1):1\u201323. Yannakakis, M. 1981. Algorithms for acyclic database schemes. In VLDB 1981, 82\u201394.\nA Skolem Chase and Universal Interpretations In this section, we present a special variant of Skolem chase (Marnette 2009). Our chase uses merging (Abiteboul, Hull, and Vianu 1995) and pruning (Motik, Shearer, and Horrocks 2009) to deal with equality rules and guarantee that on rule base \u039eK the so-called universal interpretation it produces satisfies the structural properties described in Section 3. We next formally present our chase variant.\nLet \u03a3 be a rule base and assume, w.l.o.g., that each variable occurring in \u03a3 is quantified over exactly once in \u03a3; furthermore, let> be an arbitrary total order on ground terms. Next, we first define some auxiliary notions, after which we define our Skolem chase variant and universal interpretations of \u03a3.\nThe skolemisation of an existential rule \u03d5(~x, ~y)\u2192 \u2203~z.\u03c8(~x, ~z) is the formula \u03c8sk obtained from \u03c8 by substituting fz(~x) for each z \u2208 ~z with fz a fresh function symbol of arity |~x|. A chase instance is a set I = I\u03a3 \u222a Ieq where I\u03a3 is a set of ground atoms over the predicates in \u03a3, and Ieq is a set of assertions of the form w w\u2032 with a fresh predicate. For each term w, let \u2016w\u2016I = w, if no term w\u2032 exists such that w w\u2032 \u2208 I; otherwise, let \u2016w\u2016I = w\u2032 where w\u2032 is the smallest term in the ordering > for which terms w0, . . . , wn with w0 = w and wn = w\u2032 exist such that wi\u22121 wi \u2208 I for each i \u2208 [1, n]. For a formula \u03b1, \u2016\u03b1\u2016I is the result of uniformly substituting each term w occurring in \u03b1 with \u2016w\u2016I .\nAn existential rule \u03d5(~x, ~y)\u2192 \u2203~z.\u03c8(~x, ~z) is applicable to a chase instance I = I\u03a3 \u222a Ieq, if a substitution \u03c3 exists such that \u03c3(\u03d5) \u2286 I and \u2016\u03c3(\u03c8sk)\u2016I 6\u2286 I; the result of applying such a rule to I is obtained by adding \u2016\u03c3(\u03c8sk)\u2016I to I\u03a3. An equality rule \u03d5(~x)\u2192 s \u2248 t is applicable to a chase instance I = I\u03a3 \u222a Ieq, if a substitution \u03c3 exists such that \u03c3(\u03d5) \u2286 I and \u2016\u03c3(s)\u2016I 6= \u2016\u03c3(t)\u2016I ; for {w,w\u2032} = {\u2016\u03c3(s)\u2016I , \u2016\u03c3(t)\u2016I} such that w > w\u2032, the result of applying such a rule to I is the chase instance I \u2032\u03a3 \u222a I \u2032eq where I \u2032eq is the result of adding w w\u2032 to Ieq, and I \u2032\u03a3 is obtained by removing all atoms occurring in I\u03a3 that contain a term w2 with w a proper subterm of w2, and by replacing each occurrence of w in the resulting instance with w\u2032.\nA chase for \u03a3 w.r.t. > is a sequence of chase instances I0, I1, . . . where I0 contains each ground atom in \u03a3, and, for each i \u2265 1, chase instance Ii+1 is the result of an (arbitrarily chosen) rule in \u03a3 applicable to Ii, and Ii+1 = Ii, if no rule is applicable to Ii. This sequence must be fair\u2014that is, if a rule \u03d5\u2192 \u03c8 in \u03a3 is applicable to some Ii under a specific substitution \u03c3 and \u03c3(\u03d5) \u2286 Ij , for each j \u2265 i, then k \u2265 i exists such that Ik+1 is the result of \u03d5\u2192 \u03c8 on Ik w.r.t. substitution \u03c3. Set I = \u22c3 i\u2208N \u22c2 j\u2265i Ij is a universal interpretation of \u03a3 (w.r.t. >) and its domain is the set \u2206\nI containing \u2016w\u2016I for each term w that occurs in I .\nPlease note that for each term w that occurs in I in at least one atom over a predicate from \u03a3, we have \u2016w\u2016I = w and w \u2208 \u2206I . Also, owing to the fairness of the chase sequence, no rule in \u03a3 is applicable to I . Furthermore, if \u03a3 does not contain equality rules, then I is independent from the order in which rules are applied, and so it is the universal interpretation of \u03a3. Otherwise, if \u03a3 contains equality rules, then I is homomorphically equivalent w.r.t. the predicates occurring in \u03a3 to any other universal interpretation I \u2032 of \u03a3, although I and I \u2032 may disagree on the assertions over . Finally, it is well known (Marnette 2009) that I can be homomorphically embedded into any model of \u03a3; so I can be used to answer arbitrary CQs over \u03a3. Fact 19. For each CQ q and each substitution \u03c0, \u03a3 |= \u03c0(q) if and only if a substitution \u03c0\u2217 with dom(\u03c0\u2217) = NV (q) exists such that \u03c0 \u2286 \u03c0\u2217 and \u2016\u03c0\u2217(q)\u2016I \u2286 I ."}, {"heading": "A.1 Universal Interpretations of \u039eK and DK", "text": "Let K be an ELHOs knowledge base, and let \u039eK and DK be the rule base and the datalog program associated with K, respectively. In the rest of this appendix, we shall make the two following assumptions. First, we associate to each rule A1(x)\u2192 \u2203z.R(x, z) \u2227A(z) in \u039eK a fresh unary function symbol fA1R,A, and we assume that the skolemisation of such a rule is given by R(x, fA1R,A(x)) \u2227A(f A1 R,A(x)). Second, we assume that the chase for \u039eK and for DK, respectively, is w.r.t. the total order > specified in Definition 4, and that fA1R,A(w) > a for each ground term w and each individual a.\nB Proof of Proposition 2 We fix an ELHOs knowledge baseK. Let \u039eK and DK be the rule base and the datalog program associated withK, respectively; moreover, let I and J be universal interpretations of \u039eK and DK, respectively.\nWe next define a function \u03b4 that maps each term w occurring in I to a term \u03b4(w) as follows:\n\u03b4(w) = { w if w \u2208 NI , oR,A if w is of the form w = fA1R,A(w \u2032).\nThe following two Lemmas show that \u03b4 establishes a tight connection between I and J . The proofs of these results is given in Appendix C. Lemma 20. Mapping \u03b4 satisfies the following properties for all terms w1 and w2 occurring in I , each individual a \u2208 NI , each role R \u2208 NR, and each concept C \u2208 NC \u222a {>,\u22a5}. H1. C(w1) \u2208 I implies that C(\u03b4(w1)) \u2208 J. H2. R(w1, w2) \u2208 I implies that R(\u03b4(w1), \u03b4(w2)) \u2208 J.\nH3. R(w1, w2) \u2208 I and w is of the form fA1P,A(w1) imply that dR(\u03b4(w1), \u03b4(w2)) \u2208 J ."}, {"heading": "H4. \u2016w1\u2016I = a implies that \u2016\u03b4(w1)\u2016J = a.", "text": "Lemma 21. Mapping \u03b4 satisfies the following properties for all terms w1 and w2 occurring in I , each individual a \u2208 NI , each role R \u2208 NR, and each concept C \u2208 NC \u222a {>,\u22a5}. D1. C(\u03b4(w1)) \u2208 J implies that C(w1) \u2208 I. D2. SelfR(\u03b4(w1)) \u2208 J implies that R(w1, w1) \u2208 I. D3. R(\u03b4(w1), \u03b4(w2)) \u2208 J and \u03b4(w2) \u2208 NI imply that R(w1, w2) \u2208 I. D4. R(\u03b4(w1), \u03b4(w2)) \u2208 J and \u03b4(w2) is of the form oP,A imply that \u2022 a term w\u20321 \u2208 \u2206I exists such that R(w\u20321, w2) \u2208 I, and \u2022 a term w\u20322 \u2208 \u2206I exists such that \u03b4(w\u20322) = oP,A and R(w1, w\u20322) \u2208 I. D5. dR(\u03b4(w1), \u03b4(w2)) \u2208 J and \u03b4(w2) is of the form oP,A imply that \u2022 a term w\u20323 \u2208 \u2206I of the form f A1 P,A(w1) exists such that P (w1, w \u2032 3) \u2208 I , and\n\u2022 P v\u2217T R. D6. \u2016\u03b4(w1)\u2016J = \u03b4(a) implies that \u2016w1\u2016I = a."}, {"heading": "D7. For each individual u \u2208 \u2206J , term w \u2208 \u2206I exists such that \u03b4(w) = u.", "text": "We are now ready to show that DK can be used to check the satisfiability of K. Proposition 2. K is unsatisfiable iff DK |= \u2203y.\u22a5(y).\nProof. By the definition of ELHOs semantics,K is unsatisfiable if and only if \u039eK |= \u2203x.\u22a5(x). By Lemmas 20 and 21, for each term w \u2208 \u2206I , we have \u22a5(w) \u2208 I if and only if \u22a5(\u03b4(w)) \u2208 J . Consequently, K is unsatisfiable if and only if DK |= \u2203x.\u22a5(x).\nC Proofs of Lemmas 20 and 21 We prove Lemmas 20 and 21 in various stages. To start, we next show that mapping \u03b4 satisfies a slightly relaxed version of properties H1\u2013H4 from Lemma 20. Lemma 22. Mapping \u03b4 satisfies the following four properties for all terms w1 and w2 occurring in I , each individual a \u2208 NI , each role R \u2208 NR, and each concept C \u2208 NC \u222a {>,\u22a5}.\n(i) C(w1) \u2208 I implies that \u2016C(\u03b4(w1))\u2016J \u2208 J. (ii) R(w1, w2) \u2208 I implies that \u2016R(\u03b4(w1), \u03b4(w2))\u2016J \u2208 J.\n(iii) R(w1, w2) \u2208 I and w is of the form fA1P,A(w1) imply that \u2016dR(\u03b4(w1), \u03b4(w2))\u2016J \u2208 J . (iv) w1 a \u2208 I implies that \u2016\u03b4(w1)\u2016J = \u2016a\u2016J .\nProof. Let I0, I1, . . . be the chase for \u039eK w.r.t. > used to construct I . We show by induction on this sequence that each In satisfies the properties.\nBase case. Consider chase instance I0. By the definition, I0 contains only ground atoms constructed using the predicates in NC \u222a {>,\u22a5, ind} \u222aNR and the individuals in NI . Therefore, for each term w occurring in I0, we have \u2016w\u2016I0 = w and w \u2208 NI , and so \u03b4(w) = w. Consider an arbitrary atom \u03c6 \u2208 I0. By the definition of DK, \u03c6 is an atom in DK. Since J satisfies all ground atoms in DK, we have \u2016\u03c6\u2016J \u2208 J , so properties (i)\u2013(iv) hold.\nInductive step. Consider an arbitrary n \u2208 N and assume that In satisfies properties (i)\u2013(iv). By considering each rule in \u039eK, we assume that the rule is applicable to In, and we show that the properties hold for all fresh atoms in the resulting instance.\n(Datalog Rule) Consider a datalog rule \u03d5(~x, ~y)\u2192 \u03c8(~x) in \u039eK, and assume that a substitution \u03c3 with dom(\u03c3) = ~x \u222a ~y exists such that \u03c3(\u03d5) \u2286 In. Let \u03c3\u2032 be the substitution such that \u03c3\u2032(x) = \u03b4(\u03c3(x)) for each variable x \u2208 ~x \u222a ~y. By the inductive hypothesis, we have \u2016\u03c3\u2032(\u03c8)\u2016J \u2286 J . Since \u03d5(~x, ~y)\u2192 \u03c8(~x) \u2208 DK and no rule is applicable to J , we have \u2016\u03c3\u2032(\u03c8)\u2016J \u2286 J .\n(Existential Rule) Consider A1(x)\u2192 \u2203z.R(x, z) \u2227A(z) in \u039eK, assume that A1(w1) \u2208 In, and let w2 = \u2016fA1R,A(w1)\u2016In . By the inductive hypothesis, \u2016A1(\u03b4(w1))\u2016J \u2208 J holds. Program DK containsA1(x)\u2192 R(x, oR,A) \u2227 dR(x, oR,A) \u2227A(oR,A) and no rule is applicable to J , so \u2016R(\u03b4(w1), oR,A) \u2227 dR(\u03b4(w1), oR,A) \u2227A(oR,A)\u2016J \u2286 J holds. We distinguish two cases.\n\u2022 w2 = fA1R,A(w1). Then, \u03b4(w2) = oR,A, and so \u2016oR,A\u2016J = \u2016\u03b4(w2)\u2016J . \u2022 w2 6= fA1R,A(w1). By the form of equality rules in \u039eK and due to w2 = \u2016f A1 R,A(w1)\u2016In , we have w2 \u2208 NI . Then, terms\nu0, . . . , un with u0 = fA1R,A(w1) and un = w2 exist in In such that ui\u22121 ui \u2208 In for each i \u2208 [1, n]. By the inductive hypothesis, we have \u2016\u03b4(fA1R,A(w1))\u2016J = \u2016\u03b4(w2)\u2016J , and so \u2016oR,A\u2016J = \u2016\u03b4(w2)\u2016J .\nAs stated above, we have \u2016R(\u03b4(w1), oR,A) \u2227 dR(\u03b4(w1), oR,A) \u2227A(oR,A)\u2016J \u2286 J , so properties (i)\u2013(iii) are satisfied. (Equality Rule) Consider a rule A(x)\u2192 x \u2248 a in \u039eK and assume that A(w1) \u2208 In. As w1 \u2208 \u2206In , we have \u2016w1\u2016In = w1. Then let terms w and w\u2032 be such that {w,w\u2032} = {w1, \u2016a\u2016In} and w > w\u2032. By the inductive hypothesis, we either have \u2016A(\u03b4(w))\u2016J \u2208 J and \u2016\u03b4(w\u2032)\u2016J = \u2016a\u2016J , or \u2016A(\u03b4(w\u2032))\u2016J \u2208 J and \u2016\u03b4(w)\u2016J = \u2016a\u2016J . In either cases, since A(x)\u2192 x \u2248 a \u2208 DK and no rule is applicable to J , we have \u2016\u03b4(w)\u2016J = \u2016\u03b4(w\u2032)\u2016J , and property (iv) is satisfied. We next consider the atoms in In that get replaced by the application of this rule.\n\u2022 C(w) \u2208 In. By the inductive hypothesis, we have \u2016C(\u03b4(w))\u2016J \u2208 J ; thus \u2016C(\u03b4(w\u2032))\u2016J \u2208 J . \u2022 R(w,w) \u2208 In. By the inductive hypothesis, we have \u2016R(\u03b4(w), \u03b4(w))\u2016J \u2208 J ; thus \u2016R(\u03b4(w\u2032), \u03b4(w\u2032))\u2016J \u2208 J . \u2022 R(w,w2) \u2208 In. By the inductive hypothesis, we have \u2016R(\u03b4(w), \u03b4(w2))\u2016J \u2208 J ; thus \u2016R(\u03b4(w\u2032), \u03b4(w2))\u2016J \u2208 J . \u2022 R(w2, w) \u2208 In. By the inductive hypothesis, we have \u2016R(\u03b4(w2), \u03b4(w))\u2016J \u2208 J ; thus, \u2016R(\u03b4(w2), \u03b4(w\u2032))\u2016J \u2208 J .\nWe next show that J satisfies a slightly relaxed version of properties D1\u2013D7 from Lemma 21.\nLemma 23. Mapping \u03b4 satisfies the following properties for all terms w1 and w2 occurring in I , each individual a \u2208 NI , each role R \u2208 NR, and each concept C \u2208 NC \u222a {>,\u22a5}. (a) C(\u03b4(w1)) \u2208 J implies that \u2016C(w1)\u2016I \u2208 I. (b) SelfR(\u03b4(w1)) \u2208 J implies that \u2016R(w1, w1)\u2016I \u2208 I. (c) R(\u03b4(w1), \u03b4(w2)) \u2208 J and \u03b4(w2) \u2208 NI imply that \u2016R(w1, w2)\u2016I \u2208 I. (d) R(\u03b4(w1), \u03b4(w2)) \u2208 J and \u03b4(w2) is of the form oP,A imply that \u2022 a term w\u20321 from I exists such that \u2016R(w\u20321, w2)\u2016I \u2208 I, and \u2022 a term w\u20322 from I exists such that \u03b4(w\u20322) = oP,A and \u2016R(w1, w\u20322)\u2016I \u2208 I. (e) dR(\u03b4(w1), \u03b4(w2)) \u2208 J and \u03b4(w2) is of the form oP,A imply that \u2022 a term w\u20323 from I of the form f A1 P,A(\u2016w1\u2016I) exists such that \u2016P (w1, w\u20323)\u2016I \u2208 I , and\n\u2022 P v\u2217T R. (f) \u03b4(w1) a \u2208 J implies that \u2016w1\u2016I = \u2016a\u2016I . (g) For each individual u occurring in J , a term w occurring in I exists such that \u03b4(w) = u.\nProof. Let J0, J1, . . . be the chase for DK used to construct J . We prove by induction on this sequence that each Jn satisfies the properties.\nBase case. Consider J0. By the definition, J0 does not contain assertions over . Moreover, DK and \u039eK contain the same ground atoms, all of which are constructed using the individuals fromNI and the predicates inNC \u222a {>,\u22a5, ind} \u222aNR. Finally, I satisfies all the ground atoms in \u039eK, so properties (a)\u2013(g) are satisfied.\nInductive step. Consider an arbitrary n \u2208 N and assume that Jn satisfies properties (a)\u2013(g). By considering each rule in DK, we assume that the rule is applicable to Jn, and we show that the properties hold for all fresh atoms in the resulting instance.\nConsider a rule of the form SelfP (x) \u2192 SelfR(x) in DK and assume that SelfP (\u03b4(w1)) \u2208 Jn. By the inductive hypothesis, we have \u2016SelfP (w1) \u2227 P (w1, w1)\u2016I \u2286 I . By the definition of program DK and \u039eK, we have P v R \u2208 T , and so rules SelfP (x)\u2192 SelfR(x) and P (x, y)\u2192 R(x, y) are in \u039eK. Since no rule is applicable to I , we have \u2016SelfR(w1) \u2227R(w1, w1)\u2016I \u2286 I .\nConsider a rule of the form \u03d5(x) \u2192 B(x) in DK with \u03d5 a conjunction of unary atoms over variable x and B a concept. Let \u03c3 and \u03c3\u2032 be substitutions such that \u03c3(x) = \u03b4(w1) and \u03c3\u2032(x) = w1. Assume that \u03c3(\u03d5) \u2286 Jn. By the inductive hypothesis, we have \u2016\u03c3\u2032(\u03d5)\u2016I \u2286 I . Since no rule is applicable to I , we have \u2016B(w1)\u2016I \u2208 I .\nConsider a rule of the formA(x)\u2192 x \u2248 a and assume thatA(\u03b4(w1)) \u2208 Jn. As \u03b4(w1) \u2208 \u2206Jn , we have \u2016\u03b4(w1)\u2016Jn = \u03b4(w1). Let w and w\u2032 be terms such that {\u03b4(w), \u03b4(w\u2032)} = {\u03b4(w1), \u2016a\u2016Jn} and \u03b4(w) > \u03b4(w\u2032). By the inductive hypothesis, we either have \u2016A(w)\u2016I \u2208 I and \u2016w\u2032\u2016I = \u2016a\u2016I , or \u2016A(w\u2032)\u2016I \u2208 I and \u2016w\u2016I = \u2016a\u2016I . In either cases, since no rule is applicable to I , we have \u2016w\u2016I = \u2016w\u2032\u2016I . We next consider the atoms in Jn that get replaced by the application of this rule.\n\u2022 SelfR(\u03b4(w)) \u2208 Jn. By the inductive hypothesis, we have \u2016SelfR(w) \u2227R(w,w)\u2016I \u2286 I; so \u2016SelfR(w\u2032) \u2227R(w\u2032, w\u2032)\u2016I \u2286 I . \u2022 C(\u03b4(w)) \u2208 Jn. By the inductive hypothesis, we have \u2016C(w)\u2016I \u2208 I , and so \u2016C(w\u2032)\u2016I \u2208 I . \u2022 R(\u03b4(w), \u03b4(w)) \u2208 Jn. We distinguish two cases.\n\u2013 \u03b4(w) \u2208 NI . By the inductive hypothesis, we have \u2016R(w,w)\u2016I \u2208 I , and so \u2016R(w\u2032, w\u2032)\u2016I \u2208 I . \u2013 \u03b4(w) is of the form oP,A. By the inductive hypothesis, a term w\u20322 exists such that \u03b4(w\u20322) = oP,A and \u2016R(w,w\u20322)\u2016I \u2208 I .\nSince \u03b4(w\u20322) = \u03b4(w), we have \u2016w\u20322\u2016I = \u2016w\u2032\u2016I , and so \u2016R(w\u2032, w\u2032)\u2016I \u2208 I . \u2022 R(\u03b4(w2), \u03b4(w)) \u2208 Jn. We distinguish two cases.\n\u2013 \u03b4(w) \u2208 NI . By the inductive hypothesis, we have \u2016R(w2, w)\u2016I \u2208 I , and so \u2016R(w2, w\u2032)\u2016I \u2208 I .\n\u2013 \u03b4(w) is of the form oP,A. By the inductive hypothesis, a term w\u20322 exists such that \u03b4(w\u20322) = oP,A and \u2016R(w2, w\u20322)\u2016I \u2208 I . Since \u03b4(w\u20322) = \u03b4(w), we have \u2016w\u20322\u2016I = \u2016w\u2032\u2016I , and so \u2016R(w2, w\u2032)\u2016I \u2208 I . \u2022 R(\u03b4(w), \u03b4(w2)) \u2208 Jn. We distinguish two cases. \u2013 \u03b4(w2) \u2208 NI . By the inductive hypothesis, \u2016R(w,w2)\u2016I \u2208 I , thus \u2016R(w\u2032, w2)\u2016I \u2208 I . \u2013 \u03b4(w2) is of the form oP,A. By the inductive hypothesis, a term w\u20322 with \u03b4(w\u20322) = oP,A exists such that \u2016R(w,w\u20322)\u2016I \u2208 I ,\nand so \u2016R(w\u2032, w\u20322)\u2016I \u2208 I . \u2022 dR(\u03b4(w), \u03b4(w2)) \u2208 Jn and \u03b4(w2) is of the form oP,A. Property (e) is satisfied by the inductive hypothesis.\nConsider a rule of the form R(x, y) \u2227 A1(y) \u2192 A(x) in DK and assume that {R(\u03b4(w1), \u03b4(w2)), A1(\u03b4(w2))} \u2286 Jn. We distinguish two cases.\n\u2022 \u03b4(w2) \u2208 NI . By the inductive hypothesis, we have \u2016R(w1, w2)\u2016I \u2286 I . \u2022 \u03b4(w2) = oP,A. By the inductive hypothesis, a term w\u20322 exists such that \u03b4(w\u20322) = oP,A and \u2016R(w1, w\u20322) \u2227A(w\u20322)\u2016I \u2208 I .\nIn either cases, since no rule is applicable to I , we have \u2016A(w1)\u2016I \u2208 I . Consider a rule T (x, y)\u2192 R(x, y) in DK and assume that T (\u03b4(w1), \u03b4(w2)) \u2208 Jn. We distinguish two cases.\n\u2022 \u03b4(w2) \u2208 NI . By the inductive hypothesis, \u2016T (w1, w2)\u2016I \u2208 I . As no rule is applicable to I , we have \u2016R(w1, w2)\u2016I \u2208 I . \u2022 \u03b4(w2) is of the form oP,A. By the inductive hypothesis, terms w\u20321 and w\u20322 exist such that \u03b4(w\u20322) = oP,A and \u2016T (w1, w\u20322) \u2227 T (w\u20321, w2)\u2016I \u2286 I . Since no rule is applicable to I , we have \u2016R(w1, w\u20322) \u2227R(w\u20321, w2)\u2016I \u2286 I .\nConsider a rule dT (x, y) \u2192 dR(x, y) in DK and assume that dT (\u03b4(w1), \u03b4(w2)) \u2208 Jn and \u03b4(w2) is of the form oP,A. By the inductive hypothesis, a term w3 of the form fA1P,A(\u2016w1\u2016I) exists such that \u2016P (w1, w\u20323)\u2016I \u2208 I and P v\u2217T T . By the definition of DK, we have T v R \u2208 T . Consequently, we have P v\u2217T R \u2208 T and property (e) holds.\nConsider a rule R(x, y)\u2192 A(y) in DK, and assume that R(\u03b4(w1), \u03b4(w2)) \u2208 Jn.\n\u2022 \u03b4(w2) \u2208 NI . By the inductive hypothesis, we have \u2016R(w1, w2)\u2016I \u2286 I . \u2022 \u03b4(w2) is of the form oP,A. By the inductive hypothesis, a term w\u20321 exists such that \u2016R(w\u20321, w2)\u2016I \u2208 I .\nIn either cases, since no rule is applicable to I , we have \u2016A(w2)\u2016I \u2208 I . Consider a ruleA1(x)\u2192 R(x, oR,A)\u2227dR(x, oR,A)\u2227A(oR,A) in DK, and assume thatA(\u03b4(w1)) \u2208 Jn. Letw2 be a term such that \u03b4(w2) = \u2016oR,A\u2016Jn . By the inductive hypothesis, we have \u2016A(w1)\u2016I \u2208 I . By the definition of DK, rule base \u039eK contains A1(x)\u2192 \u2203z.R(x, z) \u2227A(z). Let w\u20323 = f A1 R,A(\u2016w1\u2016I). Since no rule is applicable to I , we have \u2016R(w1, w\u20323) \u2227A(w\u20323)\u2016I \u2286 I . We distinguish two cases.\n\u2022 \u03b4(w2) 6= oR,A. By the form of equality rules occurring in DK, we have \u03b4(w2) \u2208 NI . Then individuals u0, . . . , un with u0 = oR,A and un = \u03b4(w2) exist such that ui\u22121 ui \u2208 Jn for each i \u2208 [1, n]. Moreover, given that \u03b4(w\u20323) = oR,A, by the inductive hypothesis, we have \u2016w\u20323\u2016I = \u2016w2\u2016I . Hence, we have \u2016R(w1, w2) \u2227A(w2)\u2016I \u2286 I . By the inductive hypothesis, property (g) is satisfied.\n\u2022 \u03b4(w2) = oR,A. Then w2 is of the form fA2R,A(w\u2032). Because such term can only be introduced in I by the application of a rule of the form A2(x)\u2192 \u2203z.R(x, z) \u2227A(z), a term w\u20321 must exist such that \u2016R(w\u20321, w2) \u2227A(w2)\u2016I \u2286 I . As stated above, we also have \u2016R(w1, w\u20323)\u2016I \u2208 I . By the reflexivity of v\u2217T , we also have R v\u2217T R, so properties (d) and (e) are satisfied. As \u03b4(w\u20323) = oR,A, property (g) is also satisfied.\nConsider a rule R(x, y) \u2227R(y, z)\u2192 R(x, z), and assume {R(\u03b4(w1), \u03b4(w2)), R(\u03b4(w3), \u03b4(w4))} \u2286 Jn and \u03b4(w2) = \u03b4(w3). It follows that R(\u03b4(w2), \u03b4(w4)) \u2208 Jn. We distinguish four cases.\n\u2022 \u03b4(w2) \u2208 NI and \u03b4(w4) \u2208 NI . By the inductive hypothesis, we have \u2016R(w1, w2) \u2227R(w2, w4)\u2016I \u2208 I . Since no rule is applicable to I , we have \u2016R(w1, w4)\u2016I \u2208 I . \u2022 \u03b4(w2) is of the form oP,A and \u03b4(w4) \u2208 NI . By the inductive hypothesis, a term w\u20322 exists such that \u03b4(w\u20322) = oP,A and \u2016R(w1, w\u20322)\u2016I \u2208 I . Due to \u03b4(w\u20322) = \u03b4(w2), we have \u2016R(\u03b4(w\u20322), \u03b4(w4))\u2016Jn \u2208 Jn. By the inductive hypothesis, we have \u2016R(w\u20322, w4)\u2016I \u2208 I . Since no rule is applicable to I , we have \u2016R(w1, w4)\u2016I \u2208 I . \u2022 \u03b4(w2) \u2208 NI and \u03b4(w4) is of the form oR,B . By the inductive hypothesis, we have \u2016R(w1, w2)\u2016I \u2208 I and terms w\u20322 and w\u20324 exist such that \u03b4(w\u20324) = oR,B and \u2016R(w\u20322, w4) \u2227R(w2, w\u20324)\u2016I \u2286 I . As no rule is applicable to I , we have \u2016R(w1, w\u20324)\u2016I \u2208 I . \u2022 \u03b4(w2) is of the form oP,A and \u03b4(w4) is of the form oR,B . By the inductive hypothesis, a termw\u20322 exists such that \u03b4(w\u20322) = oP,A and \u2016R(w1, w\u20322)\u2016I \u2208 I . Due to \u03b4(w\u20322) = \u03b4(w2), we have \u2016R(\u03b4(w\u20322), \u03b4(w4))\u2016Jn \u2208 Jn. By the inductive hypothesis, terms u\u20322 and w \u2032 4 exist such that \u03b4(w \u2032 4) = oR,B and \u2016R(u\u20322, w4) \u2227R(w\u20322, w\u20324)\u2016I \u2286 I . As no rule is applicable to I , we have\n\u2016R(w1, w\u20324)\u2016I \u2208 I .\nConsider a rule A(x)\u2192 R(x, x)\u2227 SelfR(x), assume A(\u03b4(w1)) \u2208 Jn, and let w2 be a term such that \u03b4(w2) = \u03b4(w1). By the inductive hypothesis, we have \u2016A(w1)\u2227A(w2)\u2016I \u2286 I . Since no rule is applicable to I , we have \u2016R(w1, w1) \u2227 SelfR(w1)\u2016I \u2286 I and \u2016R(w2, w2) \u2227 SelfR(w2)\u2016I \u2286 I , so property (a) holds. We distinguish two cases.\n\u2022 \u03b4(w2) \u2208 NI . Then individuals u0, . . . , un with u0 = \u03b4(w1) and un = \u03b4(w2) exist such that ui\u22121 ui \u2208 Jn for each i \u2208 [1, n]. By the inductive hypothesis, we have, \u2016w1\u2016I = \u2016w2\u2016I ; thus \u2016R(w1, w2)\u2016I \u2208 I .\n\u2022 \u03b4(w2) is of the form oP,A. Thus, \u03b4(w1) = oP,A. As stated above, we have \u2016R(w1, w1) \u2227R(w2, w2)\u2016I \u2286 I .\nConsider a rule R(x, x) \u2227 ind(x) \u2192 SelfR(x). Assume that {R(\u03b4(w1), \u03b4(w2)), ind(\u03b4(w2))} \u2286 Jn and \u03b4(w2) = \u03b4(w1). By the definition of clsK and since no rule in DT derives atoms over ind, we have that \u03b4(w2) \u2208 NI . By the inductive hypothesis, we then have \u2016R(w1, w2) \u2227 ind(w2)\u2016I \u2286 I . Since \u03b4 is the identity on NI and \u03b4(w1) = \u03b4(w2), we have w1 = w2, and so \u2016R(w1, w1) \u2227R(w2, w2)\u2016I \u2286 I . As no rule is applicable to I , we have \u2016SelfR(w1) \u2227 SelfR(w2)\u2016I \u2286 I .\nLemmas 20 and 21 follow immediately from Lemmas 22 and 23, and the following result.\nLemma 24. For each term w occurring in I and each individual a \u2208 NI , the following two properties hold."}, {"heading": "E1. \u2016w\u2016I = a if and only if \u2016\u03b4(w)\u2016J = a.", "text": ""}, {"heading": "E2. \u2016w\u2016I = w if and only if \u2016\u03b4(w)\u2016J = \u03b4(w).", "text": "Proof. By the definition of \u039eK and DK, each equality rule occurring in these rule bases is of the form A(x) \u2192 x \u2248 a with a \u2208 NI . Consequently, for all terms u and u\u2032 such that u u\u2032 \u2208 I \u222a J , we have u\u2032 \u2208 NI . Let w be an arbitrary term occurring in I , and let a \u2208 NI be an arbitrary individual.\nWe first prove E1. (\u21d2) Assume that \u2016w\u2016I = a. Then terms w0, . . . , wn with w0 = w and wn = a exist such that for each i \u2208 [1, n] we have wi \u2208 NI and wi\u22121 wi \u2208 I . By Lemma 22, we have \u2016\u03b4(w0)\u2016J = \u2016\u03b4(wn)\u2016J ; that is, \u2016\u03b4(w)\u2016J = \u2016a\u2016J . We show that \u2016a\u2016J = a. Assume the opposite; hence, an individual b exists such that a b \u2208 J and a > b. By Lemma 23, we have \u2016a\u2016I = \u2016b\u2016I . Since a > b, we have \u2016w\u2016I = b, which is a contradiction. (\u21d0) Assume that \u2016\u03b4(w)\u2016I = a. Then individuals u0, . . . , un with u0 = \u03b4(w) and un = a exist such that for each i \u2208 [1, n] we have ui \u2208 NI and ui\u22121 ui \u2208 I . By Lemma 23, we have \u2016w\u2016I = \u2016a\u2016I . We show that \u2016a\u2016I = a. Assume the opposite; hence, an individual b exists such that a b \u2208 I and a > b. By Lemma 22, we have \u2016a\u2016J = \u2016b\u2016J . Since a > b, we have \u2016\u03b4(w)\u2016I = b, which is a contradiction.\nNext, we prove property E2 by contraposition. (\u21d2) Assume that \u2016\u03b4(w)\u2016J 6= \u03b4(w); hence, an individual b \u2208 NI exists such that \u03b4(w) 6= b and \u2016\u03b4(w)\u2016J = b. By the definition of \u03b4, we have w 6= b. By property E1, we have \u2016w\u2016I = b, as required. (\u21d0) Assume that \u2016w\u2016I 6= w; hence, an individual b \u2208 NI exists such that w 6= b and \u2016w\u2016I = b. By the definition of \u03b4, we have \u03b4(w) 6= b. By property E1, we have \u2016\u03b4(w)\u2016I = b, as required.\nD Proof of Theorem 12 Let KB K = \u3008T ,A\u3009 be a satisfiable ELHOs KB, let \u039eK, and DK be the rule base and the datalog program associated with K, respectively; moreover, let I and J be universal interpretations of \u039eK and DK, respectively. To prove Theorem 12, we first show that our function is sound, after which we show that it is also complete."}, {"heading": "D.1 Soundness", "text": "Let q\u2032 = \u2203~y. \u03c8(~x, ~y) be a CQ, let \u03c4 \u2032 be a candidate answer to q\u2032 over DK, and let \u03c0\u2032 = \u03c4 \u2032|~x. Assume that the two following conditions hold:\n1. for each x \u2208 ~x, we have \u03c4 \u2032(x) \u2208 NI , and 2. a nondeterministic computation exists such that function isSound(q,DK, \u03c4) returns t.\nBy the definition of candidate answer, we have dom(\u03c4 \u2032) = NV (q\u2032), each element of rng(\u03c4 \u2032) is an individual occurring in DK, and DK |= \u03c4 \u2032(q\u2032). Since \u03c4 \u2032|~x \u2286 NI , we have that \u03c0\u2032(x) \u2208 NI for each x \u2208 ~x. In the rest of this proof we show that \u039eK |= \u03c0\u2032(q\u2032).\nLet CQ q and substitution \u03c4 be as specified in Definition 4; and let relation \u223c, CQ q\u223c and the connection graph cg = \u3008V,Es, Et\u3009 be as determined by isSound. By the construction of q and \u03c4 , we have DK |= \u03c4(q) and \u03c4(q) \u2286 J . We next construct a substitution \u03c0 with dom(\u03c0) = NV (q) such that \u03c0(q) \u2286 I and the following property holds. (1) For each term t \u2208 NT (q), we have \u03b4(\u03c0(t)) = \u03c4(t). Later, we will show that property (1) and \u03c0(q) \u2286 I imply that \u039eK |= \u03c0\u2032(q\u2032), thus proving the soundness claim.\nTo construct substitution \u03c0, we proceed in two steps: we first show how to construct \u03c0 in case our algorithm returns t in step 2; after which we show how to construct \u03c0 in case our algorithm returns t in step 18.\nCase 1: isSound returns t in step 2 Assume that isSound(q,DK, \u03c4) returns t in step 2. By condition 2 in Definition 8, directed graph \u3008V,Es\u3009 is acyclic; we next show that \u3008V,Es\u3009 is a forest, after which we will show how to construct substitution \u03c0 by structural induction on this forest.\nLemma 25. Directed graph \u3008V,Es\u3009 is a forest.\nProof. Since directed graph \u3008V,Es\u3009 is acyclic, we are left to show that for each v \u2208 V , there exists at most one vertex v\u2032 such that \u3008v\u2032, v\u3009 \u2208 Es. Assume the opposite; hence, vertices v1, v2, and v exist in V such that v1 6= v2 and {\u3008v1, v\u3009, \u3008v2, v\u3009} \u2286 Es. Then, roles R and P exist such that R(v1, v) and P (v2, v) are aux-simple atoms in q\u223c and \u03c4(v) \u2208 auxDK . By the definition of \u223c, we have v1 \u223c v2; and, by the construction of q\u223c, we have v1 = v2, which is a contradiction.\nWe next construct substitution \u03c0 with dom(\u03c0) = NV (q) that will satisfy (1) and the two following properties:\n(2) for all terms s, t \u2208 NT (q) such that s \u223c t, we have \u03c0(s) = \u03c0(t), and (3) for each \u3008v\u2032, v\u3009 \u2208 Es with \u03c4(v) of the form oP,A, we have P (\u03c0(v\u2032), \u03c0(v)) \u2208 I . By construction of V , we have that V = NT (q\u223c). Next, we define \u03c0 by structural induction on the forest \u3008V,Es\u3009 as follows.\nBase case. Consider a root v \u2208 V . Fix an arbitrary term w \u2208 \u2206I such that \u03b4(w) = \u03c4(v). For each term s \u2208 NT (q) with s \u223c v, let \u03c0(s) = w. By condition 1 in Definition 8, we have \u03c4(s) = \u03c4(v). Thus property (1) and (2) hold.\nInductive step. Consider an arbitrary \u3008v\u2032, v\u3009 \u2208 Es with \u03c0(v\u2032) defined and \u03c0(v) undefined. By the definition of Es, a role R \u2208 NR exists such that R(v\u2032, v) is an aux-simple atom in q\u223c. Hence, we have dR(\u03c4(v\u2032), \u03c4(v)) \u2208 J and \u03c4(v) is of the form oP,A. Since by property (1) we have \u03b4(\u03c0(v\u2032)) = \u03c4(v\u2032), and due to property D5 in Lemma 21, a term w \u2208 \u2206I exists such that P (\u03c0(v\u2032), w) \u2208 I . Then, for each term s \u2208 NT (q) with s \u223c v, let \u03c0(s) = w. Properties (2) and (3) immediately hold. By condition 2 in Definition 8, we have \u03c4(s) = \u03c4(v), and so property (1) holds.\nWe next show that substitution \u03c0 is such that \u03c0(q) \u2286 I . Lemma 26. Substitution \u03c0 satisfies \u03c0(q) \u2286 I .\nProof. Recall that \u03c4(q) \u2286 J and isSound(q,DK, \u03c4) returns t in step 2; we next show that \u03c0(q) \u2286 I . Consider an atom A(s) in q. By assumption, we have A(\u03c4(s)) \u2208 J . By Lemma 21, for each w \u2208 \u2206I with \u03b4(w) = \u03c4(s), we have A(w) \u2208 I . By property (1) in the definition of \u03c0, we have A(\u03c0(s)) \u2208 I . Consider an atom R(s\u2032, t\u2032) in q. By the definition of q\u223c, an atom R(s, t) occurs in q\u223c such that s\u2032 \u223c s and t\u2032 \u223c t. By condition 1 in the definition of isDSound, we have \u03c4(s\u2032) = \u03c4(s) and \u03c4(t\u2032) = \u03c4(t). By assumption, we have R(\u03c4(s\u2032), \u03c4(t\u2032)) \u2208 J and so R(\u03c4(s), \u03c4(t)) \u2208 J . By property (2) in the definition of \u03c0, it suffices to show that R(\u03c0(s), \u03c0(t)) \u2208 I . Given that our algorithm returns t in step 2, exactly one of the following holds. R(s, t) is such that \u03c4(t) \u2208 NI . By Lemma 21, for all terms w\u2032, w \u2208 \u2206I with \u03b4(w\u2032) = \u03c4(s) and \u03b4(w) = \u03c4(t), we have R(w\u2032, w) \u2208 I . By property (1) in the definition of \u03c0, we have R(\u03c0(s), \u03c0(t)) \u2208 I . R(s, t) is such that s = t, \u03c4(t) \u2208 auxDK , and SelfR(\u03c4(t)) \u2208 J . By Lemma 21, for each term w \u2208 \u2206I with \u03b4(w) = \u03c4(t), we have R(w,w) \u2208 I . By property (1) in the definition of \u03c0, we have R(\u03c0(t), \u03c0(t)) \u2208 I . R(s, t) is aux-simple. It follows that \u03c4(t) is of the form oP,A and dR(\u03c4(s), \u03c4(t)) \u2208 J . By property D5 of Lemma 21, we have P v\u2217T R. By the definition of Es, we have \u3008s, t\u3009 \u2208 Es. By property (3) in the definition of \u03c0, we have P (\u03c0(s), \u03c0(t)) \u2208 I . Since no rule is applicable to I and P v\u2217T R, we have R(\u03c0(s), \u03c0(t)) \u2208 I .\nCase 2: isSound returns t in step 18 We are left to show that, if our function returns t in step 18, then a substitution \u03c0 with dom(\u03c0) = NV (q) exists such that \u03c0(q) \u2286 I and property (1) is satisfied.\nAssume that isSound(q,DK, \u03c4) returns t in step 18. Let variable renaming \u03c3, skeleton S = \u3008V, E\u3009, and function L be as determined by isSound. By the definition of a skeleton for q and \u03c3, graph S is a forest rooted in V \u2229 indDK . We next define substitution \u03c0 that will satisfy property (1) as well as the following properties:\n(2) for all terms s, t \u2208 NT (q) such that s \u223c t or \u03c3(s) = t, we have \u03c0(s) = \u03c0(t), (3) for each \u3008v\u2032, v\u3009 \u2208 E and each role P \u2208 L(v\u2032, v), we have P (\u03c0(v\u2032), \u03c0(v)) \u2208 I . By the definition of V , we have V = NT (\u03c3(q\u223c)). Next, we define \u03c0 by structural induction on the forest S as follows.\nBase case. Consider a root v \u2208 V \u2229 indDK . Given that each element in rng(\u03c3) is a variable, no term s \u2208 NT (q) exists such that \u03c3(s) = v. Then, for each term s \u2208 NT (q) with s \u223c v, let \u03c0(s) = v. By condition 1 in Definition 8, we have \u03c4(s) = \u03c4(v). Thus, properties (1) and (2) are satisfied.\nInductive step. Consider \u3008v\u2032, v\u3009 \u2208 E such that \u03c0(v\u2032) has been defined, but \u03c0(v) has not; and let u0 = \u03c4(v\u2032) and w0 = \u03c0(v\u2032). By the definition of exist, individuals {u1, . . . , un} \u2286 auxDK with n > 0 and un = \u03c4(v) exist such that for each i \u2208 [1, n], we have ui is of the form oTi,Ai , and dPj (ui\u22121, ui) \u2208 J for each Pj \u2208 L(v\u2032, v). Then, for each i \u2208 [1, n], by property D5 of Lemma 21, a term wi of the form fBiTi,Ai(wi\u22121) exists in \u2206 I such that Ti(wi\u22121, wi) \u2208 I; moreover, Ti v\u2217T Pj for each role\nPj \u2208 L(v\u2032, v). Since no rule is applicable to I and Ti v\u2217T Pj , we have Pj(wi\u22121, wi) \u2208 I . For each term s \u2208 NT (q) such that s \u223c v or \u03c3(s) = v, let \u03c0(s) = wn. Property (2) is clearly satisfied. Property (1) is also satisfied, since \u03c3(s) = v implies that \u03c4(s) = \u03c4(v), by construction of \u03c3, and s \u223c v implies that \u03c4(s) = \u03c4(v), by condition 1 in Definition 8. For property (3) we distinguish two cases.\n\u2022 A role P \u2208 L(v\u2032, v) exists such that trans(P ) 6\u2208 T . By the definition of function exist, we then have n = 1. Consequently, \u03c0(v\u2032) = w0 and \u03c0(v) = w1; thus, Pj(\u03c0(v\u2032), \u03c0(v)) \u2208 I for each Pj \u2208 L(v\u2032, v).\n\u2022 For each Pj \u2208 L(v\u2032, v) we have trans(Pj) \u2208 T . Since no rule is applicable and Pj(wi\u22121, wi) \u2208 I for each i \u2208 [1, n], we have Pj(w0, wn) \u2208 I; that is, Pj(\u03c0(v\u2032), \u03c0(v)) \u2208 I .\nWe next show that substitution \u03c0 is such that \u03c0(q) \u2286 I . Lemma 27. Substitution \u03c0 satisfies \u03c0(q) \u2286 I .\nProof. We show that \u03c0(q) \u2286 I by considering the various atoms occurring in q. Consider an atom A(s) in q. By assumption, we have A(\u03c4(s)) \u2208 J . By Lemma 21, for each w \u2208 \u2206I with \u03b4(w) = \u03c4(s), we have A(w) \u2208 I . By property (1) in the definition of \u03c0, we have A(\u03c0(s)) \u2208 I . Consider an atom R(s\u2032, t\u2032) in q. By assumption, we have R(\u03c4(s\u2032), \u03c4(t\u2032)) \u2208 J . By the definition of q\u223c, terms s\u2032\u2032 and t\u2032\u2032 occur in q\u223c such that s\u2032 \u223c s\u2032\u2032, t\u2032 \u223c t\u2032\u2032, and R(s\u2032\u2032, t\u2032\u2032) is an atom in q\u223c. By condition 1 in the definition of isDSound, we have \u03c4(s\u2032) = \u03c4(s\u2032\u2032) and \u03c4(t\u2032) = \u03c4(t\u2032\u2032). Therefore, R(\u03c4(s\u2032\u2032), \u03c4(t\u2032\u2032)) \u2208 J . By the definition of \u03c3(q\u223c), terms s and t occur in \u03c3(q\u223c) such that \u03c3(s\u2032\u2032) = s, \u03c3(t\u2032\u2032) = t, and R(s, t) is an atom in \u03c3(q\u223c). By the definition of variable renaming, we have \u03c4(t\u2032\u2032) = \u03c4(t) and \u03c4(s\u2032\u2032) = \u03c4(s). Thus R(\u03c4(s), \u03c4(t)) \u2208 J . By property (2) in the definition of \u03c0, it suffices to show that R(\u03c0(s), \u03c0(t)) \u2208 I . Towards this goal, we consider four distinct cases.\nR(s, t) is such that \u03c4(t) \u2208 NI . By Lemmas 21, for all terms w\u2032, w \u2208 \u2206I with \u03b4(w\u2032) = \u03c4(s) and \u03b4(w) = \u03c4(t), we have R(w\u2032, w) \u2208 I . By property (1) in the definition of \u03c0, we have R(\u03c0(s), \u03c0(t)) \u2208 I . R(s, t) is such that s = t, \u03c4(t) \u2208 auxDK , and SelfR(\u03c4(t)) \u2208 J . By Lemma 21, for each term w \u2208 \u2206I with \u03b4(w) = \u03c4(t) , we have \u2016R(w,w)\u2016I \u2208 I . By property (1) in the definition of \u03c0, we have R(\u03c0(t), \u03c0(t)) \u2208 I . R(s, t) is aux-simple. By the definition of Es and E , we have \u3008s, t\u3009 \u2208 \u03c3(Es)\u2229 E , and R \u2208 L(s, t) by step 6. By property (3) in the definition of \u03c0, we have R(\u03c0(s), \u03c0(t)) \u2208 I . R(s, t) is neither good nor aux-simple. Let P and v0, . . . , vn be as determined in steps 8\u201315 when Algorithm 1 considers atom R(s, t). Then by step 8 we have P v\u2217T R. Furthermore, for each i \u2208 [1, n], we have P \u2208 L(vi\u22121, vi) by step 15; but then, by property (3) we have P (\u03c0(vi\u22121), \u03c0(vi)) \u2208 I . Next, we distinguish two cases.\n\u2022 s reaches t in E . If \u3008s, t\u3009 \u2208 E , then n = 1 and, by property (3) in the definition of \u03c0, we have P (\u03c0(s), \u03c0(t)) \u2208 I . Otherwise, we have trans(P ) \u2208 T and, since no rule is applicable to I , we have P (\u03c0(s), \u03c0(t)) \u2208 I . \u2022 s does not reach t in E . Then, we have trans(P ) \u2208 T , v0 = at, and P (\u03c4(s), v0) \u2208 J . As v0 \u2208 NI and \u03c0(v0) = v0, by Lemma\n21, we have P (\u03c0(s), \u03c0(v0)) \u2208 I . Due to trans(P ) \u2208 T and no rule is applicable to I , we have \u2016P (\u03c0(s), \u03c0(t))\u2016I \u2208 I .\nSince P v\u2217T R and no rule is applicable to I we have R(\u03c0(s), \u03c0(t)) \u2208 I .\nFinally, we prove the soundness claim.\nLemma 28. Substitution \u03c0\u2032 satisfies \u039eK |= \u03c0\u2032(q\u2032).\nProof. To prove the lemma, we show that a substitution \u03c0\u2032\u2217 with dom(\u03c0 \u2032 \u2217) = NV (q \u2032) exists such that \u03c0\u2032 \u2286 \u03c0\u2032\u2217 and \u2016\u03c0\u2032\u2217(q\u2032)\u2016I \u2286 I . By the construction of q and \u03c4 , we have DK |= \u03c4(q) and \u03c4(q) \u2286 J . Let \u03c0 be the substitution specified just above Lemma 26, if isSound(q,DK, \u03c4) returns t in step 2, otherwise, let \u03c0 be the substitution specified just above Lemma 27. By Lemmas 26 and 27, we have \u03c0(q) \u2286 I; furthermore, \u03c0 satisfies property (1). Let \u03b3 be the mapping from NT (q\u2032) to NT (q) such that q is obtained by replacing each t \u2208 NT (q\u2032) with \u03b3(t).\nLet \u03c0\u2032\u2217 be the substitution such that for each z \u2208 NV (q\u2032), we have \u03c0\u2032\u2217(z) = \u03c0(z), if \u03b3(z) = z; otherwise, we define \u03c0\u2032\u2217(z) as an arbitrary term w occurring in I such that \u03b4(w) = \u03c4 \u2032(z). Since \u03c0 satisfies property (1) and by construction \u03c0\u2032\u2217, for each term t \u2208 NT (q\u2032), we have \u03b4(\u03c0\u2032\u2217(t)) = \u03c4 \u2032(t). Since \u03c4 \u2032(x) \u2208 NI for each x \u2208 ~x and given that \u03b4 is the identity on NI , we have \u03c0\u2032 \u2286 \u03c0\u2032\u2217. To prove that \u2016\u03c0\u2032\u2217(q\u2032)\u2016I \u2286 I , we show that for each term t \u2208 NT (q\u2032), we have \u2016\u03c0\u2032\u2217(t)\u2016I = \u03c0(\u03b3(t)). The property clearly holds for each term t \u2208 NT (q\u2032) such that \u03b3(t) = t. Then consider an arbitrary term t \u2208 NT (q\u2032) such that \u03b3(t) 6= t. By the definition of \u03b3, we have \u03b3(t) = \u2016\u03c4 \u2032(t)\u2016J and \u03b3(t) \u2208 NI . By Lemma 24, for each term w occurring in I with \u03b4(w) = \u03c4 \u2032(t), we have \u2016w\u2016I = \u03b3(t). By the definition of \u03c0\u2032\u2217, we then have \u2016\u03c0\u2032\u2217(t)\u2016I = \u03b3(t) = \u03c0(\u03b3(t))."}, {"heading": "D.2 Completeness", "text": "To prove the completeness claim, we start by establishing two properties of the universal interpretation I . To this end, we start with a couple of definitions.\nLet \u227a be the smallest irreflexive and transitive relation on the set of terms occurring in I such that w \u227a fA1R,A(w) for each term occurring in I , each role R, and all concepts A,A1 \u2208 {>} \u222aNC . Furthermore, an atom R(w\u2032, w) \u2208 I is a self-loop if w\u2032 = w and SelfR(w) \u2208 I . Lemma 29. Interpretation I satisfies the following properties for each role R \u2208 NR and all terms w\u2032, w \u2208 \u2206I with w 6\u2208 NI ."}, {"heading": "1. R(w\u2032, w) \u2208 I is not a self-loop and R is simple imply that w is of the form fA1T,A(w\u2032).", "text": "2. R(w\u2032, w) \u2208 I is not a self-loop implies that a role P \u2208 NR and terms w0, . . . , wm from \u2206I with wm = w exist where\n2a. if m > 1 or w\u2032 6\u227a w, then trans(P ) \u2208 T , 2b. P v\u2217T R, 2c. w0 = w\u2032, if w\u2032 \u227a w; otherwise, w0 is the unique individual a \u2208 NI with a \u227a w, and P (w\u2032, w0) \u2208 I , and 2d. for each i \u2208 [1,m], wi is of the form fBiSi,Ai(wi\u22121) and P (wi\u22121, wi) \u2208 I .\nProof. Let I0, I1, . . . be the chase sequence used to construct I . Please observe that, by virtue of the pruning step in the application of equality rules, for each term w occurring in I of the form w = fA1T,A(w\n\u2032) we either have \u2016w\u2016I = a for some individual a \u2208 NI , or \u2016w\u2032\u2016I = w\u2032 and \u2016w\u2016I = w. Then to prove the lemma, we show by induction on this sequence that each In satisfies the following properties for each role R \u2208 NR and all terms w\u2032 and w occurring in I such that w 6\u2208 NI .\nA. R(w\u2032, w) \u2208 In is not a self-loop and R is simple imply that w is of the form fA1T,A(w\u2032). B. R(w\u2032, w) \u2208 In is not a self-loop implies that a role P \u2208 NR and terms w0, . . . , wm from I with wm = w exist where\n(i) if m > 1 or w\u2032 6\u227a w, then trans(P ) \u2208 T , (ii) P v\u2217T R,\n(iii) w0 = w\u2032, if w\u2032 \u227a w; otherwise, w0 is the unique individual a \u2208 NI with a \u227a w, and \u2016P (w\u2032, w0)\u2016I \u2208 I , and (iv) for each i \u2208 [1,m], wi is of the form fB1Si,Ai(wi\u22121) and \u2016P (wi\u22121, wi)\u2016I \u2208 I .\nBase case. Consider I0. All atoms in I0 are over the individuals in NI , so properties A and B hold vacuously. Inductive step. Consider an arbitrary n \u2208 N and assume that In satisfies properties A and B. By considering each rule in \u039eK that derives binary atoms, we assume that the rule is applicable to In, and we show that the properties hold for all fresh atoms in the resulting instance.\nConsider a rule A1(x) \u2192 \u2203z.R(x, z) \u2227 A(z), and assume that A1(w\u2032) \u2208 In. Furthermore, let w = fA1R,A(w\u2032), and assume that w\u2032 and w occur in I . Clearly, if \u2016w\u2016In = a for some individual a \u2208 NI , then the properties hold vacuously; hence we consider the case in which \u2016w\u2016In = w. Please note that w\u2032 \u227a w. Since w\u2032 occurs in I , we have \u2016A1(w\u2032)\u2016I \u2208 I . As no rule is applicable to I , we have \u2016R(w\u2032, w)\u2016I \u2208 I . Property A holds, and property B is satisfied for role R and terms w0 = w\u2032 and w1 = w.\nConsider a rule A(x) \u2192 x \u2248 a, and assume that A(u) \u2208 In. Let u\u2032 and w\u2032 be terms occurring in I such that {u\u2032, w\u2032} = {\u2016u\u2016In , \u2016a\u2016In} and u\u2032 > w\u2032. By the definition of >, we have w\u2032 \u2208 NI . Since u occurs in I , we have \u2016A(u)\u2016I \u2208 I . Since no rule is applicable to I , we have \u2016u\u2032\u2016I = \u2016w\u2032\u2016I . We next show that the properties are preserved for all atoms in In that get replaced by the application of this rule. Please observe that the properties hold vacuously for each atom R(w, u\u2032) \u2208 In and each atom R(u\u2032, b) \u2208 In with b \u2208 NI . Then consider an atom R(u\u2032, w) \u2208 In with w 6= u\u2032 and w 6\u2208 NI . Then R(u\u2032, w) \u2208 In is not a self-loop. Since this atom is replaced, not removed, by the application of the rule, we must have that u\u2032 6\u227a w. Let c \u2208 NI be the unique individual such that c \u227a w. By the inductive hypothesis, a role P \u2208 NR and terms w0, . . . , wm with w0 = c and wm = w exist satisfying properties (i)\u2013(iv). Then \u2016P (u\u2032, w0)\u2016I \u2208 I , trans(P ) \u2208 T , and P v\u2217T R. Role R is not simple, thus property A holds. We next distinguish two cases.\n\u2022 w\u2032 \u227a w. Since w\u2032 \u2208 NI , we have w\u2032 = w0. Then role P and terms w0, . . . , wm satisfy properties (i)\u2013(iv). \u2022 w\u2032 6\u227a w. As stated above, we have trans(P ) \u2208 T and \u2016P (u\u2032, w0)\u2016I \u2208 I . Thus, \u2016P (w\u2032, w0)\u2016I \u2208 I , and role P and terms w0, . . . , wm satisfy properties (i)\u2013(iv).\nConsider a rule T (x, y) \u2192 R(x, y), and assume that T (w\u2032, w) \u2208 In is not a self-loop. For property A, assume that R is a simple role. Hence, T is a simple role as well, and property A follows from the inductive hypothesis. For property B, by the inductive hypothesis, a role P and terms w0, . . . , wm with wm = w exist satisfying (i)\u2013(iv). By the definition of \u039eK, we have T v R \u2208 T . Since P v\u2217T T , we then have P v\u2217T R, and properties (i)\u2013(iv) are satisfied.\nConsider a rule R(x, y) \u2227 R(y, z) \u2192 R(x, z), and assume that {R(w\u2032, w\u2032\u2032), R(w\u2032\u2032, w)} \u2286 In. Property A holds vacuously, as R is not simple. For property B, we distinguish four cases.\n\u2022 w\u2032 \u227a w\u2032\u2032 and w\u2032\u2032 \u227a w. By the inductive hypothesis, a role P1 and terms w10, . . . , w1m1 with w 1 0 = w \u2032 and w1m1 = w \u2032\u2032\nexist satisfying properties (i)\u2013(iv); moreover, a role P2 and terms w20, . . . , w 2 m2 with w 2 0 = w \u2032\u2032 and w2m2 = w exist satisfying properties (i)\u2013(iv). Then, for j = 1, 2, we have Pj v\u2217T R. Furthermore, for each i \u2208 [1,mj ], we have \u2016Pj(wji\u22121, w j i )\u2016I \u2208 I . As no rule is applicable to I , we have \u2016R(w j i\u22121, w j i )\u2016I \u2208 I . Then, property B is satisfied for role R and terms w10, . . . , w 1 m1 , w 2 1, . . . w 2 m2 .\n\u2022 w\u2032 \u227a w\u2032\u2032 and w\u2032\u2032 6\u227a w. By the inductive hypothesis, a role P1 and terms w10, . . . , w1m1 with w 1 0 = w \u2032 and w1m1 = w \u2032\u2032 exist\nsatisfying properties (i)\u2013(iv). Let b \u2208 NI be the unique individual such that b \u227a w. Sincew 6\u2208 NI , by the inductive hypothesis, a role P2 and terms w20, . . . , w 2 m2 with w 2 0 = b and w 2 m2 = w exist satisfying properties (i)\u2013(iv). By property (iii), we have \u2016P2(w1m1 , w 2 0)\u2016I \u2208 I . Then, for j = 1, 2, we have Pj v\u2217T R. Moreover, for each i \u2208 [1,mj ], we have \u2016Pj(w j i\u22121, w j i )\u2016I \u2208 I . As no rule is applicable to I , we have \u2016R(wji\u22121, w j i )\u2016I \u2208 I and \u2016R(w1m1 , w 2 0)\u2016I \u2208 I . Since trans(R) \u2208 T and no rule is\napplicable to I , we have \u2016R(w10, w20)\u2016I \u2208 I . Property B is satisfied for role R and terms w20, . . . , w2m2 . \u2022 w\u2032 6\u227a w\u2032\u2032 and w\u2032\u2032 \u227a w. By the inductive hypothesis, a role P2 and terms w20, . . . , w2m2 with w 2 0 = w\n\u2032\u2032 and w2m2 = w exist satisfying properties (i)\u2013(iv). Then, we have P2 v\u2217T R. Furthermore, for each i \u2208 [1,m2], we have \u2016P2(w2i\u22121, w2i )\u2016I \u2208 I . As no rule is applicable to I , we have \u2016R(w2i\u22121, w2i )\u2016I \u2208 I . We distinguish two cases. \u2013 w\u2032\u2032 \u2208 NI . It follows that w20 = w\u2032\u2032. Then property B is satisfied for role R and terms w20, . . . , w2m2 . \u2013 w\u2032\u2032 6\u2208 NI . Let a \u2208 NI be the unique individual such that a \u227a w\u2032\u2032. By the inductive hypothesis, a role P1 and\nterms w10, . . . , w 1 m1 with w 1 0 = a and w 1 m1 = w \u2032\u2032 exist satisfying properties (i)\u2013(iv). Then, we have P1 v\u2217T R and \u2016P1(w\u2032, a)\u2016I \u2208 I . Furthermore, for each i \u2208 [1,m1], we have \u2016P1(w1i\u22121, w1i )\u2016I \u2208 I . As no rule is applicable to I , we have \u2016R(w\u2032, a)\u2016I \u2208 I and \u2016R(w1i\u22121, w1i )\u2016I \u2208 I . Then the property is satisfied for role R and terms w20, . . . , w2m2 . \u2022 w\u2032 6\u227a w\u2032\u2032 and w\u2032\u2032 6\u227a w. By assumption, we have w 6\u2208 NI . Let b \u2208 NI be the unique individual such that b \u227a w. By the inductive hypothesis, a role P2 and terms w20, . . . , w 2 m2 with w 2 0 = b and w 2 m2 = w exist satisfying properties (i)\u2013(iv). Then,\nwe have P2 v\u2217T R and \u2016P2(w\u2032\u2032, w20)\u2016I \u2208 I . Furthermore, for each i \u2208 [1,m2], we have \u2016P2(w2i\u22121, w2i )\u2016I \u2208 I . As no rule is applicable to I , we have \u2016R(w\u2032\u2032, w20)\u2016I \u2208 I and \u2016R(w2i\u22121, w2i )\u2016I \u2208 I . We distinguish two cases. \u2013 w\u2032\u2032 \u2208 NI . As stated above, we have \u2016R(w\u2032, w\u2032\u2032)\u2016I \u2208 I and \u2016R(w\u2032\u2032, w20)\u2016I \u2208 I . Since trans(R) \u2208 I and no rule is\napplicable to I , we have \u2016R(w\u2032, w20)\u2016I \u2208 I . Then property B is satisfied for role R and terms w20, . . . , w2m2 . \u2013 w\u2032\u2032 6\u2208 NI . Let a \u2208 NI be the unique individual such that a \u227a w\u2032\u2032. By the inductive hypothesis, a role P1 and\nterms w10, . . . , w 1 m1 with w 1 0 = a and w 1 m1 = w \u2032\u2032 exist satisfying properties (i)\u2013(iv). Then, we have P1 v\u2217T R and \u2016P1(w\u2032, w10)\u2016I \u2208 I . Furthermore, for each i \u2208 [1,m1], we have \u2016P1(w1i\u22121, w1i )\u2016I \u2208 I . As no rule is applicable to I , we have \u2016R(w\u2032, w10)\u2016I \u2208 I and \u2016R(w1i\u22121, w1i )\u2016I \u2208 I . Since trans(R) \u2208 T and no rule is applicable to I , we have \u2016R(w\u2032, w20)\u2016I \u2208 I . Property B is satisfied for role R and terms w20, . . . , w2m2 .\nLet q\u2032 = \u2203~y.\u03c8(~x, ~y) be a CQ and let \u03c0\u2032 be a substitution such that dom(\u03c0\u2032) = ~x and each element in rng(\u03c0\u2032) is an individual from NI . Assume that \u039eK |= \u03c0\u2032(q\u2032); we next show that a substitution \u03c4 \u2032 with dom(\u03c4 \u2032) = NV (q\u2032) exists such that \u03c4 \u2032|~x = \u03c0\u2032, each element in rng(\u03c4 \u2032) is an individual occurring in DK, and all of the following conditions hold:\n1. for each x \u2208 ~x, we have \u03c4 \u2032(x) \u2208 NI ,"}, {"heading": "2. DK |= \u03c4 \u2032(q\u2032), and", "text": "3. a nondeterministic computation exists such that function isSound(q,DK, \u03c4) returns t.\nSince \u039eK |= \u03c0\u2032(q), a substitution \u03c0\u2032\u2217 with dom(\u03c0\u2032\u2217) = NV (q\u2032) exists such that \u03c0\u2032 \u2286 \u03c0\u2032\u2217 and \u2016\u03c0\u2032\u2217(q\u2032)\u2016I \u2286 I . Let substitution \u03c4 \u2032 be such that, for each variable z \u2208 NV (q\u2032), we have \u03c4 \u2032(z) = \u03b4(\u03c0\u2032\u2217(z)). Since \u03b4 is the identity on NI and \u03c0\u2032\u2217(x) \u2208 NI for each x \u2208 ~x, we have \u03c0\u2032 \u2286 \u03c4 \u2032 and \u03c4 \u2032(x) \u2208 NI . By Lemmas 20 and 24, we have \u2016\u03c4 \u2032(q\u2032)\u2016J \u2286 J , and so DK |= \u03c4 \u2032(q\u2032). Hence, in the following, we show that property (3) holds.\nLet q and \u03c4 be as specified in Definition 4. Then, we have DK |= \u03c4(q) and \u03c4(q) \u2286 J . Let \u03c0\u2217 be the restriction of \u03c0\u2032\u2217 to only those variables that occur in q. By the definition of \u03c4 and \u03c0\u2217, for each variable z \u2208 NV (q), we have \u03b4(\u03c0\u2217(z)) = \u03c4(z). We next show that \u03c0\u2217(q) \u2286 I . Lemma 30. Substitution \u03c0\u2217 satisfies \u03c0\u2217(q) \u2286 I\nProof. Let \u03c0\u2032\u2217 and \u03c0\u2217 be as specified above; furthermore, let \u03b3 be the mapping from NT (q \u2032) to NT (q) such that q is obtained by replacing each term t \u2208 NT (q\u2032) with \u03b3(t). To prove that \u03c0\u2217(q) \u2286 I , we show that for each term t \u2208 NT (q\u2032), we have \u03c0\u2217(\u03b3(t)) = \u2016\u03c0\u2032\u2217(t)\u2016I . We distinguish two cases.\n\u2022 Consider an arbitrary variable z \u2208 NV (q\u2032) such that \u03c4 \u2032(z) \u2208 auxDK . Then \u03b3(z) = z. By the definition of auxDK , for each individual u such that DK |= \u03c4 \u2032(z) \u2248 u, we have u 6\u2208 NI and \u03c4 \u2032(z) = u; therefore, \u2016\u03c4 \u2032(z)\u2016J = \u03c4 \u2032(z). But then, by the construction of \u03c4 \u2032 and by Lemma 24, we have \u2016\u03c0\u2032\u2217(z)\u2016I = \u03c0\u2217(z).\n\u2022 Consider an arbitrary term t \u2208 NT (q\u2032) such that \u03c4 \u2032(t) 6\u2208 auxDK . By the definition of q, we have \u03b3(t) = \u2016\u03c4 \u2032(t)\u2016J and \u03b3(t) \u2208 NI . By Lemma 24, for each term w occurring in I with \u03b4(w) = \u03c4 \u2032(t), we have \u2016w\u2016I = \u03b3(t). By the definition of \u03c4 \u2032, we then have \u03c0(\u03b3(t)) = \u03b3(t) = \u2016\u03c0\u2032\u2217(t)\u2016I .\nLet relation \u223c and query q\u223c be as specified in Definition 6; moreover, let connection graph cg = \u3008V,Es, Et\u3009 be as specified in Definition 7. We next show that function isDSound(q,DK, \u03c4) returns t.\nLemma 31. Function isDSound(q,DK, \u03c4) returns t.\nProof. We next prove that isDSound(q,DK, \u03c4) return t by showing that the two conditions of Definition 8 are satisfied. (Condition 1) We prove that, for each s \u223c t, we have \u03c4(s) = \u03c4(t) and \u03c0\u2217(s) = \u03c0\u2217(t). We proceed by induction on the number of steps required to derive s \u223c t. For the base case, the empty relation \u223c clearly satisfies the two properties. For the inductive step, consider an arbitrary relation \u223c obtained in n steps that satisfies these constraints; we show that the same holds for all constraints derivable from \u223c. We focus on the (fork) rule, as the derivation of s \u223c t due to reflexivity, symmetry, or transitivity clearly preserves the required properties. Let s\u20321, s2, s \u2032 2, and s2 be arbitrary terms inNT (q), and letR1 andR2 be arbitrary roles such that s\u20321 \u223c s\u20322 is obtained in n steps, atoms R1(s1, s\u20321) and R2(s2, s\u20322) occur in q and are aux-simple, and \u03c4(s\u20322) \u2208 auxDK . By the definition of \u03c4 , we have \u03c0(s\u20322) 6\u2208 NI . Moreover, by the definition of aux-simple atom, for i = 1, 2 we have si 6= s\u2032i, role Ri is simple, and \u03c4(si) = \u03c4(s\u2032i) implies that SelfRi(\u03c4(s \u2032 i)) 6\u2208 J . By the inductive hypothesis, we have \u03c4(s\u20321) = \u03c4(s\u20322) and \u03c0\u2217(s \u2032 1) = \u03c0\u2217(s \u2032 2). By Lemma 20, atoms {R1(\u03c0\u2217(s1), \u03c0\u2217(s\u20321)), R2(\u03c0\u2217(s2), \u03c0\u2217(s\u20322))} \u2286 I are not self-loops. Moreover, since R1 and R2 are simple roles, by property 1 in Lemma 29, we have \u03c0\u2217(s1) = \u03c0\u2217(s2). Therefore, \u03c0\u2032\u2217(s1) = \u03c0 \u2032 \u2217(s2). By the construction of \u03c4 \u2032, we have \u03c4 \u2032(s1) = \u03c4 \u2032(s2), and so \u03c4(s1) = \u03c4(s2). (Condition 2) We show that \u3008V,Es\u3009 is a DAG. Assume the opposite; hence, vertices v0, . . . , vm \u2208 V with vm = v0 exist such that m > 0 and \u3008vi\u22121, vi\u3009 \u2208 Es for each i \u2208 [1,m]. By the definition of Es, we have Es \u2286 V \u00d7 (V \u2229NV (q)). Thus, for each i \u2208 [0,m] we have vi 6\u2208 indDK , and so \u03c4(vi) \u2208 auxDK . Consider an arbitrary i \u2208 [1,m] and the corresponding edge \u3008vi\u22121, vi\u3009 \u2208 Es. By the definition of Es, a role Ri exists such that Ri(vi\u22121, vi) is an aux-simple atom in q\u223c. By the definition of aux-simple atom, we have vi\u22121 6= vi, role Ri is simple, and \u03c4(vi\u22121) = \u03c4(vi) implies that SelfRi(\u03c4(vi)) 6\u2208 J . By Lemma 20 and by the construction of \u03c4 , atom Ri(\u03c0\u2217(vi\u22121), \u03c0\u2217(vi)) \u2208 I is not a self-loop. Since \u03c4(vi) \u2208 auxDK , we have \u03c0\u2217(vi) 6\u2208 NI . Then, by property 1 in Lemma 29, we have \u03c0\u2217(vi\u22121) \u227a \u03c0\u2217(vi). Thus, \u03c0\u2217(v0) \u227a \u03c0\u2217(vm) which contradicts vm = v0.\nWe are now ready to prove the completeness claim.\nLemma 32. A nondeterministic computation exists such that isSound(q,DK, \u03c4) returns t.\nProof. Recall that \u03c0\u2217(q) \u2286 I and that \u03c4(q) \u2286 J . By Lemma 31, the condition in step 1 in Algorithm 1 is not satisfied. If each binary atom R(s, t) occurring in q\u223c is either good or aux-simple, then our algorithm returns t in step 2; hence, in the rest of this proof, we assume that this is not the case.\nFor the variable renaming \u03c3 in step 3, for each variable z \u2208 V , let \u03c3(z) be an arbitrary, but fixed, variable z\u2032 \u2208 V such that \u03c0\u2217(z) = \u03c0\u2217(z\n\u2032). It is straightforward to see that \u03c0\u2217(\u03c3(q\u223c)) \u2286 I . For the skeleton S = \u3008V, E\u3009 in step 3, let V = \u03c3(V ) and let E be the smallest set containing \u3008v\u2032, v\u3009 \u2208 E for all v\u2032, v \u2208 V such that \u03c0\u2217(v\u2032) \u227a \u03c0\u2217(v) and no vertex v\u2032\u2032 \u2208 V exists such that \u03c0\u2217(v\u2032) \u227a \u03c0\u2217(v\u2032\u2032) \u227a \u03c0\u2217(v). By the definition of \u227a, graph \u3008V, E\u3009 is a forest rooted in V \u2229 indDK .\nWe next show that for each \u3008v\u2032, v\u3009 \u2208 \u03c3(Es), we have \u3008v\u2032, v\u3009 \u2208 E . Consider an arbitrary edge \u3008v\u2032, v\u3009 \u2208 \u03c3(Es). Then vertices u\u2032 and u exist in V such that \u3008u\u2032, u\u3009 \u2208 Es, \u03c0\u2217(u\u2032) = \u03c0\u2217(v\u2032), and \u03c0\u2217(u) = \u03c0\u2217(v). By the definition of Es, role R exist such that R(u\u2032, u) is an aux-simple atom in q\u223c. By the definition of aux-simple atom, we have \u03c4(u) \u2208 auxDK , u\u2032 6= u, role R is simple, and \u03c4(u\u2032) = \u03c4(u) implies that SelfR(\u03c4(u)) 6\u2208 J . By Lemma 20 and by the construction of \u03c4 , atom R(\u03c0\u2217(u), \u03c0\u2217(u)) \u2208 I is not a self-loop. Since \u03c4(u) \u2208 auxDK , we have \u03c0\u2217(u) 6\u2208 NI . Then, by property 1 in Lemma 29, we have \u03c0\u2217(u) is of the form fBT,A(\u03c0\u2217(u\n\u2032)). Thus, \u03c0(u\u2032) \u227a \u03c0(u) and no vertex v\u2032\u2032 \u2208 V exists such that \u03c0(u\u2032) \u227a \u03c0(v\u2032\u2032) \u227a \u03c0(u). Since \u03c0\u2217(u) = \u03c0\u2217(v) and \u03c0\u2217(u\u2032) = \u03c0\u2217(v\u2032), we have \u3008v\u2032, v\u3009 \u2208 E , as required. Therefore, \u03c3(Es) \u2286 E . Please note that since \u3008V, E\u3009 is a forest, so is \u3008\u03c3(V ), \u03c3(Es)\u3009, as required by condition 3 in Definition 9.\nIt remains to show that each edge \u3008v\u2032, v\u3009 \u2208 E occurs in \u03c3(Et). Consider an arbitrary edge \u3008v\u2032, v\u3009 \u2208 E . By the definition of E , we have \u03c0\u2217(v\u2032) \u227a \u03c0\u2217(v), and so \u03c0\u2217(v) is a functional term. Then let w0, . . . , wk be terms such that w0 = \u03c0\u2217(v\u2032), wk = \u03c0\u2217(v), and wi is of the form fBiTi,Ai(wi\u22121) for each i \u2208 [1, k]. Note that these terms are uniquely defined by the edge, and that, by the construction of I , for each i \u2208 [1, k], we have Ti(wi\u22121, wi) \u2208 I . By Lemma 20, we have dTi(\u03b4(wi\u22121), \u03b4(wi)) \u2208 J . By the definition of \u03c4 , we have \u03b4(w0) = \u03c4(v\u2032) and \u03b4(wk) = \u03c4(v). Thus, \u3008v\u2032, v\u3009 \u2208 \u03c3(Et), as required by Definition 10.\nFinally, consider an edge \u3008v\u2032, v\u3009 \u2208 E and let w0, . . . , wk be terms uniquely associated with this edge. Then a role R is compatible with \u3008v, v\u2032\u3009 if dR(\u03b4(wi\u22121), \u03b4(wi)) \u2208 J for each i \u2208 [1, k], and trans(R) 6\u2208 T implies that k = 1. In the rest of this proof we will show the following property.\n(\u2666) Each role R \u2208 L(v\u2032, v) is compatible with the edge \u3008v\u2032, v\u3009.\nBy the definition of function exist (Definition 11) and the above definition of compatibility, property (\u2666) implies that the condition in step 17 is not satisfied for edge \u3008v\u2032, v\u3009 \u2208 E .\nFor the loop in step 6; let R(s, t) be an arbitrary aux-simple atom in \u03c3(q\u223c). By the definition of aux-simple atom, we have \u03c4(t) \u2208 auxDK , role R is simple, and s 6= t. By the definition of \u03c3, we have \u03c0\u2217(s) 6= \u03c0\u2217(t). Thus, R(\u03c0\u2217(s), \u03c0\u2217(t)) \u2208 I is not a self-loop. Since R is simple, by property 1 in Lemma 29, \u03c0\u2217(t) is of the form fA1T,A(\u03c0\u2217(s)). By Lemma 20, we have dR(\u03b4(\u03c0\u2217(s)), \u03b4(\u03c0\u2217(t))) \u2208 I . Letw0, . . . , wk be the terms associated with \u3008s, t\u3009 \u2208 E . By the form of \u03c0\u2217(t) and sincew0 = \u03c0\u2217(s) and wk = \u03c0\u2217(t), we have k = 1. Thus, property (\u2666) is satisfied.\nFor the loop in steps 7\u201315; let R(s, t) be an arbitrary atom in \u03c3(q\u223c) that is neither good nor aux-simple. We next determine the nondeterministic choices that preserve (\u2666) in step 15, and that satisfy the conditions in steps 8, 9, and 14. By assumption, we have R(\u03c0\u2217(s), \u03c0\u2217(t)) \u2208 I . Since R(s, t) is not good, we have \u03c4(t) \u2208 auxDK , and either s 6= t or SelfR(\u03c4(t)) 6\u2208 J . By Lemma 20 and by the definition of \u03c4 , atom R(\u03c0\u2217(s), \u03c0\u2217(t)) \u2208 I is not a self-loop. Hence, a role P and terms w0, . . . , wm with wm = \u03c0\u2217(t) exist in \u2206I that satisfy property 2 in Lemma 29. Since P v\u2217T R and by properties (2c) and (2d), we have P (\u03c0\u2217(s), \u03c0\u2217(t)) \u2208 I . By Lemma 20 and by the construction of \u03c4 , we have P (\u03c4(s), \u03c4(t)) \u2208 J ; consequently, the conditions in step 8 are satisfied. Assume that trans(P ) 6\u2208 T . By property 2 in Lemma 29, we have m = 1 and \u03c0\u2217(v) \u227a \u03c0\u2217(t). Thus, \u03c0\u2217(t) is of the form fBT,A(\u03c0\u2217(s)). By the definition of skeleton S, we have \u3008s, t\u3009 \u2208 E ; thus, the condition in step 9 is not satisfied. Next, we consider two cases.\n\u2022 s reaches t in E . It follows that \u03c0\u2217(s) \u227a \u03c0\u2217(t). Let v0, . . . , vn be the unique path connecting s to t in S. Since \u03c0\u2217(s) \u227a \u03c0\u2217(t), we have w0 = \u03c0\u2217(v0) and wm = \u03c0\u2217(vn). Thus, for each i \u2208 [1, n], a unique index `i exists such that \u03c0\u2217(vi) = w`i . By property (2d) in Lemma 29 and by Lemma 20, role P is compatible with \u3008vi\u22121, vi\u3009 \u2208 E .\n\u2022 s does not reach t in E . Hence, \u03c0\u2217(s) 6\u227a \u03c0\u2217(t). Let at be the root of t in E , and let v0, . . . , vn be the unique path connecting at to t in E . Since \u03c0\u2217(s) 6\u227a \u03c0\u2217(t), we have w0 = at, w0 \u227a wm, and wm = \u03c0\u2217(vn); moreover, trans(P ) \u2208 T , and P (\u03c0\u2217(s), at) \u2208 I . Thus, for each i \u2208 [1, n], a unique index `i exists such that \u03c0\u2217(vi) = w`i . By Lemma 20, we have P (\u03c4(s), at) \u2208 J , so condition in step 17 is not satisfied. Then, by property (2d) in Lemma 29 and by Lemma 20, role P is compatible with \u3008vi\u22121, vi\u3009 \u2208 E .\nE Proof of Theorem 13 Let K = \u3008T ,A\u3009 be a satisfiable ELHOs KB and let DK be the datalog program for K; furthermore, let q = \u2203~y.\u03c8(~x, ~y) be a CQ, and let \u03c4 be a candidate answer for q and DK.\nTheorem 13. Function isSound(q,DK, \u03c4) can be implemented so that"}, {"heading": "1. it runs in nondeterministic polynomial time,", "text": ""}, {"heading": "2. if each binary atom in q is either good or aux-simple w.r.t. \u03c4 , it runs in polynomial time, and", "text": ""}, {"heading": "3. if the TBox T and the query q are fixed, it runs in polynomial time in the size of the ABox A.", "text": "Proof. Please note that since the number of variables occurring in each rule in DK is fixed, we can compute the set of all consequences of DK in polynomial time (Dantsin et al. 2001). Thus all the following operations can be implemented to run in polynomial time:\n\u2022 computing sets auxDK and indDK , \u2022 computing the connection graph cg for q and \u03c4 , \u2022 given two individuals u\u2032 and u and a set of role L, checking whether exist(u\u2032, u, L) returns t, and \u2022 checking whether a binary atom is good or aux-simple w.r.t. \u03c4 .\nNext, we argue that we can compute relation \u223c in polynomial time. As stated above, we can evaluate in polynomial time the precondition of the (fork) rule. In addition, the size of relation \u223c is bounded by |NT (q)|2, the rules used to compute it are monotonic, and each inference can be applied in polynomial time, so the claim follows.\nAlso, we can check in linear time whether a directed graph is a acyclic by searching for a topological ordering of its vertices (Cormen et al. 2009). Therefore, condition 2 in Definition 8 can be checked in polynomial time. Therefore, steps 1 and 2 in Algorithm 1 run in time polynomial in the input size, and property 2 holds.\nSince steps 3\u201315 in Algorithm 1 can all clearly be implemented to run in nondeterministic polynomial time in the input size, property 1 also holds.\nFor property 3, assume that the TBox T and the query q are fixed. Then the set of all consequences of DK can be computed in time polynomial inA. Given that the number of variables occurring in q is fixed, the number of guessing steps required in steps 3 and 4 is fixed; also, the number of alternatives for these steps is linear in the size ofA. Thus, steps 3 and 4 require polynomial time. Moreover, the maximum number of iterations of the for-loop in steps 7-15 is fixed. The number of alternatives for the guessing steps in line 8 is fixed as well. Therefore, steps 7-15 require time polynomial in the size of A. All other steps can clearly be implemented in time polynomial in the size of A, thus isSound runs in time polynomial in the size of A.\nF Proof of Theorem 14 Theorem 14. Checking whether a candidate answer is sound is NP-hard.\nProof. The proof is by reduction from the NP-hard problem of checking the satisfiability of a 3CNF formula (Garey and Johnson 1979). Let \u03d5 = \u2227m j=1 Cj be a 3CNF formula over variables {v1, . . . , vn}, where each Cj is a set of three literals Cj = {lj,1, lj,2, lj,3}. A sequence \u03bd = lj1,k1 , . . . , lj`,k` of literals from \u03d5 is consistent if {vi,\u00acvi} 6\u2286 \u03bd for each i \u2208 [1, n]. Such a \u03bd is a truth assignment for \u03d5 if for each j \u2208 [1,m], a literal l \u2208 \u03bd exists such that l = lj,k for some k \u2208 [1, 3]. Then \u03d5 is satisfiable if and only if there exists a consistent truth assignment for \u03d5.\nLet \u03d5 be a 3CNF formula. We next define an ELHOs KB K\u03d5 and a Boolean CQ q\u03d5 such that K\u03d5 does not contain axioms of type 2, and K\u03d5 |= q\u03d5 if and only if there exists a consistent truth assignment for \u03d5. Let D\u03d5 be the translation of K\u03d5 into datalog. By Theorem 12 and since K\u03d5 does not contain axioms of type 2, we have K\u03d5 |= q\u03d5 if and only if a candidate answer \u03c4 for q\u03d5 and D\u03d5 exists such that isSound(q\u03d5,D\u03d5, \u03c4) returns t. Then, to prove the theorem, we show that there exists a unique candidate answer \u03c4\u03d5 for q\u03d5 and D\u03d5. Thus, K\u03d5 |= q\u03d5 if and only if isSound(q\u03d5,D\u03d5, \u03c4\u03d5) returns t, hence, isSound(q\u03d5,D\u03d5, \u03c4\u03d5) returns t if and only if \u03d5 is satisfiable.\nFor convenience, in the following we will specifyK\u03d5 using its equivalent formalisation as a rule base \u039e\u03d5. Moreover, rule base \u039e\u03d5 will not contain equality rules; consequently \u039e\u03d5 has a unique universal interpretation I . We will present our construction of \u039e\u03d5 in stages, and for each we will describe how it affects the universal interpretation I .\nOur encoding of \u039e\u03d5 uses a fresh individual a, fresh concepts A and G, fresh roles R and T , a fresh concept Lj,k and a fresh role Sj,k uniquely associated to each literal lj,k, a fresh concept Cj uniquely associated to each clause Cj , and fresh roles Pi, Ni, and Ti uniquely associated to each variable vi.\nBefore presenting \u039e\u03d5, we need a couple of definitions. Given two terms w\u2032 and w from I , and a word \u03c1 = T1 \u00b7 \u00b7 \u00b7T` over NR, we write \u03c1(w\u2032, w) \u2208 I , if terms w0, . . . , w` with w0 = w\u2032 and wm = w exist such that Ti(wi\u22121, wi) \u2208 I for each i \u2208 [1, `]. In the following, we uniquely associate to each sequence \u03bd = lj1,k1 , . . . , lj`,k` of literals from \u03d5 the word \u03c1\u03bd = R \u00b7 Sj1,k1 \u00b7R \u00b7 Sj2,k2 \u00b7 \u00b7 \u00b7R \u00b7 Sj`,k` \u00b7R.\nWe next present \u039e\u03d5 which consists of four parts. The first part of rule base \u039e\u03d5 contains atom (3) and rules (4)\u2013(7). Then for each sequence \u03bd of literals from \u03d5, a term w\u03bd\nexists in I such that \u03c1\u03bd(a,w\u03bd) \u2208 I and G(w\u03bd) \u2208 I .\nA(a) (3) A(x)\u2192\u2203z.R(x, z) \u2227 Cj(z) \u2200j \u2208 [1,m] (4) A(x)\u2192\u2203z.R(x, z) \u2227G(z) (5) Cj(x)\u2192\u2203z.Sj,k(x, z) \u2227 Lj,k(z) \u2200j \u2208 [1,m] \u2200k \u2208 [1, 3] (6) Lj,k(x)\u2192A(x) \u2200j \u2208 [1,m] \u2200k \u2208 [1, 3] (7)\nThe second part of rule base \u039e\u03d5 contains rules (8) and (9). Consider an arbitrary literal lj,k and arbitrary terms w\u2032 and w in I such that Sj,k(w\u2032, w) \u2208 I . Then, for each variable vi, we have Pi(w\u2032, w) \u2208 I if and only if sequence vi, lj,k is consistent; and Ni(w \u2032, w) \u2208 I if and only if sequence \u00acvi, lj,k is consistent.\nSj,k(x, y)\u2192 Pi(x, y) \u2200j \u2208 [1,m],\u2200k \u2208 [1, 3],\u2200i \u2208 [1, n] with lj,k = vi or lj,k is not over vi (8) Sj,k(x, y)\u2192 Ni(x, y) \u2200j \u2208 [1,m],\u2200k \u2208 [1, 3],\u2200i \u2208 [1, n] with lj,k = \u00acvi or lj,k is not over vi (9)\nThe third part of rule base \u039e\u03d5 contains rules (10)\u2013(13). Then for each sequence \u03bd of literals from \u03d5 with \u03c1\u03bd(a,w\u03bd) \u2208 I and each i \u2208 [1, n], we have Pi(a,w\u03bd) \u2208 I if and only if \u03bd, vi is consistent; and Ni(a,w\u03bd) \u2208 I if and only if \u03bd,\u00acvi is consistent.\nR(x, y)\u2192 Pi(x, y) \u2200i \u2208 [1, n] (10) R(x, y)\u2192 Ni(x, y) \u2200i \u2208 [1, n] (11)\nPi(x, y) \u2227 Pi(y, z)\u2192 Pi(x, z) \u2200i \u2208 [1, n] (12) Ni(x, y) \u2227Ni(y, z)\u2192 Ni(x, y) \u2200i \u2208 [1, n] (13)\nThe fourth part of rule base \u039e\u03d5 contains rules (14)\u2013(16). Then for each sequence \u03bd of literals from \u03d5 with \u03c1\u03bd(a,w\u03bd) \u2208 I and each i \u2208 [1, n], we have Ti(a,w\u03bd) \u2208 I if and only if {vi,\u00acvi} 6\u2286 \u03bd; furthermore, for each clause Cj , a term wj exists such that T (wj , w\u03bd) \u2208 I if and only if an index k \u2208 [1, 3] exists such that lj,k \u2208 \u03bd.\nPi(x, y)\u2192 Ti(x, y) \u2200i \u2208 [1, n] with i 6= k (14) Ni(x, y)\u2192 Ti(x, y) \u2200i \u2208 [1, n] with i 6= k (15) Li(x, y)\u2192 T (x, y) \u2200i \u2208 [1, n] (16)\nQuery q\u03d5 is given in (17). Then K\u03d5 |= q\u03d5 if and only if a sequence \u03bd of literals from \u03d5 exists such that Ti(a,w\u03c1) \u2208 I for each i \u2208 [1, n], and, for each j \u2208 [1,m], a term wj exists such that Cj(wj) \u2208 I and T (wj , w\u03c1) \u2208 I; hence, K\u03d5 |= q\u03d5 if and only if\nthere exists a consistent truth assignment \u03bd for \u03d5.\nq\u03d5 = \u2203y\u2203z1, . . .\u2203zm. G(y) \u2227 n\u2227 i=1 Ti(a, y) \u2227 m\u2227 j=1 Cj(zj) \u2227 T (zj , y) (17)\nProgram D\u03d5 contains all the atoms and the rules in \u039e\u03d5 apart from rules (4)\u2013(6) which are replaced by rules (18)\u2013(20).\nA(x)\u2192 R(x, oR,Cj ) \u2227 Cj(oR,Cj ) \u2200j \u2208 [1,m] (18) A(x)\u2192 R(x, oR,G) \u2227G(oR,G) (19) Cj(x)\u2192 Sj,k(x, oSj,k,Lj,k) \u2227 Lj,k(oSj,k,Lj,k) \u2200j \u2208 [1,m],\u2200k \u2208 [1, 3] (20)\nWe next define substitution \u03c4\u03d5, and we show that D\u03d5 |= \u03c4\u03d5(q\u03d5). Substitution \u03c4\u03d5 is given in (21). \u03c4(y) = oR,G and \u03c4(zj) = oR,Cj \u2200j \u2208 [1,m] (21)\nConsider an arbitrary i \u2208 [1, n]; we show that D\u03d5 |= Ti(a, \u03c4(y)). By atom (3), and by rule (19) we have D\u03d5 |= R(a, \u03c4(y)). But then, by rules (10), (11), (14) (15), we immediately have D\u03d5 |= Ti(a, \u03c4(y)), as required. Next, consider an arbitrary j \u2208 [1,m]; we show that D\u03d5 |= T (\u03c4(zj), \u03c4(y)). Please note that by atom (3) and by rules (18), we have D\u03d5 |= Cj(\u03c4(zj)). Consider an arbitrary literal lj,k in Cj . By rules (20) and (7), there exists an individual u such that D\u03d5 |= Sj,k(\u03c4(zj), u) and D\u03d5 |= A(u). Then, by rule (19) we have D\u03d5 |= R(u, \u03c4(y)). By rules (10)\u2013(16), we have D\u03d5 |= T (\u03c4(zj), \u03c4(y)), as required.\nWe are left to show that \u03c4\u03d5 is unique. Consider an arbitrary candidate answer \u03be for q\u03d5 and D\u03d5. Since G(y) is an atom in q and only rule (19) derives assertions over G, we must have \u03be(y) = oR,G. Consider an arbitrary j \u2208 [1,m]. Due to atom Cj(zj) in q, and only rule (18) derives assertions over concept Cj , we must have \u03be(y) = oR,Cj . Thus, \u03be = \u03c4\u03d5, as required.\nG Proof of Theorem 17 Let K be a satisfiable ELHO KB, and let \u039eK and DK be the rule base and the datalog program associated with K, respectively; furthermore, let indDK and auxDK be as specified in Definition 4, and let q be an arborescent query. We next show that function entails(DK, q) returns t if and only if \u039eK |= q, and that entails(DK, q) runs in time polynomial in the input size.\nTo this end, we start with a couple of definitions. Let I and J be universal interpretations for \u039eK and DK, respectively. Moreover, let \u03b4 be the mapping as specified at the beginning of Section B. For each set V \u2208 RT, let qV be the arborescent query obtained from q by replacing each variable y \u2208 V with a fresh variable yV , and by removing each variable z, and all the atoms involving z, in the resulting query such that z 6= yV and z is not a descendant of yV in dgq . Lemma 33. Function entails(DK, q) returns t if and only if \u039eK |= q. Furthermore, entails(DK, q) runs in time polynomial in the input size.\nProof. Since q does not contain individuals, we have \u039eK |= q if and only if a substitution \u03c0 with dom(\u03c0) = NV (q) exists such that \u03c0(q) \u2286 I . In the following, we show that the latter is the case if and only if function entails(DK, q) returns t.\nLet RT be as specified in Definition 16. Let M be the largest n \u2208 N for which a set V \u2208 RT exists whose level is n. By the definition, M is the length of the longest path in dgq , and so it is linearly bounded by the size of q.\nNext, we argue that we can compute set RT in polynomial time. This follows from the fact that the rules used to compute it are monotonic, each rule can be applied at most M times, and each rule application introduces at most |q| sets in RT, and the size of each set is linearly bounded by |q|.\nBy Lemmas 20 and 21, and since each rule in DK contains a fixed number of variables, each set V \u2208 RT satisfies the two following properties for each u \u2208 indDK \u222a auxDK and each term w \u2208 \u2206I with \u03b4(w) = u. A. u \u2208 cV if and only if B(w) \u2208 I for each concept B such that B(y) \u2208 q for some y \u2208 V . B. cV can be computed in time polynomial in the size of DK and q.\nTo prove the lemma, we next show that each set V \u2208 RT satisfies the following properties for each term u \u2208 indDK \u222a auxDK . 1. u \u2208 AV if and only if a substitution \u03c0 with dom(\u03c0) = NV (qV ) exists such that \u03c0(qV ) \u2286 I and \u03b4(\u03c0(yV )) = u. 2. AV can be computed in time polynomial in the size of DK and q.\nThe proof goes by reverse-induction on the level of sets in RT. Base case. Consider an arbitrary set V \u2208 RT of level M . By the definition of AV , we have AV = cV . Furthermore, an atom B(yV ) is in qV if and only if a variable y \u2208 V exists such that B(y) in q. Properties 1 and 2 follow immediately from A and B. Inductive step. Consider an arbitrary n \u2208 N. Let V \u2208 RT be an arbitrary set of level n, and assume that properties 1 and 2 hold for each set W \u2208 RT of level n+ 1; we show that the properties are satisfied by V . For property 1, let u be an arbitrary term in indDK \u222a auxDK . By the definition of AV we have AV = cV \u2229 (iV \u222a aV ). By the definition of qV and from property A, it suffices to show that u \u2208 (iV \u222a aV ) if and only if a substitution \u03c0 exists such that \u03c0(qV ) \u2286 I and \u03b4(\u03c0(yV )) = u. We consider the two directions of 1 separately.\n(\u21d2) Assume that u \u2208 (iV \u222a aV ). We distinguish two cases.\n\u2022 u \u2208 iV . Thus, u \u2208 indDK and u \u2208 NI . Consider an arbitrary variable y \u2208 PV and an arbitrary role R \u2208 ry . Then, an individual u\u2032 \u2208 indDK \u222a auxDK exists such that u\u2032 \u2208 A{y} andR(u\u2032, u) \u2208 J . By the inductive hypothesis, a substitution \u03c0{y} exists such that \u03c0{y}(q{y}) \u2286 I and \u03b4(w\u2032) = u\u2032, where w\u2032 = \u03c0{y}(y{y}). By Lemma 21, we have R(w\u2032, u) \u2208 I . Then let \u03c0 be the substitution such that \u03c0(yV ) = u and \u03c0{y} \u2286 \u03c0 for each y \u2208 PV . Then \u03c0(qV ) \u2286 I , as required. \u2022 u \u2208 aV . Thus, u \u2208 auxDK and u is of the form oP,A. Consider an arbitrary role R such that R \u2208 ry for some y \u2208 PV . Then, an individual u\u2032 \u2208 indDK \u222a auxDK exists such that u\u2032 \u2208 APV and dR(u\u2032, u) \u2208 J . By the inductive hypothesis, a substitution \u03c0PV exists such that \u03c0PV (qPV ) \u2286 I and \u03b4(w\u2032) = u\u2032, where w\u2032 = \u03c0PV (yPV ). By Lemma 21, a term w \u2208 \u2206I exists such that \u03b4(w) = oP,A and P (w\u2032, w) \u2208 I and P v\u2217T R. Since no rule is applicable to I , we have R(w\u2032, w) \u2208 I . Then let \u03c0 be the substitution such that \u03c0(yV ) = w, \u03c0PV \u2286 \u03c0, and \u03c0(y) = w\u2032 for each y \u2208 PV . Then \u03c0(qV ) \u2286 I , as required.\n(\u21d0) Assume that a substitution \u03c0 exists such that \u03c0(qV ) \u2286 I and \u03b4(\u03c0(yV )) = u. We distinguish two cases. \u2022 \u03c0(yV ) \u2208 NI . By Lemma 24, we have u \u2208 indDK and u \u2208 NI . Consider an arbitrary variable y \u2208 PV and an arbitrary\nrole R \u2208 ry . By the definition of qV , atom R(y, yV ) occurs in qV . Since R(\u03c0(y), \u03c0(yV )) \u2208 I , by Lemma 20, we have R(\u03b4(\u03c0(y)), \u03b4(\u03c0(yV ))) \u2208 J and \u03b4(\u03c0(y)) \u2208 indDK \u222a auxDK . Due to the construction of qV , q{y} is a subquery of qV ; thus, \u03c0(q{y}) \u2286 I . Hence, by the inductive hypothesis, we have \u03b4(\u03c0(y)) \u2208 A{y}. Due to \u03b4(\u03c0(yV )) = u and u \u2208 indDK , we have u \u2208 iV , as required.\n\u2022 \u03c0(yV ) 6\u2208 NI . By Lemma 24, we have u \u2208 auxDK . Consider an arbitrary variable y \u2208 PV and an arbitrary role R \u2208 ry . By the definition of qV , atom R(y, yV ) occurs in qV . By assumption, we have R(\u03c0(y), \u03c0(yV )) \u2208 I . Since K is an ELHO knowledge base, role R is simple and SelfR(\u03c0(yV )) 6\u2208 I . By Lemma 29, term \u03c0(yV ) is of the form fBP,A(\u03c0(y)). Therefore, for each variable z \u2208 PV , we have \u03c0(z) = \u03c0(y). Furthermore, by Lemma 20, we have dR(\u03b4(\u03c0(y)), \u03b4(\u03c0(yV ))) \u2208 J and \u03b4(\u03c0(y)) \u2208 indDK \u222a auxDK . Let substitution \u03c0PV for qPV be obtained from \u03c0 by setting \u03c0PV (yPV ) = \u03c0(y). Then, we have \u03c0PV (qPV ) \u2286 I . Hence, by the inductive hypothesis, we have \u03b4(\u03c0(y)) \u2208 APV . Due to \u03b4(\u03c0(yV )) = u and u \u2208 auxDK , we have u \u2208 aV , as required. For property 2, we show that AV can be computed in time polynomial in the size of DK and q. By property B, set cV can be computed in time polynomial in q and DK, hence in the rest of this proof we focus on sets iV and aV .\n\u2022 iV . Please note that the number of variables in PV is bounded by the size of q. Then consider an arbitrary variable y \u2208 PV . By the inductive hypothesis, set A{y} can be computed in time polynomial in q and DK. Then, since each rule in DK contains a constant number of variables, iV can also be computed in time polynomial in the size of q and DK.\n\u2022 aV . By the inductive hypothesis, set APV can be computed in time polynomial in the size of q and DK. Then, since each rule in DK contains a constant number of variables, aV can also be computed in time polynomial in the size of q and DK.\nH Proof of Theorem 18 In this section, we prove the lower bounds established in Theorem 18, all of which are proved by reducing the NP-hard problem of checking the satisfiability of a CNF formula \u03c8 (Garey and Johnson 1979). For the rest of this section, we fix a CNF formula \u03c8 = \u2227m j=1 Cj where each Cj is a clause over variables {v1, . . . , vn}.\nFor convenience, we will assume that ELHO TBoxes can contain axioms of the form A1 v \u2203R.{a} with A1 \u2208 NC \u222a {>}, R a role, and {a} a nominal. The translation into rules for this type of axiom is given by A1(x) \u2192 R(x, a). Moreover, in the following we will specify DL knowledge bases using their equivalent formalisation as rule bases. Furthermore, all the rules from this section do not contain equality, and so each rule base has exactly one universal interpretation.\nThen to prove the theorem, we will first define a rule base \u039e0 containing only rules of types 1 and 7 from Table 1, and a Boolean CQ q0 over \u039e0, after which we will show that 1. a rule base \u039e1 and a query q1 exist such that \u039e1 is in ELHO, query q0 \u2227 q1 is acyclic, and \u03c8 is satisfiable if and only if\n\u039e0 \u222a \u039e1 |= q0 \u2227 q1, 2. a rule base \u039e2 and a query q2 exist such that \u039e2 contains a single rule of type 8, query q0 \u2227 q2 is arborescent, and \u03c8 is\nsatisfiable if and only if \u039e0 \u222a \u039e2 |= q0 \u2227 q2, and 3. a rule base \u039e3 and a query q3 exist such that \u039e3 contains a single rule of type 9, query q0 \u2227 q3 is arborescent, and \u03c8 is\nsatisfiable if and only if \u039e0 \u222a \u039e3 |= q0 \u2227 q3."}, {"heading": "H.1 Construction of \u039e0 and q0", "text": "Our encoding uses a fresh role R, a fresh concepts G, fresh concepts Ti, Fi, and Ai uniquely associated with each variable vi in \u03c8, and fresh concepts Cj uniquely associated to each clause Cj in \u03c8. Rule base \u039e0 contains a ground atom (22), and rules (23)\u2013(29). Let I0 be the universal interpretation of \u039e0, we next describe how the rules in \u039e0 model the structure of I0. Atom (22) and rules (23)\u2013(27) encode a binary tree of depth n+ 1 in I0 rooted in individual a in which edges are labelled by role R, each leaf node satisfies concept G, and each node w at depth 1 \u2264 i \u2264 n satisfies exactly one of Ti and Fi. Then node w represents a positive truth assignment to vi, if Ti(w) \u2208 I0; otherwise, it represents a negative truth assignment to vi. Consequently, a path\nfrom a to a leaf node in the tree represents a truth assignment to the variables in \u03c8. Finally, rules (28) and (29) ensure that, for each node w at depth 1 \u2264 i \u2264 n in the tree, if the truth assignment to vi represented by w makes clause Cj evaluate to true, then Cj(w) \u2208 I0.\nA0(a) (22) Ai\u22121(x)\u2192\u2203z.R(x, z) \u2227 Ti(z) \u2200i \u2208 [1, n] (23) Ai\u22121(x)\u2192\u2203z.R(x, z) \u2227 Fi(z) \u2200i \u2208 [1, n] (24) Ti(x)\u2192Ai(x) \u2200i \u2208 [1, n] (25) Fi(x)\u2192Ai(x) \u2200i \u2208 [1, n] (26) An(x)\u2192\u2203z.R(x, z) \u2227G(z) (27) Ti(x)\u2192Cj(x) \u2200i \u2208 [1, n] \u2200j \u2208 [1,m] with vi \u2208 Cj (28) Fi(x)\u2192Cj(x) \u2200i \u2208 [1, n] \u2200j \u2208 [1,m] with \u00acvi \u2208 Cj (29)\nQuery q0 is given in (30). It should be clear that, for each substitution \u03c0 with dom(\u03c0) = ~p such that \u03c0(q0) \u2286 I0, substitution \u03c0 represents a truth assignment for \u03c8, \u03c0(p0) = a, and \u03c0(pn+1) is a leaf.\nq0 = \u2203p0 . . . \u2203pn+1. n\u2227 i=1 [Ai\u22121(pi\u22121) \u2227R(pi\u22121, pi)] \u2227G(pn+1) (30)"}, {"heading": "H.2 Construction of \u039e1 and q1", "text": "Our rule base \u039e2 uses fresh roles Sj and individuals cj uniquely associated to each clause Cj of \u03c8. Then rule base \u039e1 contains atoms (31), and rules (32) and (33). Let I1 be the universal interpretation of \u039e0 \u222a \u039e1, then we clearly have I0 \u2286 I1. We next describe how the rules and atoms in \u039e1 modify the tree encoded by \u039e0. Rule (32) ensure that, for each node w in the tree whose truth assignment makes clause Cj evaluate to true, there exists an edge labelled by Sj from w to individual cj . Atom (31) generates an edge labelled by R connecting cj to itself. Finally, rule (33) labels each edge in the tree and each looping edge with Sj .\nR(cj , cj) \u2200j \u2208 [1,m] (31) Cj(x)\u2192Sj(x, cj) \u2200j \u2208 [1,m] (32) R(x, y)\u2192Sj(x, y) \u2200j \u2208 [1,m] (33)\nOur encoding of query q1 uses variable pn+1 from query q0, as well as fresh variables x j 0, . . . , x j n, y j , yj0, . . . , y j n, and\nzj1, . . . , z j n+1 uniquely associated with each clause Cj . Next, we associate with each Cj a conjunction \u03d5 j as shown in (34). Then query q1 is the existential closure of \u2227 j \u03d5 j .\n\u03d5j = R(yj , x j 0) \u2227 n\u2227 i=1 [\u03d5ji \u2227R(y j i\u22121, x j i )] \u2227 \u03d5 j n+1 \u2227R(yjn, pn+1) (34)\n\u03d5ji = R(x j i\u22121, z j i ) \u2227 Sj(y j i\u22121, z j i ) (35)\nFigure 2 shows a graphical representation of query q0 \u2227 q1 for n = 2 and an arbitrary j \u2208 [1,m]. The black edges denote atoms over role R, and the dashed edges denote atoms over role Sj . It should be clear that query q0 \u2227 q1 is acyclic, as required. Please note that q0 \u2227 q1 is not arborescent: each variable yji in q0 \u2227 q1 has two parent nodes.\nConsider an arbitrary substitution \u03c0 such that \u03c0(q0) \u2286 I1. Intuitively, each conjunct \u03d5j in q1 ensures that the truth assignment represented by \u03c0 makes clause Cj true. We next prove that our encoding is correct.\nLemma 34. \u03c8 is satisfiable if and only if \u039e0 \u222a \u039e1 |= q0 \u2227 q1.\nProof. (\u21d2) Assume that a truth assignment \u03bd : {v1, . . . , vn} 7\u2192 {t, f} exists such that \u03bd(\u03c8) = t; we next show that a substitution \u03c0 with dom(\u03c0) = NV (q0 \u2227 q1) exists such that \u03c0(q0\u2227 q1) \u2286 I1. To this end, let \u03c0(p0) = a and, for each i \u2208 [1, n], let \u03c0(pi) be the unique successor of \u03c0(pi\u22121) in I1 such that Ti(\u03c0(pi)) \u2208 I1 if and only if \u03bd(vi) = t. Consider an arbitrary clause Cj . Since \u03bd(\u03c8) = t, a literal l \u2208 Cj exists such that \u03bd(l) = t. Let k \u2208 [1, n] be the unique index such that literal l is over variable vk. Then, formulas \u03a8 j \u2212 and \u03a8 j + exist such that \u03d5 j is of the form \u03d5j = \u03a8j\u2212 \u2227\u03d5 j k+1 \u2227\u03a8 j +. Next, we extend substitution \u03c0 as follows:\n\u2022 \u03c0 maps each variable occurring in \u03a8j\u2212 to cj , \u2022 \u03c0(xjk) = cj , \u03c0(z j k+1) = cj , and \u03c0(y j k) = \u03c0(pk), and\n\u2022 for each ` \u2208 [k + 1, n+ 1], \u03c0 maps each variable with subscript ` occurring in \u03a8j+ to \u03c0(pk).\nPlease note that by rules (32) and (33), and by atoms (31), we have \u03c0(\u03a8j\u2212) \u222a \u03c0(\u03d5 j k+1) \u222a \u03c0(\u03a8 j +) \u2286 I1.\n(\u21d0) Assume that a substitution \u03c0 with dom(\u03c0) = NV (q0 \u2227 q1) exists such that \u03c0(q0 \u2227 q1) \u2286 I1; we next show that a truth assignment \u03bd : {v1, . . . , vn} 7\u2192 {t, f} exists such that \u03bd(\u03c8) = t. Please note that \u03c0(p0) = a and, for each i \u2208 [1, n], we have \u03c0(pi) is a successor of \u03c0(pi\u22121) in the binary tree encoded by \u039e0; moreover, for each j \u2208 [1,m], due to atom R(yjn, pn+1) in (34), we have \u03c0(yjn) is the unique parent of \u03c0(pn+1) in the tree, and so \u03c0(y j n) = \u03c0(pn). Then, let \u03bd be the truth assignment such that, for each i \u2208 [1, n], we have \u03bd(vi) = t if and only if Ti(\u03c0(pi)) \u2208 I1. We next show that \u03bd(\u03c8) = t; that is, for each clause Cj , we have \u03bd(Cj) = t. Consider an arbitrary clause Cj . By rules (27) and (28), it suffices to find an index ` \u2208 [1, n] such that Cj(\u03c0(p`)) \u2208 I1. Towards this goal, we first show that substitution \u03c0 satisfies the following property for each i \u2208 [0, n].\n(\u2666) If for each ` \u2208 [i, n] we have \u03c0(zj`+1) 6\u2208 NI , then \u03c0(y j i ) = \u03c0(pi) and \u03c0(x j i ) = \u03c0(pi).\nWe proceed by reverse induction on i \u2208 [0, n]. Base case. Let i = n. Assume that \u03c0(zjn+1) 6\u2208 NI . As stated above, we have \u03c0(yjn) = \u03c0(pn). Due to atom Sj(yjn, z j n+1) in \u03d5jn+1, we have \u03c0(z j n+1) is a successor of \u03c0(pn). Due to atom R(x j n, z j n+1) in \u03d5 j n+1, we have \u03c0(x j n) is the parent of \u03c0(z j n+1), thus \u03c0(xjn) = \u03c0(pn), as required. Inductive step. Consider an arbitrary i \u2208 [0, n\u2212 1]. Assume that the property holds for i+ 1, and that \u03c0(zj`+1) 6\u2208 NI for each ` \u2208 [i, n]. By the inductive hypothesis, we have \u03c0(yji+1) = \u03c0(pi+1) and \u03c0(x j i+1) = \u03c0(pi+1). Due to atom R(y j i , x j i+1) in (34), we have \u03c0(yji ) is the unique parent of \u03c0(pi+1) in the tree, and so \u03c0(y j i ) = \u03c0(pi). Due to atom Sj(y j i , z j i+1) in \u03d5 j i+1, we have \u03c0(zji+1) is a successor of \u03c0(pi). Finally, due to atom R(x j i , z j i+1) in \u03d5 j i+1, we have \u03c0(x j i ) = \u03c0(pi), as required.\nWe next show that an index i \u2208 [0, n] exists such that \u03c0(zji+1) is mapped to an individual. Assume the opposite, hence, for each i \u2208 [0, n], we have \u03c0(zji+1) 6\u2208 NI . By property (\u2666), we then have \u03c0(x j 0) = \u03c0(p0). Since atom S(y\nj , xj0) occurs in q1, \u03c0(xj0) = \u03c0(p0) = a, and a does not have incoming edges in I1, this is a contradiction.\nFinally, let ` \u2208 [0, n] be the largest index such that \u03c0(zj`+1) \u2208 NI . We show that \u03c0(y j ` ) = \u03c0(p`) by considering two cases.\n\u2022 ` = n. As stated above, we have \u03c0(yjn) = \u03c0(pn). \u2022 ` < n. By property (\u2666), we have \u03c0(xj`+1) = \u03c0(p`+1). Due to atom R(y j ` , x j `+1), we have \u03c0(y j ` ) = \u03c0(p`).\nIn either cases, we have \u03c0(yj` ) = \u03c0(p`). We next show that ` > 0. Assume the opposite, hence ` = 0. Since \u03c0 maps \u03c0(zj1) \u2208 NI and \u03c0(y j 0) = a, atom Sj(y j 0, z j 1) occurs in q1, and a is not connected to an individual in I1, we have Sj(\u03c0(y j 0), \u03c0(z j 1)) 6\u2208 I1, which is a contradiction.\nTherefore, we have \u03c0(yj` ) = \u03c0(p`) and ` > 1. By rules (32) and (33), and since atom Sj(y j ` , z j `+1) occurs in q1, we have\n\u03c0(zj`+1) = cj and Cj(\u03c0(p`)) \u2208 I1, as required."}, {"heading": "H.3 Construction of \u039e2 and q2", "text": "Rule base \u039e2 consists only of rule (36). Let I2 be the universal interpretation of \u039e0 \u222a \u039e2, then we clearly have I0 \u2286 I2. Note that rule (36) modifies the tree encoded by \u039e0 by connecting each node w in the tree via an R edge to all nodes that occur on the path connecting w to the root a.\nR(x, y) \u2227R(y, z)\u2192 R(x, z) (36)\nOur encoding of query q2 uses variable pn+1 from query q0, as well as a fresh variable xj uniquely associated to each clause Cj . Query q2 is given in (37).\n\u2203x1 . . . \u2203xm m\u2227 i=1 Cj(xj) \u2227R(xj , pn+1) (37)\nIt should be clear that q0 \u2227 q2 is arborescent. Now, consider a substitution \u03c0 such that \u03c0(q0 \u2227 q2) \u2286 I2. By the definition of q2, for each j \u2208 [1,m], a term wj exists such that wj occurs on the unique path connecting leaf \u03c0(pn+1) to the root of the tree a and Cj(wj) \u2208 I2; therefore, an index `j \u2208 [1, n] exists such that \u03c0(p`j ) = \u03c0(xj). By the definition of \u039e0 and q0, the truth assignment represented by \u03c0 then makes Cj evaluate to true. Thus, the following holds. Lemma 35. \u03c8 is satisfiable if and only if \u039e0 \u222a \u039e2 |= q0 \u2227 q2."}, {"heading": "H.4 Construction of \u039e3 and q3", "text": "Rule base \u039e3 consists of rules (38). Let I3 be the universal interpretation of \u039e0 \u222a \u039e3, then we clearly have I0 \u2286 I3. Rules (38) modify the tree encoded by \u039e0 by generating an edge labelled by R connecting each node to itself.\n>(x)\u2192 SelfR(x) \u2227R(x, x) \u2200j \u2208 [1,m] (38)\nOur encoding of query q3 uses variable pn+1 from query q0, as well as fresh variables x j 0, . . . , x j n uniquely associated to each clause Cj . Furthermore, we associate to each clause Cj the formula \u03d5j in (39). Then q3 is the existential closure of \u2227 j \u03d5 j .\n\u03d5j = Cj(x j 0) \u2227R(xj , x j 0) \u2227 n\u2227 i=1 R(xji\u22121, x j i ) \u2227R(x j n, pn+1) (39)\nIt should be clear that q0 \u2227 q3 is arborescent. Consider an arbitrary substitution \u03c0 such that \u03c0(q0 \u2227 q3) \u2286 I3 and an arbitrary clause Cj . Then, formula \u03d5j ensures that a path of length n + 1 exists connecting leaf node \u03c0(pn+1) to one arbitrary node occurring in the unique path connecting \u03c0(pn+1) to root a. Since the tree has depth n+ 1 and the leaves and the root of the tree do no satisfy concept Cj , variable x j 0 must be mapped to some node at depth 1 \u2264 i \u2264 n. By the definition of \u039e0 and q0, the truth assignment represented by \u03c0 then makes Cj evaluate to true. Thus, the following holds. Lemma 36. \u03c8 is satisfiable if and only if \u039e0 \u222a \u039e3 |= q0 \u2227 q3."}], "references": [], "referenceMentions": [], "year": 2017, "abstractText": "Answering conjunctive queries (CQs) over EL knowledge<lb>bases (KBs) with complex role inclusions is PSPACE-hard<lb>and in PSPACE in certain cases; however, if complex role<lb>inclusions are restricted to role transitivity, the upper com-<lb>plexity bound has so far been unknown. Furthermore, the ex-<lb>isting algorithms cannot handle reflexive roles, and they are<lb>not practicable. Finally, the problem is tractable for acyclic<lb>CQs and ELH, and NP-complete for unrestricted CQs and<lb>ELHO KBs. In this paper we complete the complexity land-<lb>scape of CQ answering for several important cases. In par-<lb>ticular, we present a practicable NP algorithm for answering<lb>CQs over ELHO KBs\u2014a logic containing all of OWL 2<lb>EL, but with complex role inclusions restricted to role transi-<lb>tivity. Our preliminary evaluation suggests that the algorithm<lb>can be suitable for practical use. Moreover, we show that,<lb>even for a restricted class of so-called arborescent acyclic<lb>queries, CQ answering over EL KBs becomes NP-hard in<lb>the presence of either transitive or reflexive roles. Finally, we<lb>show that answering arborescent CQs over ELHO KBs is<lb>tractable, whereas answering acyclic CQs is NP-hard.", "creator": "TeX"}}}