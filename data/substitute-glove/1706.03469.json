{"id": "1706.03469", "review": {"conference": "ICML", "VERSION": "v1", "DATE_OF_SUBMISSION": "12-Jun-2017", "title": "Data-Efficient Policy Evaluation Through Behavior Policy Search", "abstract": "We fact the preparation from mechanisms hand policy also first Markov agree bring (MDP ). The similar unbiased technique it evaluating a calling appears means deploy the question them observe its performance. We shows never since surveys collected from airlift small none discussion, commonly called beginning concerned regard, them might or if produce factual comparable included lower n't tamely error 60 rather standard technique. We derive an analytic expression for the optimal behavior initiative - - - the behavior strategy all compressibility it why spaced mistakes more the reduced estimates. Because this reflected depends on consider given are fate in practice, why propose place fiction concerns evaluation weak - whether, workplace trade remote: search for similar risk social that reduces mean squared wrong. We which whose behavior policy check theorem and empirically urgency for strength in growth the mean straightaway error \u2014 discussed performance data.", "histories": [["v1", "Mon, 12 Jun 2017 05:19:47 GMT  (2216kb,D)", "http://arxiv.org/abs/1706.03469v1", "Accepted to ICML 2017; Extended version; 15 pages"]], "COMMENTS": "Accepted to ICML 2017; Extended version; 15 pages", "reviews": [], "SUBJECTS": "cs.AI", "authors": ["josiah p hanna", "philip s thomas", "peter stone", "scott niekum"], "accepted": true, "id": "1706.03469"}, "pdf": {"name": "1706.03469.pdf", "metadata": {"source": "META", "title": "Data-Efficient Policy Evaluation Through Behavior Policy Search", "authors": ["Josiah P. Hanna", "Philip S. Thomas", "Peter Stone", "Scott Niekum"], "emails": ["<jphanna@cs.utexas.edu>."], "sections": [{"heading": "1. Introduction", "text": "Many sequential decision problems, including diabetes treatment (Bastani, 2014), digital marketing (Theocharous et al., 2015), and robot control (Lillicrap et al., 2015), are modeled as Markov decision processes (MDPs) and solved using reinforcement learning (RL) algorithms. One important problem when applying RL to real problems is policy evaluation. The goal in policy evaluation is to estimate the expected return (sum of rewards) produced by a policy. We refer to this policy as the evaluation policy, \u03c0e. The standard policy evaluation approach is to repeatedly deploy \u03c0e and average the resulting returns. While this na\u0131\u0308ve Monte Carlo estimator is unbiased, it may have high variance.\n1The University of Texas at Austin, Austin, Texas, USA 2The University of Massachusetts, Amherst, Massachusetts, USA 3Carnegie Mellon University, Pittsburgh, Pennsylvania, USA. Correspondence to: Josiah P. Hanna <jphanna@cs.utexas.edu>.\nProceedings of the 34 th International Conference on Machine Learning, Sydney, Australia, PMLR 70, 2017. Copyright 2017 by the author(s).\nMethods that evaluate \u03c0e while selecting actions according to \u03c0e are termed on-policy. Previous work has addressed variance reduction for on-policy returns (Zinkevich et al., 2006; White & Bowling, 2009; Veness et al., 2011). An alternative approach is to estimate the performance of \u03c0e while following a different, behavior policy, \u03c0b. Methods that evaluate \u03c0e with data generated from \u03c0b are termed offpolicy. Importance sampling (IS) is one standard approach for using off-policy data in RL. IS reweights returns observed while executing \u03c0b such that they are unbiased estimates of the performance of \u03c0e.\nPresently, IS is usually used when off-policy data is already available or when executing \u03c0e is impractical. If \u03c0b is not chosen carefully, IS often has high variance (Thomas et al., 2015). For this reason, an implicit assumption in the RL community has generally been that on-policy evaluation is more accurate when it is feasible. However, IS can also be used for variance reduction when done with an appropriately selected distribution of returns (Hammersley & Handscomb, 1964). While IS-based variance reduction has been explored in RL, this prior work has required knowledge of the environment\u2019s transition probabilities and remains onpolicy (Desai & Glynn, 2001; Frank et al., 2008; Ciosek & Whiteson, 2017). In contrast to this earlier work, we show how careful selection of the behavior policy can lead to lower variance policy evaluation than using the evaluation policy and do not require knowledge of the environment\u2019s transition probabilities.\nIn this paper, we formalize the selection of \u03c0b as the behavior policy search problem. We introduce a method for this problem that adapts the policy parameters of \u03c0b with gradient descent on the variance of importance-sampling. Empirically we demonstrate behavior policy search with our method lowers the mean squared error of estimates compared to on-policy estimates. To the best of our knowledge, this work is the first to propose adapting the behavior policy to obtain better policy evaluation in RL. Furthermore we present the first method to address this problem."}, {"heading": "2. Preliminaries", "text": "This section details the policy evaluation problem setting, the Monte Carlo and Advantage Sum on-policy methods, and importance-sampling for off-policy evaluation.\nar X\niv :1\n70 6.\n03 46\n9v 1\n[ cs\n.A I]\n1 2\nJu n\n20 17"}, {"heading": "2.1. Background", "text": "We use notational standard MDPNv1 (Thomas, 2015), and for simplicity, we assume that S,A, and R are finite.1 Let H := (S0, A0, R0, S1, . . . , SL, AL, RL) be a trajectory and g(H) := \u2211L t=0 \u03b3\ntRt be the discounted return of trajectory H . Let \u03c1(\u03c0) := E[g(H)|H \u223c \u03c0] be the expected discounted return when the stochastic policy \u03c0 is used from S0 sampled from the initial state distribution. In this work, we consider parameterized policies, \u03c0\u03b8, where the distribution over actions is determined by the vector \u03b8. We assume that the transitions and reward function are unknown and that L is finite.\nWe are given an evaluation policy, \u03c0e, for which we would like to estimate \u03c1(\u03c0e). We assume there exists a policy parameter vector \u03b8e such that \u03c0e = \u03c0\u03b8e and that this vector is known. We consider an incremental setting where, at iteration i, we sample a single trajectory Hi with a policy \u03c0\u03b8i and add {Hi,\u03b8i} to a set D. We use Di to denote the set at iteration i. Methods that always (i.e., \u2200i) choose \u03b8i = \u03b8e are on-policy; otherwise, the method is off-policy. A policy evaluation method, PE, uses all trajectories in Di to estimate \u03c1(\u03c0e). Our goal is to design a policy evaluation algorithm that produces estimates of \u03c1(\u03c0e) that have low mean squared error (MSE). Formally, the goal of policy evaluation with PE is to minimize (PE(Di)\u2212 \u03c1(\u03c0e))2. While other measures of policy evaluation accuracy could be considered, we follow earlier work in using MSE (e.g., (Thomas & Brunskill, 2016; Precup et al., 2000)).\nWe focus on unbiased estimators of \u03c1(\u03c0e). While biased estimators (e.g., bootstrapping methods (Sutton & Barto, 1998), approximate models (Kearns & Singh, 2002), etc.) can sometimes produce lower MSE estimates they are problematic for high risk applications requiring confidence intervals. For unbiased estimators, minimizing variance is equivalent to minimizing MSE."}, {"heading": "2.2. Monte-Carlo Estimates", "text": "Perhaps the most commonly used policy evaluation method is the on-policy Monte-Carlo (MC) estimator. The estimate of \u03c1(\u03c0e) at iteration i is the average return:\nMC(Di) := 1\ni+ 1 i\u2211 j=0 L\u2211 t=0 \u03b3tRt = 1 i+ 1 i\u2211 j=0 g(Hj).\nThis estimator is unbiased and strongly consistent given mild assumptions.2 However, this method can have high variance.\n1The methods, and theoretical results discussed in this paper are applicable to both finite and infinite S,A and R as well as partially-observable Markov decision processes.\n2Being a strongly consistent estimator of \u03c1(\u03c0e) means that"}, {"heading": "2.3. Advantage Sum Estimates", "text": "Like the Monte-Carlo estimator, the advantage sum (ASE) estimator selects \u03b8i = \u03b8e for all i. However, it introduces a control variate to reduce the variance without introducing bias. This control variate requires an approximate model of the MDP to be provided. Let the reward function of this model be given as r\u0302(s, a). Let q\u0302\u03c0e(st, at) = E[ \u2211L t\u2032=t \u03b3\nt\u2032 r\u0302(st\u2032 , at\u2032)] and v\u0302\u03c0e(st) = E[q\u0302\u03c0e(st, at)|at \u223c \u03c0e], i.e., the action-value function and state-value function of \u03c0e in this approximate model. Then, the advantage sum estimator is given by:\nAS(Di) := 1\ni+ 1 i\u2211 j=0 L\u2211 t=0 \u03b3t(Rt\u2212 q\u0302\u03c0e(St, At)+ v\u0302\u03c0e(St)).\nIntuitively, ASE is replacing part of the randomness of the Monte Carlo return with the known expected return under the approximate model. Provided q\u03c0e(St, At)\u2212 v\u0302\u03c0e(St) is sufficiently correlated with Rt, the variance of ASE is less than that of MC.\nNotice that, like the MC estimator, the ASE estimator is on-policy, in that the behavior policy is always the policy that we wish to evaluate. Intuitively it may seems like this choice should be optimal. However, we will show that it is not\u2014selecting behavior policies that are different from the evaluation policy can result in estimates of \u03c1(\u03c0e) that have lower variance."}, {"heading": "2.4. Importance Sampling", "text": "Importance Sampling is a method for reweighting returns from a behavior policy, \u03b8, such that they are unbiased returns from the evaluation policy. In RL, the re-weighted IS return of a trajectory, H , sampled from \u03c0\u03b8 is:\nIS(H,\u03b8) := g(H) L\u220f t=0 \u03c0e(St|At) \u03c0\u03b8(St|At) .\nThe IS off-policy estimator is then a Monte Carlo estimate of E [IS(H,\u03b8)|H \u223c \u03c0\u03b8]:\nIS(Di) := 1\ni+ 1 i\u2211 j=0 IS(Hj ,\u03b8j).\nIn RL, importance sampling allows off-policy data to be used as if it were on-policy. In this case the variance of the IS estimate is often much worse than the variance of on-policy MC estimates because the behavior policy is not\nPr ( lim i\u2192\u221e MC(Di) = \u03c1(\u03c0e) ) = 1. If \u03c1(\u03c0e) exists, MC is strongly consistent by the Khintchine Strong law of large numbers (Sen & Singer, 1993).\nchosen to minimize variance, but is a policy that is dictated by circumstance."}, {"heading": "3. Behavior Policy Search", "text": "Importance sampling was originally intended as a variance reduction technique for Monte Carlo evaluation (Hammersley & Handscomb, 1964). When an evaluation policy rarely samples trajectories with high magnitude returns a Monte Carlo evaluation will have high variance. If a behavior policy can increase the probability of observing such trajectories then the off-policy IS estimate will have lower variance than an on-policy Monte Carlo estimate. In this section we first describe the theoretical potential for variance reduction with an appropriately selected behavior policy. In general this policy will be unknown. Thus, we propose a policy evaluation subproblem \u2014 the behavior policy search problem \u2014 solutions to which will adapt the behavior policy to provide lower mean squared error policy performance estimates. To the best of our knowledge, we are the first to propose behavior policy adaptation for policy evaluation."}, {"heading": "3.1. The Optimal Behavior Policy", "text": "An appropriately selected behavior policy can lower variance to zero. While this fact is generally known for importance-sampling, we show here that this policy exists for any MDP and evaluation policy under two restrictive assumptions: all returns are positive and the domain is deterministic. In the following section we describe how an initial policy can be adapted towards the optimal behavior policy even when these conditions fail to hold.\nLet w\u03c0(H) := \u220fL t=0 \u03c0(At|St). Consider a behavior policy \u03c0?b such that for any trajectory, H:\n\u03c1(\u03c0e) = IS(H,\u03c0 ? b ) = g(H)\nw\u03c0e(H) w\u03c0?b (H) .\nRearranging the terms of this expressions yields:\nw\u03c0?b (H) = g(H) w\u03c0e(H)\n\u03c1(\u03c0e) .\nThus, if we can select \u03c0?b such that the probability of observing any H \u223c \u03c0?b is g(H) \u03c1(\u03c0e)\ntimes the likelihood of observing H \u223c \u03c0e then the IS estimate has zero MSE with only a single sampled trajectory. Regardless of g(H), the importance-sampled return will equal \u03c1(\u03c0e).\nFurthermore, the policy \u03c0?b exists within the space of all feasible stochastic policies. Consider that a stochastic policy can be viewed as a mixture policy over time-dependent (i.e., action selection depends on the current time-step) deterministic policies. For example, in an MDP with one state, two actions and a horizon of L there are 2L possible time-dependent deterministic policies, each of which\ndefines a unique sequence of actions. We can express any evaluation policy as a mixture of these deterministic policies. The optimal behavior policy \u03c0?b can be expressed similarly and thus the optimal behavior policy exists.\nUnfortunately, the optimal behavior policy depends on the unknown value \u03c1(\u03c0e) as well as the unknown reward function R (via g(H)). Thus, while there exists an optimal behavior policy for IS \u2013 which is not \u03c0e \u2013 in practice we cannot analytically determine \u03c0?b . Additionally, \u03c0 ? b may not be representable by any \u03b8 in our policy class."}, {"heading": "3.2. The Behavior Policy Search Problem", "text": "Since the optimal behavior policy cannot be analytically determined, we instead propose the behavior policy search (BPS) problem for finding \u03c0b that lowers the MSE of estimates of \u03c1(\u03c0e). A BPS problem is defined by the inputs:\n1. An evaluation policy \u03c0e with policy parameters \u03b8e. 2. An off-policy policy evaluation algorithm,\nOPE(H,\u03b8), that takes a trajectory, H \u223c \u03c0\u03b8, or, alternatively, a set of trajectories, and returns an estimate of \u03c1(\u03c0e).\nA BPS solution is a policy, \u03c0\u03b8b such that off-policy estimates with OPE have lower MSE than on-policy estimates. Methods for this problem are BPS algorithms.\nRecall we have formalized policy evaluation within an incremental setting where one trajectory for policy evaluation is generated each iteration. At the ith iteration, a BPS algorithm selects a behavior policy that will be used to generate a trajectory, Hi. The policy evaluation algorithm, OPE, then estimates \u03c1(\u03c0e) using trajectories in Di. Naturally, the selection of the behavior policy depends on how OPE estimates \u03c1(\u03c0e).\nIn a BPS problem, the ith iteration proceeds as follows. First, given all of the past behavior policies, {\u03b8i}i\u22121i=0, and the resulting trajectories, {Hi}i\u22121i=0, the BPS algorithm must select \u03b8i. The policy \u03c0\u03b8i is then run for one episode to create the trajectory Hi. Then the BPS algorithm uses OPE to estimate \u03c1(\u03c0e) given the available data, Di := {(\u03b8i, Hi)}ii=0. In this paper, we consider the one-step problem of selecting \u03b8i and estimating \u03c1(\u03c0e) at iteration i in a way that minimizes MSE. That is, we do not consider how our selection of \u03b8i will impact our future ability to select an appropriate \u03b8j for j > i and thus to produce more accurate estimates in the future.\nOne natural question is: if we are given a limit on the number of trajectories that can be sampled, is it better to \u201cspend\u201d some of our limited trajectories on BPS instead of using on-policy estimates? Since each OPE(Hi,\u03b8i) is an unbiased estimator of \u03c1(\u03c0e), we can use all sampled trajectories to compute OPE(Di). Provided for all itera-\ntions, Var[OPE(H,\u03b8i)] \u2264 V ar[MC] then, in expectation, a BPS algorithm will always achieve lower MSE than MC, showing that it is, in fact, worthwhile to do so. This claim is supported by our empirical study."}, {"heading": "4. Behavior Policy Gradient Theorem", "text": "We now introduce our primary contributions: an analytic expression for the gradient of the mean squared error of the IS estimator and a stochastic gradient descent algorithm that adapts \u03b8 to minimize the MSE between the IS estimate and \u03c1(\u03c0e). Our algorithm \u2014 Behavior Policy Gradient (BPG) \u2014 begins with on-policy estimates and adapts the behavior policy with gradient descent on the MSE with respect to \u03b8. The gradient of the MSE with respect to the policy parameters is given by the following theorem: Theorem 1.\n\u2202\n\u2202\u03b8 MSE[IS(H,\u03b8)] = E\n[ \u2212 IS(H,\u03b8)2\nL\u2211 t=0 \u2202 \u2202\u03b8 log \u03c0\u03b8(At|St)\n]\nwhere the expectation is taken over H \u223c \u03c0\u03b8.\nProof. Proofs for all theoretical results are included in Appendix A.\nBPG uses stochastic gradient descent in place of exact gradient descent: replacing the intractable expectation in Theorem 1 with an unbiased estimate of the true gradient. In our experiments, we sample a batch, Bi, of k trajectories with \u03c0\u03b8i to lower the variance of the gradient estimate at iteration i. In the BPS setting, sampling a batch of trajectories is equivalent to holding \u03b8 fixed for k iterations and then updating \u03b8 with the k most recent trajectories used to compute the gradient estimate.\nFull details of BPG are given in Algorithm 1. At iteration i, BPG samples a batch, Bi, of k trajectories and adds {(\u03b8i, Hi)ki=0} to a data set D (Lines 4-5). Then BPG updates \u03b8 with an empirical estimate of Theorem 1 (Line 6). After n iterations, the BPG estimate of \u03c1(\u03c0e) is IS(Dn) as defined in Section 2.4.\nGiven that the step-size, \u03b1i, is consistent with standard gradient descent convergence conditions, BPG will converge to a behavior policy that locally minimizes the variance (Bertsekas & Tsitsiklis, 2000). At best, BPG converges to the globally optimal behavior policy within the parameterization of \u03c0e. Since the parameterization of \u03c0e determines the class of representable distributions it is possible that the theoretically optimal behavior policy is unrepresentable under this parameterization. Nevertheless, a suboptimal behavior policy still yields better estimates of \u03c1(\u03c0e), provided it decreases variance compared to on-policy returns.\nAlgorithm 1 Behavior Policy Gradient Input: Evaluation policy parameters, \u03b8e, batch size k, a step-size for each iteration, \u03b1i, and number of iterations n. Output: Final behavior policy parameters \u03b8n and the IS estimate of \u03c1(\u03c0e) using all sampled trajectories. 1: \u03b80 \u2190 \u03b8e 2: D0 = {} 3: for all i \u2208 0...n do 4: Bi = Sample k trajectories H \u223c \u03c0\u03b8i 5: Di+1 = Di \u222a Bi\n6: \u03b8i+1 = \u03b8i + \u03b1ik \u2211 H\u2208B IS(H,\u03b8)2 L\u2211 t=0 \u2202 \u2202\u03b8 log \u03c0\u03b8i(At|St) 7: end for 8: Return \u03b8n, IS(Dn)"}, {"heading": "4.1. Control Variate Extension", "text": "In cases where an approximate model is available, we can further lower variance adapting the behavior policy of the doubly robust estimator (Jiang & Li, 2016; Thomas & Brunskill, 2016). Based on a similar intuition as the Advantage Sum estimator (Section 2.3), the Doubly Robust (DR) estimator uses the value functions of an approximate model as a control variate to lower the variance of importancesampling.3 We show here that we can adapt the behavior policy to lower the mean squared error of DR estimates. We denote this new method DR-BPG for Doubly Robust Behavior Policy Gradient.\nLet w\u03c0,t(H) = \u220ft i=0 \u03c0(At|St) and recall that v\u0302\u03c0e and q\u0302\u03c0e are the state and action value functions of \u03c0e in the approximate model. The DR estimator is:\nDR(H,\u03b8) := v\u0302(S0)+ L\u2211 t=0 w\u03c0e,t w\u03c0\u03b8 ,t (Rt\u2212q\u0302\u03c0e(St, At)+v\u0302\u03c0e(St+1)).\nWe can reduce the mean squared error of DR with gradient descent using unbiased estimates of the following corollary to Theorem 1: Corollary 1.\n\u2202\n\u2202\u03b8 MSE [DR(H,\u03b8)] = E[(DR(H,\u03b8)2 L\u2211 t=0 \u2202 \u2202\u03b8 log \u03c0\u03b8(At|St)\n\u2212 2DR(H,\u03b8)( L\u2211 t=0 \u03b3t\u03b4t w\u03c0e,t w\u03b8,t t\u2211 i=0 \u2202 \u2202\u03b8 log \u03c0\u03b8(Ai|Si))]\nwhere \u03b4t = Rt\u2212 q\u0302(St, At) + v\u0302(St+1) and the expectation is taken over H \u223c \u03c0\u03b8.\nThe first term of \u2202\u2202\u03b8MSE is analogous to the gradient of the importance-sampling estimate with IS(H,\u03b8) replaced\n3DR lowers the variance of per-decision importance-sampling which importance samples the per time-step reward.\nby DR(H,\u03b8). The second term accounts for the covariance of the DR terms.\nAS and DR both assume access to a model, however, they make no assumption about where the model comes from except that it must be independent of the trajectories used to compute the final estimate. In practice, AS and DR perform best when all trajectories are used to estimate the model and then used to estimate \u03c1(\u03c0e) (Thomas & Brunskill, 2016). However, for DR-BPG, changes to the model change the surface of the MSE objective we seek to minimize and thus DR-BPG will only converge once the model stops changing. In our experiments, we consider both a changing and a fixed model."}, {"heading": "4.2. Connection to REINFORCE", "text": "BPG is closely related to existing work in policy gradient RL (c.f., (Sutton et al., 2000)) and we draw connections between one such method and BPG to illustrate how BPG changes the distribution of trajectories. REINFORCE (Williams, 1992) attempts to maximize \u03c1(\u03c0\u03b8) through gradient ascent on \u03c1(\u03c0\u03b8) using the following unbiased gradient of \u03c1(\u03c0\u03b8):\n\u2202\n\u2202\u03b8 \u03c1(\u03c0\u03b8) = E\n[ g(H)\nL\u2211 t=0 \u2202 \u2202\u03b8 log \u03c0\u03b8(At|St) \u2223\u2223\u2223\u2223\u2223H \u223c \u03c0\u03b8 ] .\nIntuitively, REINFORCE increases the probability of all actions taken during H as a function of g(H). This update increases the probability of actions that lead to high return trajectories. BPG can be interpreted as REINFORCE where the return of a trajectory is the square of its importance-sampled return. Thus BPG increases the probability of all actions taken along H as a function of IS(H,\u03b8)2. The magnitude of IS(H,\u03b8)2 depends on two qualities of H:\n1. g(H)2 is large (i.e., a high magnitude event). 2. H is rare relative to its probability under the evalua-\ntion policy (i.e., \u220fL t=0 \u03c0e(At|St) \u03c0\u03b8(At|St) is large).\nThese two qualities demonstrate a balance in how BPG changes trajectory probabilities. Increasing the probability of a trajectory under \u03c0\u03b8 will decrease IS(H,\u03b8)2 and so BPG increases the probability of a trajectory when g(H)2 is large enough to offset the decrease in IS(H,\u03b8)2 caused by decreasing the importance weight."}, {"heading": "5. Empirical Study", "text": "This section presents an empirical study of variance reduction through behavior policy search. We design our experiments to answer the following questions:\n\u2022 Can behavior policy search with BPG reduce policy evaluation MSE compared to on-policy estimates in\nboth tabular and continuous domains? \u2022 Does adapting the behavior policy of the Doubly Ro-\nbust estimator with DR-BPG lower the MSE of the Advantage Sum estimator? \u2022 Does the rarety of actions that cause high magnitude rewards affect the performance gap between BPG and Monte Carlo estimates?"}, {"heading": "5.1. Experimental Set-up", "text": "We address our first experimental question by evaluating BPG in three domains. We briefly describe each domain here; full details are available in appendix C.\nThe first domain is a 4x4 Gridworld. We obtain two evaluation policies by applying REINFORCE to this task, starting from a policy that selects actions uniformly at random. We then select one evaluation policy, \u03c01, from the early stages of learning \u2013 an improved policy but still far from converged \u2013 and one after learning has converged, \u03c02. We run all experiments once with \u03c0e := \u03c01 and a second time with \u03c0e := \u03c02.\nOur second and third tasks are the continuous control Cartpole Swing Up and Acrobot tasks implemented within RLLAB (Duan et al., 2016). The evaluation policy in each domain is a neural network that maps the state to the mean of a Gaussian distribution. Policies are partially optimized with trust-region policy optimization (Schulman et al., 2015) applied to a randomly initialized policy."}, {"heading": "5.2. Main Results", "text": "Gridworld Experiments Figure 1 compares BPG to Monte Carlo for both Gridworld policies, \u03c01 and \u03c02. Our main point of comparison is the mean squared error (MSE) of both estimates at iteration i over 100 trials. For \u03c01, BPG significantly reduces the MSE of on-policy estimates (Figure 1a). For \u03c02, BPG also reduces MSE, however, it is only a marginal improvement.\nAt the end of each trial we used the final behavior policy to collect 100 more trajectories and estimate \u03c1(\u03c0e). In comparison to a Monte Carlo estimate with 100 trajectories from \u03c01, MSE is 85.48 % lower with this improved behavior policy. For \u03c02, the MSE is 31.02 % lower. This result demonstrates that BPG can find behavior policies that substantially lower MSE.\nTo understand the disparity in performance between these two instances of policy evaluation, we plot the distribution of g(H) under \u03c0e (Figures 1c and 1d). These plots show the variance of \u03c01 to be much higher; it sometimes samples returns with twice the magnitude of any sampled by \u03c02. To quantify this difference, we also measure the variance of IS(H,\u03b8i) as E [ IS(H)2\n\u2223\u2223H \u223c \u03c0\u03b8i]\u2212E [IS(H)|H \u223c \u03c0\u03b8i ]2 where the expectations are estimated with 10,000 trajecto-\nries. This evaluation is repeated 5 times per iteration and the reported variance is the mean over these evaluations. The decrease in variance for each policy is shown in Figure 1e. The high initial variance means there is much more room for BPG to improve the behavior policy when \u03b8e is the partially optimized policy.\nWe also test the sensitivity of BPG to the learning rate parameter. A critical issue in the use of BPG is selecting the\nstep size parameter \u03b1. If \u03b1 is set too high we risk making too large of an update to \u03b8 \u2014 potentially stepping to a worse behavior policy. If we are too conservative then it will take many iterations for a noticeable improvement over Monte Carlo estimation. Figure 1f shows variance reduction for a number of different \u03b1 values in the GridWorld domain. We found BPG in this domain was robust to a variety of step size values. We do not claim this result is representative for all problem domains; stepsize selection in the behavior policy search problem is an important area for future work.\nContinuous Control Figure 2 shows reduction of MSE on the Cartpole Swing-up and Acrobot domains. Again we see that BPG reduces MSE faster than Monte Carlo evaluation. In contrast to the discrete Gridworld experiment, this experiment demonstrates the applicability of BPG to the continuous control setting. While BPG significantly outperforms Monte Carlo evaluation in Cart-pole Swingup, the gap is much smaller in Acrobot. This result also demonstrates BPG (and behavior policy search) when the policy must generalize across different states."}, {"heading": "5.3. Control Variate Extensions", "text": "In this section, we evaluate the combination of modelbased control variates with behavior policy search. Specifically, we compare the AS estimator with Doubly Robust BPG (DR-BPG). In these experiments we use a 10x10 stochastic gridworld. The added stochasticity increases the difficulty of building an accurate model from trajectories.\nSince these methods require a model we construct this model in one of two ways. The first method uses all trajectories in D to build the model and then uses the same set to estimate \u03c1(\u03c0e) with ASE or DR. The second method uses trajectories from the first 10 iterations to build the model and then fixes the model for the remaining iterations. For DR-BPG, behavior policy search starts at iteration 10 un-\nder this second condition. We call the first method \u201cupdate\u201d and the second method \u201cfixed.\u201d The update method invalidates the theoretical guarantees of these methods but learns a more accurate model. In both instances, we build maximum likelihood tabular models.\nFigure 3 demonstrates that combining BPG with a modelbased control variate (DR-BPG) can lead to further reduction of MSE compared to the control variate alone (ASE). Specifically, with the fixed model, DR-BPG outperformed all other methods. DR-BPG using the update method for building the model performed competitively with ASE although not statistically significantly better. We also evaluate the final learned behavior policy of the fixed model variant of DR-BPG. For a batch size of 100 trajectories, the DR estimator with this behavior policy improves upon the ASE estimator with the same model by 56.9 %.\nFor DR-BPG, estimating the model with all data still allowed steady progress towards lower variance. This result is interesting since a changing model changes the surface of our variance objective and thus gradient descent on the variance has no theoretical guarantees of convergence. Empirically, we observe that setting the learning rate for DRBPG was more challenging for either model type. Thus while we have shown BPG can be combined with control variates, more work is needed to produce a robust method."}, {"heading": "5.4. Rareness of Event", "text": "Our final experiment aims to understand how the gap between on- and off-policy variance is affected by the probability of rare events. The intuition for why behavior policy search can lower the variance of on-policy estimates is that a well selected behavior policy can cause rare and high magnitude events to occur. We test this intuition by varying the probability of a rare, high magnitude event and observing how this change affects the performance gap between on- and off-policy evaluation. For this experiment, we use a variant of the deterministic Gridworld where taking the UP action in the initial state (the upper left corner) causes a transition to the terminal state with a reward of +50. We use \u03c01 from our earlier Gridworld experiments but we vary the probability of choosing UP when in the initial state. So with probability p the agent will receive a large reward and end the trajectory. We use a constant learning rate of 10\u22125 for all values of p and run BPG for 500 iterations. We plot the relative decrease of the variance as a function of p over 100 trials for each value of p. We use relative variance to normalize across problem instances. Note that under this measure, even when p is close to 1, the relative variance is not equal to zero because as p approaches 1 the initial variance also goes to zero.\nThis experiment illustrates that as the initial variance increases, the amount of improvement BPG can achieve increases. As p becomes closer to 1, the initial variance becomes closer to zero and BPG barely improves over the variance of Monte Carlo (in terms of absolute variance there is no improvement). When the \u03c0e rarely takes the high rewarding UP action (p close to 0), BPG improves policy evaluation by increasing the probability of this action. This experiment supports our intuition for why off-policy evaluation can outperform on-policy evaluation."}, {"heading": "6. Related Work", "text": "Behavior policy search and BPG are closely related to existing work on adaptive importance-sampling. While adaptive importance-sampling has been studied in the estimation literature, we focus here on adaptive importancesampling for MDPs and Markov Reward Processes (i.e., an MDP with a fixed policy). Existing work on adaptive IS in RL has considered changing the transition probabilities to lower the variance of policy evaluation (Desai & Glynn, 2001; Frank et al., 2008) or lower the variance of policy gradient estimates (Ciosek & Whiteson, 2017). Since the transition probabilities are typically unknown in RL, adapting the behavior policy is a more general approach to adaptive IS. Ciosek and Whiteson also adapt the distribution of trajectories with gradient descent on the variance (Ciosek & Whiteson, 2017) with respect to parameters of the transition probabilities. The main focus of this work is increasing\nthe probability of simulated rare events so that policy improvement can learn an appropriate response. In contrast, we address the problem of policy evaluation and differentiate with respect to the (known) policy parameters.\nThe cross-entropy method (CEM) is a general method for adaptive importance-sampling. CEM attempts to minimize the Kullback-Leibler divergence between the current sampling distribution and the optimal sampling distribution. As discussed in Section 3.1, this optimal behavior policy only exists under a set of restrictive conditions. In contrast we adapt the behavior policy by minimizing variance.\nOther methods exist for lowering the variance of on-policy estimates. In addition to the control variate technique used by the Advantage Sum estimator (Zinkevich et al., 2006; White & Bowling, 2009), Veness et al. consider using common random numbers and antithetic variates to reduce the variance of roll-outs in Monte Carlo Tree Search (MCTS) (2011). These techniques require a model of the environment (as is typical for MCTS) and do not appear to be applicable to the general RL policy evaluation problem. BPG could potentially be applied to find a lower variance rollout policy for MCTS.\nIn this work we have focused on unbiased policy evaluation. When the goal is to minimize MSE it is often permissible to use biased methods such as temporal difference learning (van Seijen & Sutton, 2014), model-based policy evaluation (Kearns & Singh, 2002; Strehl et al., 2009), or variants of weighted importance sampling (Precup et al., 2000). It may be possible to use similar ideas to BPG to reduce bias and variance although this appears to be difficult since the bias contribution to the mean squared error is squared and thus any gradient involving bias requires knowledge of the estimator\u2019s bias. We leave behavior policy search with biased off-policy methods to future work."}, {"heading": "7. Discussion and Future Work", "text": "Our experiments demonstrate that behavior policy search with BPG can lower the variance of policy evaluation. One open question is characterizing the settings where adapting the behavior policy substantially improves over on-policy estimates. Towards answering this question, our Gridworld experiment showed that when \u03c0e has little variance, BPG can only offer marginal improvement. BPG increases the probability of observing rare events with a high magnitude. If the evaluation policy never sees such events then there is little benefit to using BPG. However, in expectation and with an appropriately selected step-size, BPG will never lower the data-efficiency of policy evaluation.\nIt is also necessary that the evaluation policy contributes to the variance of the returns. If all variance is due to the environment then it seems unlikely that BPG will offer much\nimprovement. For example, Ciosek and Whiteson (2017) consider a variant of the Mountain Car task where the dynamics can trigger a rare event \u2014 independent of the action \u2014 in which rewards are multiplied by 1000. No behavior policy adaptation can lower the variance due to this event.\nOne limitation of gradient-based BPS methods is the necessity of good step-size selection. In theory, BPG can never lead to worse policy evaluation compared to on-policy estimates. In practice, a poorly selected step-size may cause a step to a worse behavior policy at step iwhich may increase the variance of the gradient estimate at step i + 1. Future work could consider methods for adaptive step-sizes, second order methods, or natural behavior policy gradients.\nOne interesting direction for future work is incorporating behavior policy search into policy improvement. A similar idea was explored by Ciosek and Whiteson who explored off-environment learning to improve the performance of policy gradient methods (2017). The method presented in that work is limited to simulated environments with differential dynamics. Adapting the behavior policy is a potentially much more general approach."}, {"heading": "8. Conclusion", "text": "We have introduced the behavior policy search problem in order to improve estimation of \u03c1(\u03c0e) for an evaluation policy \u03c0e. We present a solution \u2014 Behavior Policy Gradient \u2014 for this problem which adapts the behavior policy with stochastic gradient descent on the variance of the importance-sampling estimator. Experiments demonstrate BPG lowers the mean squared error of estimates of \u03c1(\u03c0e) compared to on-policy estimates. We also demonstrate BPG can further decrease the MSE of estimates in conjunction with a model-based control variate method."}, {"heading": "9. Acknowledgements", "text": "We thank Daniel Brown and the anonymous reviewers for useful comments on the work and its presentation. This work has taken place in the Personal Autonomous Robotics Lab (PeARL) and Learning Agents Research Group (LARG) at the Artificial Intelligence Laboratory, The University of Texas at Austin. PeARL research is supported in part by NSF (IIS-1638107, IIS-1617639). LARG research is supported in part by NSF (CNS-1330072, CNS-1305287, IIS-1637736, IIS-1651089), ONR (21C184-01), AFOSR (FA9550-14-1-0087), Raytheon, Toyota, AT&T, and Lockheed Martin. Josiah Hanna is supported by an NSF Graduate Research Fellowship. Peter Stone serves on the Board of Directors of Cogitai, Inc. The terms of this arrangement have been reviewed and approved by the University of Texas at Austin in accordance with its policy on objectivity in research."}, {"heading": "A. Proof of Theorem 1", "text": "In Appendix A, we give the full derivation of our primary theoretical contribution \u2014 the importance-sampling (IS) variance gradient. We also present the variance gradient for the doubly-robust (DR) estimator.\nWe first derive an analytic expression for the gradient of the variance of an arbitrary, unbiased off-policy policy evaluation estimator, OPE(H,\u03b8). Importance-sampling is one such off-policy policy evaluation estimator. From our general derivation we derive the gradient of the variance of the IS estimator and then extend to the DR estimator.\nA.1. Variance Gradient of an Unbiased Off-Policy Policy Evaluation Method\nWe first present a lemma from which \u2202\u2202\u03b8 MSE[IS(H,\u03b8)] and \u2202 \u2202\u03b8 MSE[DR(H,\u03b8)] can both be derived.\nLemma 1 gives the gradient of the mean squared error (MSE) of an unbiased off-policy policy evaluation method.\nLemma 1.\n\u2202\n\u2202\u03b8 MSE[OPE(H,\u03b8)] = E\n[ OPE(H,\u03b8)2(\nL\u2211 t=0 \u2202 \u2202\u03b8 log \u03c0\u03b8(At|St)) + \u2202 \u2202\u03b8 OPE(H,\u03b8)2 \u2223\u2223\u2223\u2223\u2223H \u223c \u03c0\u03b8 ]\nProof. We begin by decomposing Pr(H|\u03c0) into two components\u2014one that depends on \u03c0 and the other that does not. Let\nw\u03c0(H) := L\u220f t=0 \u03c0(At|St),\nand p(H) := Pr(H|\u03c0)/w\u03c0(H),\nfor any \u03c0 such that H \u2208 supp(\u03c0) (any such \u03c0 will result in the same value of p(H)). These two definitions mean that Pr(H|\u03c0) = p(H)w\u03c0(H).\nThe MSE of the OPE estimator is given by:\nMSE[OPE(H,\u03b8)] = Var[OPE(H,\u03b8)] + (E[OPE(H,\u03b8)]\u2212 \u03c1(\u03c0e))2\ufe38 \ufe37\ufe37 \ufe38 bias2 .\nSince the OPE estimator is unbiased, i.e., E[OPE(H,\u03b8)] = \u03c1(\u03c0e), the second term is zero and so:\nMSE(OPE(H,\u03b8)) =Var(OPE(H,\u03b8)) =E [ OPE(H,\u03b8)2 \u2223\u2223H \u223c \u03c0\u03b8]\u2212E[OPE(H,\u03b8)|H \u223c \u03c0\u03b8]2 =E [ OPE(H,\u03b8)2\n\u2223\u2223H \u223c \u03c0\u03b8]\u2212 \u03c1(\u03c0e)2 To obtain the MSE gradient, we differentiate MSE(OPE(H,\u03b8)) with respect to \u03b8:\n\u2202\n\u2202\u03b8 MSE[OPE(H,\u03b8)] =\n\u2202\n\u2202\u03b8\n[ E [ OPE(H,\u03b8)2 \u2223\u2223H \u223c \u03c0\u03b8]\u2212 \u03c1(\u03c0e)2] = \u2202\n\u2202\u03b8 EH\u223c\u03c0\u03b8\n[ OPE(H,\u03b8)2 ] = \u2202\n\u2202\u03b8 \u2211 H Pr(H|\u03b8)OPE(H,\u03b8)2\n= \u2211 H Pr(H|\u03b8) \u2202 \u2202\u03b8 OPE(H,\u03b8)2 +OPE(H,\u03b8)2 \u2202 \u2202\u03b8 Pr(H|\u03b8)\n= \u2211 H Pr(H|\u03b8) \u2202 \u2202\u03b8 OPE(H,\u03b8)2 +OPE(H,\u03b8)2p(H) \u2202 \u2202\u03b8 w\u03c0\u03b8 (H) (1)\nConsider the last factor of the last term in more detail:\n\u2202\n\u2202\u03b8 w\u03c0\u03b8 (H) =\n\u2202\n\u2202\u03b8 L\u220f t=0 \u03c0\u03b8(At|St)\n(a) = ( L\u220f t=0 \u03c0\u03b8(At|St) )( L\u2211 t=0 \u2202 \u2202\u03b8\u03c0\u03b8(At|St) \u03c0\u03b8(At|St) )\n=w\u03c0\u03b8 (H) L\u2211 t=0 \u2202 \u2202\u03b8 log (\u03c0\u03b8(At|St)) ,\nwhere (a) comes from the multi-factor product rule. Continuing from (1) we have that:\n\u2202\n\u2202\u03b8 MSE(OPE(H,\u03b8)) =E\n[ OPE(H,\u03b8)2\nL\u2211 t=0 \u2202 \u2202\u03b8 log (\u03c0\u03b8(At|St)) + \u2202 \u2202\u03b8 OPE(H,\u03b8)2 \u2223\u2223\u2223\u2223\u2223H \u223c \u03c0\u03b8 ] .\nA.2. Behavior Policy Gradient Theorem\nWe now use Lemma 1 to prove the Behavior Policy Gradient Theorem which is our main theoretical contribution.\nTheorem 2. \u2202\n\u2202\u03b8 MSE[IS(H,\u03b8)] = E\n[ \u2212 IS(H,\u03b8)2\nL\u2211 t=0 \u2202 \u2202\u03b8 log \u03c0\u03b8(At|St) \u2223\u2223\u2223\u2223\u2223H \u223c \u03c0\u03b8 ]\nwhere the expectation is taken over H \u223c \u03c0\u03b8.\nProof. We first derive \u2202\u2202\u03b8 IS(H,\u03b8) 2. Theorem 1 then follows directly from using \u2202\u2202\u03b8 IS(H,\u03b8) 2 as \u2202\u2202\u03b8 OPE(H,\u03b8) 2 in Lemma 1.\nIS(H,\u03b8)2 = ( w\u03c0e w\u03b8 g(H) )2 \u2202\n\u2202\u03b8 IS(H,\u03b8)2 =\n\u2202\n\u2202\u03b8\n( w\u03c0e(H)\nw\u03b8(H) g(H) )2 =2 \u00b7 g(H)w\u03c0e(H)\nw\u03b8(H)\n\u2202\n\u2202\u03b8\n( g(H) w\u03c0e(H)\nw\u03b8(H) ) (a) =\u2212 2 \u00b7 g(H)w\u03c0e(H)\nw\u03b8(H)\n( g(H) w\u03c0e(H)\nw\u03b8(H) ) L\u2211 t=0 \u2202 \u2202\u03b8 log \u03c0\u03b8(At|St)\n=\u2212 2 IS(H,\u03b8)2 L\u2211 t=0 \u2202 \u2202\u03b8 log \u03c0\u03b8(At|St)\nwhere (a) comes from the multi-factor product rule and using the likelihood-ratio trick (i.e., \u2202 \u2202\u03b8\u03c0\u03b8(A|S) \u03c0\u03b8(A|S) = log \u03c0\u03b8(A|S))\nSubstituting this expression into Lemma 1 completes the proof:\n\u2202\n\u2202\u03b8 MSE[IS(H,\u03b8)] = E\n[ \u2212 IS(H,\u03b8)2\nL\u2211 t=0 \u2202 \u2202\u03b8 log \u03c0\u03b8(At|St) \u2223\u2223\u2223\u2223\u2223H \u223c \u03c0\u03b8 ]\nA.3. Doubly Robust Estimator\nOur final theoretical result is a corollary to the Behavior Policy Gradient Theorem: an extension of the IS variance gradient to the Doubly Robust (DR) estimator. Recall that for a single trajectory DR is given as:\nDR(H,\u03b8) := v\u0302\u03c0e(S0) + L\u2211 t=0 \u03b3t w\u03c0e,t w\u03b8,t (Rt \u2212 q\u0302\u03c0e(St, At) + v\u0302\u03c0e(St+1))\nwhere v\u0302\u03c0e is the state-value function of \u03c0e under an approximate model, q\u0302\u03c0e is the action-value function of \u03c0e under the model, and w\u03c0,t := \u220ft j=0 \u03c0(Aj |Sj).\nThe gradient of the mean squared error of the DR estimator is given by the following corollary to the Behavior Policy Gradient Theorem: Corollary 2.\n\u2202\n\u2202\u03b8 MSE [DR(H,\u03b8)] = E[(DR(H,\u03b8)2 L\u2211 t=0 \u2202 \u2202\u03b8 log \u03c0\u03b8(At|St) \u2212 2DR(H,\u03b8)( L\u2211 t=0 \u03b3t\u03b4t w\u03c0e,t w\u03b8,t t\u2211 i=0 \u2202 \u2202\u03b8 log \u03c0\u03b8(Ai|Si))]\nwhere \u03b4t = Rt \u2212 q\u0302(St, At) + v\u0302(St+1) and the expectation is taken over H \u223c \u03c0\u03b8.\nProof. As with Theorem 1, we first derive \u2202\u2202\u03b8 DR(H,\u03b8) 2. Corollary 1 then follows directly from using \u2202\u2202\u03b8 DR(H,\u03b8) 2 as \u2202 \u2202\u03b8 OPE(H,\u03b8) 2 in Lemma 1.\nDR(H,\u03b8)2 = ( v\u0302\u03c0e(S0) +\nL\u2211 t=0 \u03b3t w\u03c0e,t w\u03b8,t (Rt \u2212 q\u0302\u03c0e(St, At) + v\u0302\u03c0e(St+1))\n)2\n\u2202\n\u2202\u03b8 DR(H,\u03b8)2 =\n\u2202\n\u2202\u03b8\n( v\u0302\u03c0e(S0) +\nL\u2211 t=0 \u03b3t w\u03c0e,t w\u03b8,t (Rt \u2212 q\u0302\u03c0e(St, At) + v\u0302\u03c0e(St+1))\n)2\n=2DR(H,\u03b8) \u2202\n\u2202\u03b8\n( v\u0302\u03c0e(S0) +\nL\u2211 t=0 \u03b3t w\u03c0e,t w\u03b8,t (Rt \u2212 q\u0302\u03c0e(St, At) + v\u0302\u03c0e(St+1))\n)\n=\u2212 2DR(H,\u03b8)( L\u2211 t=0 \u03b3t w\u03c0e,t w\u03b8,t (Rt \u2212 q\u0302\u03c0e(St, At) + v\u0302\u03c0e(St+1)) t\u2211 i=0 \u2202 \u2202\u03b8 log \u03c0\u03b8(Ai|Si))\nThus the DR(H,\u03b8) gradient is:\n= E [ DR(H,\u03b8)2\nL\u2211 t=0 \u2202 \u2202\u03b8 log \u03c0\u03b8(At|St)\u2212 2DR(H,\u03b8)( L\u2211 t=0 \u03b3t w\u03c0e,t w\u03b8,t (Rt \u2212 q\u0302\u03c0e(St, At) + v\u0302\u03c0e(St+1)) t\u2211 i=0 \u2202 \u2202\u03b8 log \u03c0\u03b8(Ai|Si)) \u2223\u2223\u2223\u2223\u2223H \u223c \u03c0\u03b8 ]\nThe expression for the DR behavior policy gradient is more complex than the expression for the IS behavior policy gradient. Lowering the variance of DR involves accounting for the covariance of the sum of terms. Intuitively, accounting for the covariance increases the complexity of the expression for the gradient."}, {"heading": "B. BPG\u2019s Off-Policy Estimates are Unbiased", "text": "This appendix proves that BPG\u2019s estimate is an unbiased estimate of \u03c1(\u03c0e). If only trajectories from a single \u03b8i were used then clearly IS(\u00b7,\u03b8i) is an unbiased estimate of \u03c1(\u03c0e). The difficulty is that the BPG\u2019s estimate at iteration n depends on all \u03b8i for i = 1 . . . n and each \u03b8i is not independent of the others. Nevertheless, we prove here that BPG produces an unbiased\nestimate of \u03c1(\u03c0e) at each iteration. Specifically, we will show that E [IS(Hn,\u03b8n)|\u03b80 = \u03b8e)] is an unbiased estimate of \u03c1(\u03c0e), where the IS estimate is conditioned on \u03b80 = \u03b8e. To make the dependence of \u03b8i on \u03b8i\u22121 explicit, we will write f(Hi\u22121) := \u03b8i where Hi\u22121 \u223c \u03c0\u03b8i\u22121 . We use Pr(h|\u03b8) as shorthand for Pr(H = h|\u03b8).\nE [IS(Hn,\u03b8n)|\u03b8 = \u03b8e)] = \u2211 h0 Pr(h0|\u03b80) \u2211 h1 Pr(h1|f(h0)) \u00b7 \u00b7 \u00b7 \u2211 hn\nPr(hn|f(hn\u22121)) IS(hn)\ufe38 \ufe37\ufe37 \ufe38 \u03c1(\u03c0e)\n=\u03c1(\u03c0e) \u2211 h0 Pr(h0|\u03b80) \u2211 h1 Pr(h1|f(h0)) \u00b7 \u00b7 \u00b7\n=\u03c1(\u03c0e)\nNotice that, even though BPG\u2019s off-policy estimates at each iteration are unbiased, they are not statistically independent. This means that concentration inequalities, like Hoeffding\u2019s inequality, cannot be applied directly. We conjecture that the conditional independence properties of BPG (specifically that Hi is independent of Hi\u22121 given \u03b8i), are sufficient for Hoeffding\u2019s inequality to be applicable."}, {"heading": "C. Supplemental Experiment Description", "text": "This appendix contains experimental details in addition to the details contained in Section 5 of the paper.\nGridworld: This domain is a 4x4 Gridworld with a terminal state with reward 10 at (3, 3), a state with reward \u221210 at (1, 1), a state with reward 1 at (1, 3), and all other states having reward \u22121. The action set contains the four cardinal directions and actions move the agent in its intended direction (except when moving into a wall which produces no movement). The agent begins in (0,0), \u03b3 = 1, and L = 100. All policies use softmax action selection with temperature 1 where the probability of taking an action a in a state s is given by:\n\u03c0(a|s) = e \u03b8sa\u2211\na\u2032 e \u03b8sa\u2032\nWe obtain two evaluation policies by applying REINFORCE to this task, starting from a policy that selects actions uniformly at random. We then select one evaluation policy from the early stages of learning \u2013 an improved policy but still far from converged \u2013, \u03c01, and one after learning has converged, \u03c02. We run our set of experiments once with \u03c0e := \u03c01 and a second time with \u03c0e := \u03c02. The ground truth value of \u03c1(\u03c0e) is computed with value iteration for both \u03c0e.\nStochastic Gridworld: The layout of this Gridworld is identical to the deterministic Gridworld except the terminal state is at (9, 9) and the +1 reward state is at (1, 9). When the agent moves, it moves in its intended direction with probability 0.9, otherwise it goes left or right with equal probability. Noise in the environment increases the difficulty of building an accurate model from trajectories.\nContinuous Control: We evaluate BPG on two continuous control tasks: Cart-pole Swing Up and Acrobot. Both tasks are implemented within RLLAB (Duan et al., 2016) (full details of the tasks are given in Appendix 1.1). The single task modification we make is that in Cart-pole Swing Up, when a trajectory terminates due to moving out of bounds we give a penalty of \u22121000. This modification increases the variance of \u03c0e. We use \u03b3 = 1 and L = 50. Policies are represented as conditional Gaussians with mean determined by a neural network with two hidden layers of 32 tanh units each and a state-independent diagonal covariance matrix. In Cart-pole Swing Up, \u03c0e was learned with 10 iterations of the TRPO algorithm (Schulman et al., 2015) applied to a randomly initialized policy. In Acrobot, \u03c0e was learned with 60 iterations. The ground truth value of \u03c1(\u03c0e) in both domains is computed with 1,000,000 Monte Carlo roll-outs.\nDomain Independent Details In all experiments we subtract a constant control variate (or baseline) in the gradient estimate from Theorem 1. The baseline is bi = E [ \u2212 IS(H)2 \u2223\u2223H \u223c \u03b8i\u22121] and our new gradient estimate is: E [ (\u2212 IS2\u2212bi)\nL\u2211 t=0 \u2202 \u2202\u03b8 log \u03c0\u03b8(At|St) \u2223\u2223\u2223\u2223\u2223H \u223c \u03c0\u03b8 ]\nAdding or subtracting a constant does not change the gradient in expectation since bi \u00b7 E [\u2211L t=0 \u2202 \u2202\u03b8 log \u03c0\u03b8(At|St) ] = 0. BPG with a baseline has lower variance so that the estimated gradient is closer in direction to the true gradient.\nWe use batch sizes of 100 trajectories per iteration for Gridworld experiments and size 500 for the continuous control tasks. The step-size parameter was determined by a sweep over [10\u22122, 10\u22126]\nEarly Stopping Criterion In all experiments we run BPG for a fixed number of iterations. In general, BPS can continue for a fixed number of iterations or until the variance of the IS estimator stops decreasing. The true variance is unknown but can be estimated by sampling a set of k trajectories with \u03b8i and computing the uncentered variance: 1 k \u2211k j=0 OPE(Hj ,\u03b8j)\n2. This measure can be used to empirically evaluate the quality of each \u03b8 or determine when a BPS algorithm should terminate behavior policy improvement."}], "references": [{"title": "Model-free intelligent diabetes management using machine learning", "author": ["Bastani", "Meysam"], "venue": "PhD thesis, Masters thesis, Department of Computing Science, University of Alberta,", "citeRegEx": "Bastani and Meysam.,? \\Q2014\\E", "shortCiteRegEx": "Bastani and Meysam.", "year": 2014}, {"title": "Gradient convergence in gradient methods with erros", "author": ["Bertsekas", "Dimitri P", "Tsitsiklis", "John N"], "venue": null, "citeRegEx": "Bertsekas et al\\.,? \\Q2000\\E", "shortCiteRegEx": "Bertsekas et al\\.", "year": 2000}, {"title": "OFFER: Offenvironment reinforcement learning", "author": ["Ciosek", "Kamil", "Whiteson", "Shimon"], "venue": "In Proceedings of the 31st AAAI Conference on Artificial Intelligence (AAAI),", "citeRegEx": "Ciosek et al\\.,? \\Q2017\\E", "shortCiteRegEx": "Ciosek et al\\.", "year": 2017}, {"title": "Simulation in optimization and optimization in simulation: A Markov chain perspective on adaptive Monte Carlo algorithms", "author": ["Desai", "Paritosh Y", "Glynn", "Peter W"], "venue": "In Proceedings of the 33rd conference on Winter simulation,", "citeRegEx": "Desai et al\\.,? \\Q2001\\E", "shortCiteRegEx": "Desai et al\\.", "year": 2001}, {"title": "Benchmarking deep reinforcement learning for continuous control", "author": ["Duan", "Yan", "Chen", "Xi", "Houthooft", "Rein", "Schulman", "John", "Abbeel", "Pieter"], "venue": "Proceedings of the 33rd International Conference on Machine Learning,", "citeRegEx": "Duan et al\\.,? \\Q2016\\E", "shortCiteRegEx": "Duan et al\\.", "year": 2016}, {"title": "Reinforcement learning in the presence of rare events", "author": ["Frank", "Jordan", "Mannor", "Shie", "Precup", "Doina"], "venue": "In Proceedings of the 25th International Conference on Machine learning,", "citeRegEx": "Frank et al\\.,? \\Q2008\\E", "shortCiteRegEx": "Frank et al\\.", "year": 2008}, {"title": "Monte Carlo methods, methuen & co", "author": ["JM Hammersley", "Handscomb", "DC"], "venue": "Ltd., London, pp", "citeRegEx": "Hammersley et al\\.,? \\Q1964\\E", "shortCiteRegEx": "Hammersley et al\\.", "year": 1964}, {"title": "Doubly robust off-policy evaluation for reinforcement learning", "author": ["Jiang", "Nan", "Li", "Lihong"], "venue": "In Proceedings of the 33rd International Conference on Machine Learning (ICML),", "citeRegEx": "Jiang et al\\.,? \\Q2016\\E", "shortCiteRegEx": "Jiang et al\\.", "year": 2016}, {"title": "Near-optimal reinforcement learning in polynomial time", "author": ["Kearns", "Michael", "Singh", "Satinder"], "venue": "Machine Learning,", "citeRegEx": "Kearns et al\\.,? \\Q2002\\E", "shortCiteRegEx": "Kearns et al\\.", "year": 2002}, {"title": "Continuous control with deep reinforcement learning", "author": ["Lillicrap", "Timothy P", "Hunt", "Jonathan J", "Pritzel", "Alexander", "Heess", "Nicolas", "Erez", "Tom", "Tassa", "Yuval", "Silver", "David", "Wierstra", "Daan"], "venue": "CoRR, abs/1509.02971,", "citeRegEx": "Lillicrap et al\\.,? \\Q2015\\E", "shortCiteRegEx": "Lillicrap et al\\.", "year": 2015}, {"title": "Eligibility traces for off-policy policy evaluation", "author": ["D. Precup", "R.S. Sutton", "S. Singh"], "venue": "In Proceedings of the 17th International Conference on Machine Learning,", "citeRegEx": "Precup et al\\.,? \\Q2000\\E", "shortCiteRegEx": "Precup et al\\.", "year": 2000}, {"title": "Trust region policy optimization", "author": ["Schulman", "John", "Levine", "Sergey", "Moritz", "Philipp", "Jordan", "Michael", "Abbeel", "Pieter"], "venue": "In Proceedings of the 32nd International Conference on Machine Learning ( ICML),", "citeRegEx": "Schulman et al\\.,? \\Q2015\\E", "shortCiteRegEx": "Schulman et al\\.", "year": 2015}, {"title": "Large Sample Methods in Statistics: An Introduction with Applications", "author": ["P.K. Sen", "J.M. Singer"], "venue": null, "citeRegEx": "Sen and Singer,? \\Q1993\\E", "shortCiteRegEx": "Sen and Singer", "year": 1993}, {"title": "Reinforcement learning in finite mdps: PAC analysis", "author": ["Strehl", "Alexander L", "Li", "Lihong", "Littman", "Michael L"], "venue": "Journal of Machine Learning Research,", "citeRegEx": "Strehl et al\\.,? \\Q2009\\E", "shortCiteRegEx": "Strehl et al\\.", "year": 2009}, {"title": "Reinforcement Learning: An Introduction", "author": ["Sutton", "Richard S", "Barto", "Andrew G"], "venue": null, "citeRegEx": "Sutton et al\\.,? \\Q1998\\E", "shortCiteRegEx": "Sutton et al\\.", "year": 1998}, {"title": "Policy gradient methods for reinforcement learning with function approximation", "author": ["Sutton", "Richard S", "McAllester", "David", "Singh", "Satinder", "Mansour", "Yishay"], "venue": "In Proceedings of the 13th Conference on Neural Information Processing Systems (NIPS),", "citeRegEx": "Sutton et al\\.,? \\Q2000\\E", "shortCiteRegEx": "Sutton et al\\.", "year": 2000}, {"title": "A notation for Markov decision processes", "author": ["Thomas", "Philip S"], "venue": "ArXiv, arXiv:1512.09075v1,", "citeRegEx": "Thomas and S.,? \\Q2015\\E", "shortCiteRegEx": "Thomas and S.", "year": 2015}, {"title": "Data-efficient off-policy policy evaluation for reinforcement learning", "author": ["Thomas", "Philip S", "Brunskill", "Emma"], "venue": "In Proceedings of the 33rd International Conference on Machine Learning (ICML),", "citeRegEx": "Thomas et al\\.,? \\Q2016\\E", "shortCiteRegEx": "Thomas et al\\.", "year": 2016}, {"title": "High confidence off-policy evaluation", "author": ["Thomas", "Philip S", "Theocharous", "Georgios", "Ghavamzadeh", "Mohammad"], "venue": "In Proceedings of the AAAI Conference on Artificial Intelligence (AAAI),", "citeRegEx": "Thomas et al\\.,? \\Q2015\\E", "shortCiteRegEx": "Thomas et al\\.", "year": 2015}, {"title": "True online TD (\u03bb)", "author": ["van Seijen", "Harm", "Sutton", "Richard S"], "venue": "In Proceedings of the 31st International Conference on Machine Learning (ICML),", "citeRegEx": "Seijen et al\\.,? \\Q2014\\E", "shortCiteRegEx": "Seijen et al\\.", "year": 2014}, {"title": "Variance reduction in Monte-Carlo tree search", "author": ["J. Veness", "M. Lanctot", "M. Bowling"], "venue": "In Proceedings of the 24th Conference on Neural Information Processing Systems,", "citeRegEx": "Veness et al\\.,? \\Q2011\\E", "shortCiteRegEx": "Veness et al\\.", "year": 2011}, {"title": "Learning a value analysis tool for agent evaluation", "author": ["M. White", "M. Bowling"], "venue": "In Proceedings of the 21st International Joint Conference on Artificial Intelligence (IJCAI),", "citeRegEx": "White and Bowling,? \\Q1976\\E", "shortCiteRegEx": "White and Bowling", "year": 1976}, {"title": "Simple statistical gradient-following algorithms for connectionist reinforcement learning", "author": ["Williams", "Ronald J"], "venue": "Machine learning,", "citeRegEx": "Williams and J.,? \\Q1992\\E", "shortCiteRegEx": "Williams and J.", "year": 1992}, {"title": "Optimal unbiased estimators for evaluating agent performance", "author": ["M. Zinkevich", "M. Bowling", "N. Bard", "M. Kan", "D. Billings"], "venue": "In Proceedings of the 21st National Conference on Artificial Intelligence (AAAI),", "citeRegEx": "Zinkevich et al\\.,? \\Q2006\\E", "shortCiteRegEx": "Zinkevich et al\\.", "year": 2006}], "referenceMentions": [{"referenceID": 9, "context": ", 2015), and robot control (Lillicrap et al., 2015), are modeled as Markov decision processes (MDPs) and solved using reinforcement learning (RL) algorithms.", "startOffset": 27, "endOffset": 51}, {"referenceID": 23, "context": "Previous work has addressed variance reduction for on-policy returns (Zinkevich et al., 2006; White & Bowling, 2009; Veness et al., 2011).", "startOffset": 69, "endOffset": 137}, {"referenceID": 20, "context": "Previous work has addressed variance reduction for on-policy returns (Zinkevich et al., 2006; White & Bowling, 2009; Veness et al., 2011).", "startOffset": 69, "endOffset": 137}, {"referenceID": 18, "context": "If \u03c0b is not chosen carefully, IS often has high variance (Thomas et al., 2015).", "startOffset": 58, "endOffset": 79}, {"referenceID": 5, "context": "While IS-based variance reduction has been explored in RL, this prior work has required knowledge of the environment\u2019s transition probabilities and remains onpolicy (Desai & Glynn, 2001; Frank et al., 2008; Ciosek & Whiteson, 2017).", "startOffset": 165, "endOffset": 231}, {"referenceID": 10, "context": ", (Thomas & Brunskill, 2016; Precup et al., 2000)).", "startOffset": 2, "endOffset": 49}, {"referenceID": 15, "context": ", (Sutton et al., 2000)) and we draw connections between one such method and BPG to illustrate how BPG changes the distribution of trajectories.", "startOffset": 2, "endOffset": 23}, {"referenceID": 4, "context": "Our second and third tasks are the continuous control Cartpole Swing Up and Acrobot tasks implemented within RLLAB (Duan et al., 2016).", "startOffset": 115, "endOffset": 134}, {"referenceID": 11, "context": "Policies are partially optimized with trust-region policy optimization (Schulman et al., 2015) applied to a randomly initialized policy.", "startOffset": 71, "endOffset": 94}, {"referenceID": 5, "context": "Existing work on adaptive IS in RL has considered changing the transition probabilities to lower the variance of policy evaluation (Desai & Glynn, 2001; Frank et al., 2008) or lower the variance of policy gradient estimates (Ciosek & Whiteson, 2017).", "startOffset": 131, "endOffset": 172}, {"referenceID": 23, "context": "In addition to the control variate technique used by the Advantage Sum estimator (Zinkevich et al., 2006; White & Bowling, 2009), Veness et al.", "startOffset": 81, "endOffset": 128}, {"referenceID": 13, "context": "When the goal is to minimize MSE it is often permissible to use biased methods such as temporal difference learning (van Seijen & Sutton, 2014), model-based policy evaluation (Kearns & Singh, 2002; Strehl et al., 2009), or variants of weighted importance sampling (Precup et al.", "startOffset": 175, "endOffset": 218}, {"referenceID": 10, "context": ", 2009), or variants of weighted importance sampling (Precup et al., 2000).", "startOffset": 53, "endOffset": 74}, {"referenceID": 18, "context": ", 2006; White & Bowling, 2009), Veness et al. consider using common random numbers and antithetic variates to reduce the variance of roll-outs in Monte Carlo Tree Search (MCTS) (2011). These techniques require a model of the environment (as is typical for MCTS) and do not appear to be applicable to the general RL policy evaluation problem.", "startOffset": 32, "endOffset": 184}], "year": 2017, "abstractText": "We consider the task of evaluating a policy for a Markov decision process (MDP). The standard unbiased technique for evaluating a policy is to deploy the policy and observe its performance. We show that the data collected from deploying a different policy, commonly called the behavior policy, can be used to produce unbiased estimates with lower mean squared error than this standard technique. We derive an analytic expression for the optimal behavior policy\u2014the behavior policy that minimizes the mean squared error of the resulting estimates. Because this expression depends on terms that are unknown in practice, we propose a novel policy evaluation sub-problem, behavior policy search: searching for a behavior policy that reduces mean squared error. We present a behavior policy search algorithm and empirically demonstrate its effectiveness in lowering the mean squared error of policy performance estimates.", "creator": "LaTeX with hyperref package"}}}